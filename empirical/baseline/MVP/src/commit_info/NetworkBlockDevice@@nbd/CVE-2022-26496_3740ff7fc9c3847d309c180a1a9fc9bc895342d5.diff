commit 3740ff7fc9c3847d309c180a1a9fc9bc895342d5
Author: Wouter Verhelst <w@uter.be>
Date:   Thu Mar 3 12:51:38 2022 +0200

    Fix buffer overflow in NBD_OPT_INFO/NBD_OPT_GO handling
    
    When len - sizeof(namelen) > 1024, we have a buffer overflow.
    
    Fix by using the "consume" function, which was written for that purpose.
    
    CVE-2022-26496
    
    Reported-By: Dialluvioso <dialluvioso@protonmail.com>
    Reported-By: 王多 <duo.wang@chaitin.com>
    Signed-Off-By: Wouter Verhelst <w@uter.be>

diff --git a/nbd-server.c b/nbd-server.c
index af14919..f7f9fb5 100644
--- a/nbd-server.c
+++ b/nbd-server.c
@@ -2360,7 +2360,7 @@ static bool handle_info(CLIENT* client, uint32_t opt, GArray* servers, uint32_t
 	namelen = htonl(namelen);
 	if(namelen > (len - 6)) {
 		send_reply(client, opt, NBD_REP_ERR_INVALID, -1, "An OPT_INFO request cannot be smaller than the length of the name + 6");
-		socket_read(client, buf, len - sizeof(namelen));
+		consume(client, len - sizeof(namelen), buf, sizeof(buf));
 	}
 	if(namelen > 0) {
 		name = malloc(namelen + 1);
