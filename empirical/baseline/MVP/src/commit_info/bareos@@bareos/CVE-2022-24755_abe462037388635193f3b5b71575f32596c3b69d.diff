commit abe462037388635193f3b5b71575f32596c3b69d
Author: Andreas Rogge <andreas.rogge@bareos.com>
Date:   Thu Mar 10 10:31:26 2022 +0100

    dir: check account authorization during PAM login
    
    Fixes CVE-2022-24755
    
    Previously, when a user logged in via PAM, Bareos did only check for
    authentication (i.e. the "auth" section in PAM). No authorization checks
    were made (the "account" section in PAM). This patch now adds the proper
    check.
    This will break existing PAM configuration!

diff --git a/core/src/dird/auth_pam.cc b/core/src/dird/auth_pam.cc
index d14839259..d7b6373c9 100644
--- a/core/src/dird/auth_pam.cc
+++ b/core/src/dird/auth_pam.cc
@@ -182,6 +182,13 @@ static int DoPamAuth(struct pam_handle* pamh,
     return err;
   }
 
+  err = pam_acct_mgmt(pamh, 0);
+  if (err != PAM_SUCCESS) {
+    Dmsg1(debuglevel, "PAM authorization failed: %s\n",
+          pam_strerror(pamh, err));
+    return err;
+  }
+
 #if defined(__sun)
   void* data;
 #else
