commit 64ae2f785e0672286901c15045a24cbc533538d3
Author: Gordon Tetlow <gordon@FreeBSD.org>
Date:   Tue Aug 24 10:59:01 2021 -0700

    Fix libfetch out of bounds read.
    
    Approved by:    so
    Security:       SA-21:15.libfetch
    Security:       CVE-2021-36159

diff --git a/lib/libfetch/ftp.c b/lib/libfetch/ftp.c
index 9a546f3fecad..dfde6edce734 100644
--- a/lib/libfetch/ftp.c
+++ b/lib/libfetch/ftp.c
@@ -704,8 +704,11 @@ ftp_transfer(conn_t *conn, const char *oper, const char *file,
 				goto ouch;
 			}
 			l = (e == FTP_PASSIVE_MODE ? 6 : 21);
-			for (i = 0; *p && i < l; i++, p++)
+			for (i = 0; *p && i < l; i++, p++) {
 				addr[i] = strtol(p, &p, 10);
+				if (*p == '\0' && i < l - 1)
+					break;
+			}
 			if (i < l) {
 				e = FTP_PROTOCOL_ERROR;
 				goto ouch;
