commit a64c60ef0983be6db8ab1e4a663e0ce83ff7bf2c
Author: jeanlf <jeanlf@gpac.io>
Date:   Tue Jul 4 17:06:20 2023 +0200

    fixed #2516

diff --git a/src/isomedia/isom_read.c b/src/isomedia/isom_read.c
index 8100f103c..8887b6435 100644
--- a/src/isomedia/isom_read.c
+++ b/src/isomedia/isom_read.c
@@ -2684,6 +2684,7 @@ u32 gf_isom_get_udta_count(GF_ISOFile *movie, u32 trackNumber)
 		if (!trak) return 0;
 		udta = trak->udta;
 	} else {
+		if (!movie->moov) return 0;
 		udta = movie->moov->udta;
 	}
 	if (udta) return gf_list_count(udta->recordList);
@@ -2703,6 +2704,7 @@ GF_Err gf_isom_get_udta_type(GF_ISOFile *movie, u32 trackNumber, u32 udta_idx, u
 		if (!trak) return GF_OK;
 		udta = trak->udta;
 	} else {
+		if (!movie->moov) return GF_BAD_PARAM;
 		udta = movie->moov->udta;
 	}
 	if (!udta) return GF_BAD_PARAM;
@@ -2732,6 +2734,7 @@ u32 gf_isom_get_user_data_count(GF_ISOFile *movie, u32 trackNumber, u32 UserData
 		if (!trak) return 0;
 		udta = trak->udta;
 	} else {
+		if (!movie->moov) return 0;
 		udta = movie->moov->udta;
 	}
 	if (!udta) return 0;
@@ -2764,6 +2767,7 @@ GF_Err gf_isom_get_user_data(GF_ISOFile *movie, u32 trackNumber, u32 UserDataTyp
 		if (!trak) return GF_BAD_PARAM;
 		udta = trak->udta;
 	} else {
+		if (!movie->moov) return GF_BAD_PARAM;
 		udta = movie->moov->udta;
 	}
 	if (!udta) return GF_BAD_PARAM;
diff --git a/src/isomedia/isom_write.c b/src/isomedia/isom_write.c
index 5db30f784..177f13057 100644
--- a/src/isomedia/isom_write.c
+++ b/src/isomedia/isom_write.c
@@ -3611,6 +3611,7 @@ GF_Err gf_isom_remove_user_data_item(GF_ISOFile *movie, u32 trackNumber, u32 Use
 		if (!trak) return GF_BAD_PARAM;
 		udta = trak->udta;
 	} else {
+		if (!movie->moov) return GF_BAD_PARAM;
 		udta = movie->moov->udta;
 	}
 	if (!udta) return GF_BAD_PARAM;
@@ -3662,6 +3663,7 @@ GF_Err gf_isom_remove_user_data(GF_ISOFile *movie, u32 trackNumber, u32 UserData
 		if (!trak) return GF_EOS;
 		udta = trak->udta;
 	} else {
+		if (!movie->moov) return GF_BAD_PARAM;
 		udta = movie->moov->udta;
 	}
 	//do not return any error if no udta
@@ -3703,6 +3705,7 @@ GF_Err gf_isom_add_user_data(GF_ISOFile *movie, u32 trackNumber, u32 UserDataTyp
 		if (!trak->udta) trak_on_child_box((GF_Box*)trak, gf_isom_box_new_parent(&trak->child_boxes, GF_ISOM_BOX_TYPE_UDTA), GF_FALSE);
 		udta = trak->udta;
 	} else {
+		if (!movie->moov) return GF_BAD_PARAM;
 		if (!movie->moov->udta) moov_on_child_box((GF_Box*)movie->moov, gf_isom_box_new_parent(&movie->moov->child_boxes, GF_ISOM_BOX_TYPE_UDTA), GF_FALSE);
 		udta = movie->moov->udta;
 	}
