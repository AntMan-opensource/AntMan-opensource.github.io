commit 13d38a07ce9143e044aa737cfd7bb759d0e9b400
Author: Alan Liu <liualan@google.com>
Date:   Thu Apr 28 11:37:31 2022 -0700

    Fix tf.raw_ops.UnsortedSegmentJoin vulnerability with invalid num_segments.
    
    Check that input is actually a scalar before treating it as such.
    
    PiperOrigin-RevId: 445206880

diff --git a/tensorflow/core/kernels/unsorted_segment_join_op.cc b/tensorflow/core/kernels/unsorted_segment_join_op.cc
index c8445ca4c4c..9529c6e8b74 100644
--- a/tensorflow/core/kernels/unsorted_segment_join_op.cc
+++ b/tensorflow/core/kernels/unsorted_segment_join_op.cc
@@ -92,6 +92,9 @@ class UnsortedSegmentJoinOp : public OpKernel {
     const Tensor& num_segments_tensor = context->input(2);
     OP_REQUIRES(context, num_segments_tensor.NumElements() != 0,
                 errors::InvalidArgument("Number of segments cannot be empty."));
+    OP_REQUIRES(context,
+                TensorShapeUtils::IsScalar(num_segments_tensor.shape()),
+                errors::InvalidArgument("Number of segments must be a scalar"));
     auto num_segments = num_segments_tensor.scalar<NUM_SEGMENTS_TYPE>()();
 
     OP_REQUIRES(
