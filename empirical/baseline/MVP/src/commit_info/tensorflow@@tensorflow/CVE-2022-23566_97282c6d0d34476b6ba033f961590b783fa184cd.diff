commit 97282c6d0d34476b6ba033f961590b783fa184cd
Author: Mihai Maruseac <mihaimaruseac@google.com>
Date:   Mon Nov 8 05:48:40 2021 -0800

    Prevent a crash due to heap OOB write in grappler.
    
    PiperOrigin-RevId: 408318417
    Change-Id: If095feb8c001e3a8ac4a85b7387b81e8309df47d

diff --git a/tensorflow/core/grappler/costs/graph_properties.cc b/tensorflow/core/grappler/costs/graph_properties.cc
index 51a2cd080c5..3cc12173ba1 100644
--- a/tensorflow/core/grappler/costs/graph_properties.cc
+++ b/tensorflow/core/grappler/costs/graph_properties.cc
@@ -1134,7 +1134,12 @@ class SymbolicShapeRefiner {
         GetUnknownOutputShape(node, output_port);
     InferenceContext* ctx = GetContext(node);
     if (ctx == nullptr) {
-      return errors::InvalidArgument("Missing context");
+      return errors::InvalidArgument("SetUnknownShape: Missing context");
+    }
+    if (output_port < 0 || output_port >= ctx->num_outputs()) {
+      return errors::InvalidArgument(
+          "SetUnknownShape: output_port must be in [0, ", ctx->num_outputs(),
+          ") but was ", output_port);
     }
     ctx->set_output(output_port, shape);
     return Status::OK();
