commit 00f1eddee429ff51390b20caadd2eb6afe51e1aa
Author: JacobBarthelmeh <jacob@wolfssl.com>
Date:   Mon May 15 15:49:44 2023 -0700

    add tls extension sanity check

diff --git a/src/tls.c b/src/tls.c
index bced9f9b1..9bbabfb14 100644
--- a/src/tls.c
+++ b/src/tls.c
@@ -8475,6 +8475,9 @@ int TLSX_KeyShare_Parse(WOLFSSL* ssl, const byte* input, word16 length,
         if (!WOLFSSL_NAMED_GROUP_IS_PQC(group))
 #endif
             ret = TLSX_KeyShare_Use(ssl, group, 0, NULL, NULL, &ssl->extensions);
+
+        if (ret == 0)
+            ssl->session->namedGroup = ssl->namedGroup = group;
     }
     else {
         /* Not a message type that is allowed to have this extension. */
diff --git a/src/tls13.c b/src/tls13.c
index e5360790b..0f1bbc1aa 100644
--- a/src/tls13.c
+++ b/src/tls13.c
@@ -5236,8 +5236,18 @@ int DoTls13ServerHello(WOLFSSL* ssl, const byte* input, word32* inOutIdx,
         }
 #endif
 
+        /* sanity check on PSK / KSE */
+        if (
+    #if defined(HAVE_SESSION_TICKET) || !defined(NO_PSK)
+            ssl->options.pskNegotiated == 0 &&
+    #endif
+            ssl->session->namedGroup == 0) {
+            return EXT_MISSING;
+        }
+
         ssl->keys.encryptionOn = 1;
         ssl->options.serverState = SERVER_HELLO_COMPLETE;
+
     }
     else {
         ssl->options.tls1_3 = 1;
