commit 8d3649841597bedfb6986c30431ebad0eb215265
Author: Facebook Community Bot <facebook-github-bot@users.noreply.github.com>
Date:   Fri Jan 20 13:47:56 2023 -0500

    Check HelloRetryRequest cipher consistency earlier.
    
    CVE-2023-23759
    
    Co-authored-by: Facebook Community Bot <6422482+facebook-github-bot@users.noreply.github.com>
    
    Differential Revision: D42508182

diff --git a/fizz/server/ServerProtocol.cpp b/fizz/server/ServerProtocol.cpp
index 486c266e..52f12aaf 100644
--- a/fizz/server/ServerProtocol.cpp
+++ b/fizz/server/ServerProtocol.cpp
@@ -1214,6 +1214,12 @@ EventHandler<ServerTypes, StateEnum::ExpectingClientHello, Event::ClientHello>::
 
   auto cipher = negotiateCipher(chlo, state.context()->getSupportedCiphers());
 
+  if (state.cipher().has_value() && cipher != *state.cipher()) {
+    throw FizzException(
+        "cipher mismatch with previous negotiation",
+        AlertDescription::illegal_parameter);
+  }
+
   verifyCookieState(cookieState, *version, cipher);
 
   auto resStateResult = getResumptionState(
@@ -1284,12 +1290,6 @@ EventHandler<ServerTypes, StateEnum::ExpectingClientHello, Event::ClientHello>::
             std::move(state.handshakeContext()),
             version);
 
-        if (state.cipher().has_value() && cipher != *state.cipher()) {
-          throw FizzException(
-              "cipher mismatch with previous negotiation",
-              AlertDescription::illegal_parameter);
-        }
-
         auto alpn = negotiateAlpn(chlo, folly::none, *state.context());
 
         auto clockSkew = getClockSkew(
