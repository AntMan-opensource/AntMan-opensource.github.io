commit 9a29d87538842a29b430c6956a4f914896643691
Author: Kohei Yamaguchi <fix7211@gmail.com>
Date:   Mon Feb 27 16:36:16 2023 +0100

    [mlir][sparse] Add checking parent op of SortOp
    
    Fix crash with segmentation fault caused by setting a parent operator
    that is not func::FuncOp with sparse_tensor SortOp.
    
    fixes https://github.com/llvm/llvm-project/issues/59988
    
    Reviewed By: aartbik, wrengr
    
    Differential Revision: https://reviews.llvm.org/D143874

diff --git a/mlir/lib/Dialect/SparseTensor/Transforms/SparseBufferRewriting.cpp b/mlir/lib/Dialect/SparseTensor/Transforms/SparseBufferRewriting.cpp
index 3e6157001266..107d9ef7569b 100644
--- a/mlir/lib/Dialect/SparseTensor/Transforms/SparseBufferRewriting.cpp
+++ b/mlir/lib/Dialect/SparseTensor/Transforms/SparseBufferRewriting.cpp
@@ -1160,6 +1160,9 @@ LogicalResult matchAndRewriteSortOp(OpTy op, ValueRange xys, uint64_t nx,
   }
 
   auto insertPoint = op->template getParentOfType<func::FuncOp>();
+  if (!insertPoint)
+    return failure();
+
   SmallString<32> funcName;
   FuncGeneratorType funcGenerator;
   uint32_t nTrailingP = 0;
