












 
 




















 
 
 
 
 






 
 
 
 
 
 
 
 
 
 
 
 
 
 
 










 
 
 

 
 
 
 
 
















UINT  _ux_device_class_rndis_control_request(UX_SLAVE_CLASS_COMMAND *command)
{

UX_SLAVE_TRANSFER       *transfer_request;
UX_SLAVE_TRANSFER       *transfer_request_in;
UX_SLAVE_DEVICE         *device;
ULONG                   request;
ULONG                   request_length;
ULONG                   rndis_command;
UX_SLAVE_CLASS          *class_ptr;
UX_SLAVE_CLASS_RNDIS    *rndis;

    
    device =  &_ux_system_slave -> ux_system_slave_device;

    
    transfer_request =  &device -> ux_slave_device_control_endpoint.ux_slave_endpoint_transfer_request;

    
    request =  *(transfer_request -> ux_slave_transfer_request_setup + UX_SETUP_REQUEST);
    request_length =   _ux_utility_short_get(transfer_request -> ux_slave_transfer_request_setup + UX_SETUP_LENGTH);

    
    class_ptr =  command -> ux_slave_class_command_class_ptr;
    
    
    rndis =  (UX_SLAVE_CLASS_RNDIS *) class_ptr -> ux_slave_class_instance;
    
    
    switch (request)
    {

            
        case UX_DEVICE_CLASS_RNDIS_SEND_ENCAPSULATED_COMMAND    :
        
            
            
            rndis_command = _ux_utility_long_get(transfer_request -> ux_slave_transfer_request_data_pointer);

            switch (rndis_command)
            {

                case    UX_DEVICE_CLASS_RNDIS_MSG_INITIALIZE            :
                
                    _ux_device_class_rndis_msg_initialize(rndis, transfer_request);
                    break;
                    
                case    UX_DEVICE_CLASS_RNDIS_MSG_HALT                  :
                    break;
                    
                
                case    UX_DEVICE_CLASS_RNDIS_MSG_QUERY                 :
                    _ux_device_class_rndis_msg_query(rndis, transfer_request);
                    break;
                    
                
                case    UX_DEVICE_CLASS_RNDIS_MSG_SET                   :
                    _ux_device_class_rndis_msg_set(rndis, transfer_request);
                    break;
                    
                
                case    UX_DEVICE_CLASS_RNDIS_MSG_RESET                 :
                    _ux_device_class_rndis_msg_reset(rndis, transfer_request);
                    break;
                    
                
                case    UX_DEVICE_CLASS_RNDIS_MSG_INDICATE_STATUS    :
                    break;
                    
                
                case    UX_DEVICE_CLASS_RNDIS_MSG_KEEP_ALIVE            :
                    _ux_device_class_rndis_msg_keep_alive(rndis, transfer_request);
                    break;
                    
                default                                                :

                    
                    _ux_device_stack_endpoint_stall(&device -> ux_slave_device_control_endpoint);
                    break;

            }
            
            
            transfer_request_in =  &rndis -> ux_slave_class_rndis_interrupt_endpoint -> ux_slave_endpoint_transfer_request;

            
            _ux_utility_memory_set(transfer_request_in -> ux_slave_transfer_request_data_pointer, 0, UX_DEVICE_CLASS_RNDIS_INTERRUPT_RESPONSE_LENGTH); 

            
            transfer_request_in -> ux_slave_transfer_request_data_pointer[0] = UX_DEVICE_CLASS_RNDIS_INTERRUPT_RESPONSE_AVAILABLE_FLAG;

            
            _ux_device_event_flags_set(&rndis -> ux_slave_class_rndis_event_flags_group, UX_DEVICE_CLASS_RNDIS_NEW_INTERRUPT_EVENT, UX_OR);                
            
            break;
            
        case UX_DEVICE_CLASS_RNDIS_GET_ENCAPSULATED_RESPONSE    :
        
           
            
            _ux_utility_memory_copy(transfer_request -> ux_slave_transfer_request_data_pointer, rndis -> ux_slave_class_rndis_response, rndis -> ux_slave_class_rndis_response_length);

            
            transfer_request -> ux_slave_transfer_request_phase =  UX_TRANSFER_PHASE_DATA_OUT;

            
            _ux_device_stack_transfer_request(transfer_request, rndis -> ux_slave_class_rndis_response_length, request_length);
        
            break ;
            
        default:

            
            return(UX_ERROR);
    }

    
    return(UX_SUCCESS);
}

