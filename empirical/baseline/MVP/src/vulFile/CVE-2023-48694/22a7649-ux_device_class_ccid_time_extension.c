



































































UINT _ux_device_class_ccid_time_extension(UX_DEVICE_CLASS_CCID *ccid, ULONG slot, ULONG wt)
{

UX_SLAVE_ENDPOINT                                   *endpoint;
UX_SLAVE_TRANSFER                                   *transfer;
UX_DEVICE_CLASS_CCID_SLOT                           *ccid_slot;
UX_DEVICE_CLASS_CCID_RUNNER                         *runner;
UCHAR                                               *rsp, *runner_rsp;
UINT                                                status;

    
    ccid_slot  = ccid -> ux_device_class_ccid_slots;
    ccid_slot += slot;

    
    if ((signed char)ccid_slot -> ux_device_class_ccid_slot_runner < 0)
        return(UX_INVALID_STATE);

    
    runner = ccid -> ux_device_class_ccid_runners;
    runner += ccid_slot -> ux_device_class_ccid_slot_runner;

    
    endpoint = ccid -> ux_device_class_ccid_endpoint_in;

    
    transfer = &endpoint -> ux_slave_endpoint_transfer_request;

    
    _ux_device_mutex_on(&ccid -> ux_device_class_ccid_response_mutex);

    
    rsp = transfer -> ux_slave_transfer_request_data_pointer;
    runner_rsp = runner -> ux_device_class_ccid_runner_response;

    
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_MESSAGE_TYPE]       = runner_rsp[UX_DEVICE_CLASS_CCID_OFFSET_MESSAGE_TYPE];
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_LENGTH]             = 0;
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_LENGTH+1]           = 0;
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_LENGTH+2]           = 0;
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_LENGTH+3]           = 0;
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_SLOT]               = runner_rsp[UX_DEVICE_CLASS_CCID_OFFSET_SLOT];
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_SEQ]                = runner_rsp[UX_DEVICE_CLASS_CCID_OFFSET_SEQ];
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_STATUS]             = runner_rsp[UX_DEVICE_CLASS_CCID_OFFSET_STATUS] | UX_DEVICE_CLASS_CCID_SLOT_STATUS_TIME_EXTENSION;
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_ERROR]              = (UCHAR)wt;
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_CHAIN_PARAMETER]    = 0;
    rsp[UX_DEVICE_CLASS_CCID_OFFSET_CHAIN_PARAMETER+1]  = 0;

    
    status = _ux_device_stack_transfer_request(transfer, UX_DEVICE_CLASS_CCID_MESSAGE_HEADER_LENGTH, UX_DEVICE_CLASS_CCID_MESSAGE_HEADER_LENGTH);


    
    _ux_device_mutex_off(&ccid -> ux_device_class_ccid_response_mutex);

    
    return(status);
}
