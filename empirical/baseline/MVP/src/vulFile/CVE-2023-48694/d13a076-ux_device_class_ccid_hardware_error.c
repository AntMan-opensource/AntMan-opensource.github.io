






































































UINT _ux_device_class_ccid_hardware_error(UX_DEVICE_CLASS_CCID *ccid, ULONG slot, ULONG error)
{

UX_DEVICE_CLASS_CCID_SLOT                           *ccid_slot;
UX_DEVICE_CLASS_CCID_RUNNER                         *runner;
UX_DEVICE_CLASS_CCID_RDR_TO_PC_SLOT_STATUS_HEADER   *rsp;

    
    if (slot >= ccid -> ux_device_class_ccid_parameter.ux_device_class_ccid_max_n_slots)
        return(UX_INVALID_PARAMETER);

    
    ccid_slot  = ccid -> ux_device_class_ccid_slots;
    ccid_slot += slot;

    
    _ux_device_class_ccid_lock(ccid);

    
    if (!(ccid_slot -> ux_device_class_ccid_slot_flags & UX_DEVICE_CLASS_CCID_FLAG_HW_ERROR))
    {

        
        ccid_slot -> ux_device_class_ccid_slot_flags |= UX_DEVICE_CLASS_CCID_FLAG_HW_ERROR;
        ccid_slot -> ux_device_class_ccid_slot_hw_error = (UCHAR)error;
        ccid_slot -> ux_device_class_ccid_slot_hw_error_seq = 0;

        
        ccid_slot -> ux_device_class_ccid_slot_icc_status = UX_DEVICE_CLASS_CCID_ICC_INACTIVE;

        
        if ((signed char)ccid_slot -> ux_device_class_ccid_slot_runner >= 0)
        {

            
            runner = ccid -> ux_device_class_ccid_runners;
            runner += ccid_slot -> ux_device_class_ccid_slot_runner;
            rsp = (UX_DEVICE_CLASS_CCID_RDR_TO_PC_SLOT_STATUS_HEADER *)
                                runner -> ux_device_class_ccid_runner_response;

            
            rsp -> bStatus = UX_DEVICE_CLASS_CCID_SLOT_STATUS(1, 1);
            rsp -> bError = UX_DEVICE_CLASS_CCID_HW_ERROR;
        }
    }

    
    if (ccid -> ux_device_class_ccid_endpoint_notify)
    {
        ccid_slot -> ux_device_class_ccid_slot_flags |= UX_DEVICE_CLASS_CCID_FLAG_NOTIFY_CHANGE;

        
        _ux_device_class_ccid_unlock(ccid);

        
        _ux_device_semaphore_put(&ccid -> ux_device_class_ccid_notify_semaphore);


        if (ccid -> ux_device_class_ccid_notify_state == UX_DEVICE_CLASS_CCID_NOTIFY_IDLE)
            ccid -> ux_device_class_ccid_notify_state = UX_DEVICE_CLASS_CCID_NOTIFY_LOCK;

        return(UX_SUCCESS);
    }

    
    _ux_device_class_ccid_unlock(ccid);

    
    return(UX_SUCCESS);
}
