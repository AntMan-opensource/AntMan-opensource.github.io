













 
 




















 
 
 
 
 






 
 
 
 
 
 


 
 
 
 
 
 
 
 
 
 

 
 
 

 
 
 
 
 














UINT  _ux_device_class_storage_report_key(UX_SLAVE_CLASS_STORAGE *storage,  ULONG               lun, UX_SLAVE_ENDPOINT   *endpoint_in, UX_SLAVE_ENDPOINT   *endpoint_out, UCHAR               *cbwcb)



{

UINT                    status = UX_SUCCESS;
UX_SLAVE_TRANSFER       *transfer_request;
ULONG                   allocation_length;
ULONG                   key_format;


    UX_PARAMETER_NOT_USED(lun);
    UX_PARAMETER_NOT_USED(endpoint_out);

    
    UX_TRACE_IN_LINE_INSERT(UX_TRACE_DEVICE_CLASS_STORAGE_OTHER, storage, lun, 0, 0, UX_TRACE_DEVICE_CLASS_EVENTS, 0, 0)

    
    transfer_request =  &endpoint_in -> ux_slave_endpoint_transfer_request;

    
    key_format =  (ULONG) *(cbwcb + UX_SLAVE_CLASS_STORAGE_REPORT_KEY_FORMAT);
    
    
    allocation_length =  _ux_utility_short_get_big_endian(cbwcb + UX_SLAVE_CLASS_STORAGE_REPORT_KEY_ALLOCATION_LENGTH);

    
    _ux_utility_memory_set(transfer_request -> ux_slave_transfer_request_data_pointer, 0, UX_SLAVE_CLASS_STORAGE_REPORT_KEY_ANSWER_LENGTH); 
    
    
    switch (key_format)
    {

        case UX_SLAVE_CLASS_STORAGE_REPORT_KEY_FORMAT_RPC :


            
            _ux_utility_short_put_big_endian(transfer_request -> ux_slave_transfer_request_data_pointer,  UX_SLAVE_CLASS_STORAGE_REPORT_KEY_ANSWER_PAYLOAD);

            
            *(transfer_request -> ux_slave_transfer_request_data_pointer + UX_SLAVE_CLASS_STORAGE_REPORT_KEY_ANSWER_RESET_FIELD) =  0x25;

            
            *(transfer_request -> ux_slave_transfer_request_data_pointer + UX_SLAVE_CLASS_STORAGE_REPORT_KEY_ANSWER_REGION_MASK) =  0xFF;

            
            *(transfer_request -> ux_slave_transfer_request_data_pointer + UX_SLAVE_CLASS_STORAGE_REPORT_KEY_ANSWER_RPC_SCHEME)  =  0x00;

            
            if (allocation_length >  UX_SLAVE_CLASS_STORAGE_REPORT_KEY_ANSWER_LENGTH)
            
                
                allocation_length = UX_SLAVE_CLASS_STORAGE_REPORT_KEY_ANSWER_LENGTH;                

            break;
          
        default :
            allocation_length = 0;
            break;
                
    }



    
    storage -> ux_device_class_storage_state = UX_DEVICE_CLASS_STORAGE_STATE_TRANS_START;
    storage -> ux_device_class_storage_cmd_state = UX_DEVICE_CLASS_STORAGE_CMD_READ;

    storage -> ux_device_class_storage_transfer = transfer_request;
    storage -> ux_device_class_storage_device_length = allocation_length;
    storage -> ux_device_class_storage_data_length = allocation_length;
    storage -> ux_device_class_storage_data_count = 0;
    UX_SLAVE_TRANSFER_STATE_RESET(storage -> ux_device_class_storage_transfer);



    
    status = _ux_device_stack_transfer_request(transfer_request, allocation_length, allocation_length);  


    
    storage -> ux_slave_class_storage_csw_status = UX_SLAVE_CLASS_STORAGE_CSW_PASSED;

    
    return(status);
}
    
