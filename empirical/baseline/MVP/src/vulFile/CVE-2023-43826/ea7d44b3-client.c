


























static void* guac_vnc_sync_pending_user_audio(guac_user* user, void* data) {

    
    guac_pa_stream* audio = (guac_pa_stream*) data;
    guac_pa_stream_add_user(audio, user);

    return NULL;

}



static int guac_vnc_join_pending_handler(guac_client* client) {

    guac_vnc_client* vnc_client = (guac_vnc_client*) client->data;
    guac_socket* broadcast_socket = client->pending_socket;


    
    if (vnc_client->audio)
        guac_client_foreach_pending_user( client, guac_vnc_sync_pending_user_audio, vnc_client->audio);


    
    if (vnc_client->display != NULL) {
        guac_common_display_dup(vnc_client->display, client, broadcast_socket);
        guac_socket_flush(broadcast_socket);
    }

    return 0;

}

int guac_client_init(guac_client* client) {

    
    client->args = GUAC_VNC_CLIENT_ARGS;

    
    guac_vnc_client* vnc_client = calloc(1, sizeof(guac_vnc_client));
    client->data = vnc_client;


    
    pthread_mutex_init(&vnc_client->tls_lock, NULL);


    
    vnc_client->clipboard = guac_common_clipboard_alloc();

    
    client->join_handler = guac_vnc_user_join_handler;
    client->join_pending_handler = guac_vnc_join_pending_handler;
    client->leave_handler = guac_vnc_user_leave_handler;
    client->free_handler = guac_vnc_client_free_handler;

    return 0;
}

int guac_vnc_client_free_handler(guac_client* client) {

    guac_vnc_client* vnc_client = (guac_vnc_client*) client->data;
    guac_vnc_settings* settings = vnc_client->settings;

    
    rfbClient* rfb_client = vnc_client->rfb_client;
    if (rfb_client != NULL) {

        
        pthread_join(vnc_client->client_thread, NULL);

        

        if (rfb_client->frameBuffer != NULL) {
            free(rfb_client->frameBuffer);
            rfb_client->frameBuffer = NULL;
        }

        if (rfb_client->raw_buffer != NULL) {
            free(rfb_client->raw_buffer);
            rfb_client->raw_buffer = NULL;
        }

        if (rfb_client->rcSource != NULL) {
            free(rfb_client->rcSource);
            rfb_client->rcSource = NULL;
        }

        

        while (rfb_client->clientData != NULL) {
            rfbClientData* next = rfb_client->clientData->next;
            free(rfb_client->clientData);
            rfb_client->clientData = next;
        }

        rfbClientCleanup(rfb_client);

    }


    
    if (vnc_client->sftp_filesystem)
        guac_common_ssh_destroy_sftp_filesystem(vnc_client->sftp_filesystem);

    
    if (vnc_client->sftp_session)
        guac_common_ssh_destroy_session(vnc_client->sftp_session);

    
    if (vnc_client->sftp_user)
        guac_common_ssh_destroy_user(vnc_client->sftp_user);

    guac_common_ssh_uninit();


    
    if (vnc_client->recording != NULL)
        guac_recording_free(vnc_client->recording);

    
    if (vnc_client->clipboard != NULL)
        guac_common_clipboard_free(vnc_client->clipboard);

    
    if (vnc_client->display != NULL)
        guac_common_display_free(vnc_client->display);


    
    if (vnc_client->audio)
        guac_pa_stream_free(vnc_client->audio);


    
    if (settings != NULL)
        guac_vnc_settings_free(settings);


    
    pthread_mutex_destroy(&(vnc_client->tls_lock));


    
    free(client->data);

    return 0;
}

