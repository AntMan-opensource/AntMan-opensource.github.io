



















static void fill_random(char *buf, int len)
{
	int i;
	srand(time(NULL));
	for (i = 0; i < len; i++) {
		buf[i] = (char)rand();
	}
}

int main(int argc, char *argv[])
{
	int i, fd;
	char buf1[BSZ], buf2[BSZ] = {};
	char *penv[] = {"TESTDIR";

	(void) fprintf(stdout, "Verify O_TMPFILE is working properly.\n");

	
	for (i = 0; i < sizeof (penv) / sizeof (char *); i++) {
		if ((penv[i] = getenv(penv[i])) == NULL) {
			(void) fprintf(stderr, "getenv(penv[%d])\n", i);
			exit(1);
		}
	}

	fill_random(buf1, BSZ);

	fd = open(penv[0], O_RDWR|O_TMPFILE, 0666);
	if (fd < 0) {
		perror("open");
		exit(2);
	}

	if (write(fd, buf1, BSZ) < 0) {
		perror("write");
		close(fd);
		exit(3);
	}

	if (pread(fd, buf2, BSZ, 0) < 0) {
		perror("pread");
		close(fd);
		exit(4);
	}

	if (memcmp(buf1, buf2, BSZ) != 0) {
		fprintf(stderr, "data corrupted\n");
		close(fd);
		exit(5);
	}

	memset(buf2, 0, BSZ);

	if (fsetxattr(fd, "user.test", buf1, BSZ, 0) < 0) {
		perror("fsetxattr");
		close(fd);
		exit(6);
	}

	if (fgetxattr(fd, "user.test", buf2, BSZ) < 0) {
		perror("fgetxattr");
		close(fd);
		exit(7);
	}

	if (memcmp(buf1, buf2, BSZ) != 0) {
		fprintf(stderr, "xattr corrupted\n");
		close(fd);
		exit(8);
	}

	close(fd);

	return (0);
}
