







struct malo;
struct lsquic_conn;
struct lsquic_engine_public;
struct lsquic_mm;
struct lsquic_stream;
struct network_path;
struct parse_funcs;
struct bwp_state;


struct frame_rec {
    union {
        struct lsquic_stream   *stream;
        uintptr_t               data;
    }                        fe_u;

    unsigned short           fe_off, fe_len;
    enum quic_frame_type     fe_frame_type;
};



struct frame_rec_arr {
    TAILQ_ENTRY(frame_rec_arr)     next_stream_rec_arr;
    struct frame_rec               frecs[ ( 64 - sizeof(TAILQ_ENTRY(frame_rec))

      ) / sizeof(struct frame_rec)
    ];
};

TAILQ_HEAD(frame_rec_arr_tailq, frame_rec_arr);


typedef struct lsquic_packet_out {
    
    TAILQ_ENTRY(lsquic_packet_out)
                       po_next;
    lsquic_time_t      po_sent;       
    lsquic_packno_t    po_packno;
    lsquic_packno_t    po_ack2ed;       
    struct lsquic_packet_out *po_loss_chain;

    enum quic_ft_bit   po_frame_types;  
    enum packet_out_flags {
            
        PO_MINI     = (1 << 0),          PO_HELLO    = (1 << 1), PO_SENT     = (1 << 2), PO_ENCRYPTED= (1 << 3), PO_FREC_ARR = (1 << 4),  PO_BITS_0   = (1 << 5), PO_BITS_1   = (1 << 6), PO_NONCE    = (1 << 7), PO_VERSION  = (1 << 8), PO_CONN_ID  = (1 << 9), PO_REPACKNO = (1 <<10), PO_NOENCRYPT= (1 <<11), PO_VERNEG   = (1 <<12), PO_STREAM_END = (1 <<13), PO_SCHED    = (1 <<14), PO_SENT_SZ  = (1 <<15), PO_LONGHEAD = (1 <<16),  PO_IPv6     = (1 <<20), PO_MTU_PROBE= (1 <<21),  PO_PNS_HSK  = (1 <<22), PO_PNS_APP  = (1 <<23), PO_RETRY    = (1 <<24), PO_RETX     = (1 <<25), PO_POISON   = (1 <<26), PO_LOSS_REC = (1 <<27),  PO_UNACKED  = (1 <<28), PO_LOST     = (1 <<29),  PO_SPIN_BIT = (1 <<30), }                  po_flags;

































    unsigned short     po_data_sz;      
    unsigned short     po_enc_data_sz;  
    unsigned short     po_sent_sz;      
    
    unsigned short     po_regen_sz;     
    unsigned short     po_n_alloc;      
    unsigned short     po_token_len;
    enum header_type   po_header_type:8;
    unsigned char      po_dcid_len;     
    enum {
        POL_GQUIC    = 1 << 0,           POL_ELBIT_0  = 1 << 1, POL_ELBIT_1  = 1 << 2,  POL_KEY_PHASE= 1 << 3,  POL_ECNBIT_0 = 1 << 4, POL_ECNBIT_1 = 1 << 5, POL_LOG_QL_BITS = 1 << 6, POL_SQUARE_BIT = 1 << 7, POL_LOSS_BIT = 1 << 8,  POL_HEADER_PROT = 1 << 9,  POL_LIMITED     = 1 << 10, POL_FACKED   = 1 << 11, }                  po_lflags:16;
















    unsigned char     *po_data;

    
    union {
        struct frame_rec               one;
        struct frame_rec_arr_tailq     arr;
    }                  po_frecs;

    
    unsigned char     *po_enc_data;

    lsquic_ver_tag_t   po_ver_tag;      
    unsigned char     *po_nonce;        
    const struct network_path *po_path;

    struct bwp_state  *po_bwp_state;
} lsquic_packet_out_t;















































































struct packet_out_frec_iter {
    lsquic_packet_out_t         *packet_out;
    struct frame_rec_arr        *cur_frec_arr;
    unsigned                     frec_idx;
    int                          impl_idx;
};


struct frame_rec * lsquic_pofi_first (struct packet_out_frec_iter *pofi, lsquic_packet_out_t *);

struct frame_rec * lsquic_pofi_next (struct packet_out_frec_iter *pofi);

lsquic_packet_out_t * lsquic_packet_out_new (struct lsquic_mm *, struct malo *, int use_cid, const struct lsquic_conn *, enum packno_bits, const lsquic_ver_tag_t *, const unsigned char *nonce, const struct network_path *, enum header_type);




void lsquic_packet_out_destroy (lsquic_packet_out_t *, struct lsquic_engine_public *, void *peer_ctx);


int lsquic_packet_out_add_frame (struct lsquic_packet_out *, struct lsquic_mm *, uintptr_t data, enum quic_frame_type, unsigned short off, unsigned short len);



int lsquic_packet_out_add_stream (lsquic_packet_out_t *packet_out, struct lsquic_mm *mm, struct lsquic_stream *new_stream, enum quic_frame_type, unsigned short off, unsigned short len);





unsigned lsquic_packet_out_elide_reset_stream_frames (lsquic_packet_out_t *, lsquic_stream_id_t);


void lsquic_packet_out_chop_regen (lsquic_packet_out_t *);

void lsquic_packet_out_ack_streams (struct lsquic_packet_out *);

void lsquic_packet_out_zero_pad (struct lsquic_packet_out *);

size_t lsquic_packet_out_mem_used (const struct lsquic_packet_out *);

int lsquic_packet_out_turn_on_fin (struct lsquic_packet_out *, const struct parse_funcs *, const struct lsquic_stream *);


int lsquic_packet_out_equal_dcids (const struct lsquic_packet_out *, const struct lsquic_packet_out *);


void lsquic_packet_out_pad_over (struct lsquic_packet_out *packet_out, enum quic_ft_bit frame_types);



