






















































static void adaptive_cc_init (void *cong_ctl, const struct lsquic_conn_public *conn_pub, enum quic_ft_bit retx_frames)

{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH(cci_init, conn_pub, retx_frames);
    LSQ_DEBUG("initialized");
}


static void adaptive_cc_reinit (void *cong_ctl)
{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH0(cci_reinit);
}


static void adaptive_cc_ack (void *cong_ctl, struct lsquic_packet_out *packet_out, unsigned packet_sz, lsquic_time_t now, int app_limited)

{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH(cci_ack, packet_out, packet_sz, now, app_limited);
}


static void adaptive_cc_loss (void *cong_ctl)
{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH0(cci_loss);
}


static void adaptive_cc_begin_ack (void *cong_ctl, lsquic_time_t ack_time, uint64_t in_flight)

{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH_MAYBE(cci_begin_ack, ack_time, in_flight);
}


static void adaptive_cc_end_ack (void *cong_ctl, uint64_t in_flight)
{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH_MAYBE(cci_end_ack, in_flight);
}


static void adaptive_cc_sent (void *cong_ctl, struct lsquic_packet_out *packet_out, uint64_t in_flight, int app_limited)

{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH_MAYBE(cci_sent, packet_out, in_flight, app_limited);
}


static void adaptive_cc_lost (void *cong_ctl, struct lsquic_packet_out *packet_out, unsigned packet_sz)

{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH_MAYBE(cci_lost, packet_out, packet_sz);
}


static void adaptive_cc_timeout (void *cong_ctl)
{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH0(cci_timeout);
}


static void adaptive_cc_was_quiet (void *cong_ctl, lsquic_time_t now, uint64_t in_flight)
{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH(cci_was_quiet, now, in_flight);
}


static uint64_t adaptive_cc_get_cwnd (void *cong_ctl)
{
    struct adaptive_cc *const acc = cong_ctl;
    uint64_t rv[2];

    rv[0] = lsquic_cong_cubic_if.cci_get_cwnd(&acc->acc_cubic);
    rv[1] = lsquic_cong_bbr_if.cci_get_cwnd(&acc->acc_bbr);

    if (acc->acc_flags & ACC_CUBIC)
        return rv[0];
    else return rv[1];
}


static uint64_t adaptive_cc_pacing_rate (void *cong_ctl, int in_recovery)
{
    struct adaptive_cc *const acc = cong_ctl;
    uint64_t rv[2];

    rv[0] = lsquic_cong_cubic_if.cci_pacing_rate(&acc->acc_cubic, in_recovery);
    rv[1] = lsquic_cong_bbr_if.cci_pacing_rate(&acc->acc_bbr, in_recovery);

    if (acc->acc_flags & ACC_CUBIC)
        return rv[0];
    else return rv[1];
}


static void adaptive_cc_cleanup (void *cong_ctl)
{
    struct adaptive_cc *const acc = cong_ctl;

    CALL_BOTH0(cci_cleanup);
    LSQ_DEBUG("cleanup");
}


const struct cong_ctl_if lsquic_cong_adaptive_if = {
    .cci_ack           = adaptive_cc_ack, .cci_begin_ack     = adaptive_cc_begin_ack, .cci_end_ack       = adaptive_cc_end_ack, .cci_cleanup       = adaptive_cc_cleanup, .cci_get_cwnd      = adaptive_cc_get_cwnd, .cci_init          = adaptive_cc_init, .cci_pacing_rate   = adaptive_cc_pacing_rate, .cci_loss          = adaptive_cc_loss, .cci_lost          = adaptive_cc_lost, .cci_reinit        = adaptive_cc_reinit, .cci_timeout       = adaptive_cc_timeout, .cci_sent          = adaptive_cc_sent, .cci_was_quiet     = adaptive_cc_was_quiet, };












