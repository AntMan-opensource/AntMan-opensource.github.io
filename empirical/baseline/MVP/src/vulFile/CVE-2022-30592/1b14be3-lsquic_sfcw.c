




























void lsquic_sfcw_init (struct lsquic_sfcw *fc, unsigned max_recv_window, struct lsquic_cfcw *cfcw, struct lsquic_conn_public *cpub, lsquic_stream_id_t stream_id)


{
    memset(fc, 0, sizeof(*fc));
    fc->sf_max_recv_win = max_recv_window;
    fc->sf_cfcw = cfcw;
    fc->sf_conn_pub = cpub;
    fc->sf_stream_id = stream_id;
    (void) lsquic_sfcw_fc_offsets_changed(fc);
}


static void sfcw_maybe_increase_max_window (struct lsquic_sfcw *fc)
{
    unsigned new_max_window, max_conn_window;

    new_max_window = fc->sf_max_recv_win * 2;

    
    if (new_max_window > fc->sf_conn_pub->enpub->enp_settings.es_max_sfcw)
        new_max_window = fc->sf_conn_pub->enpub->enp_settings.es_max_sfcw;

    if (fc->sf_cfcw)
    {
        
        max_conn_window = lsquic_cfcw_get_max_recv_window(fc->sf_cfcw);
        if (new_max_window > max_conn_window)
            new_max_window = max_conn_window;
    }
    else {
        
    }

    if (new_max_window > fc->sf_max_recv_win)
    {
        LSQ_DEBUG("max window increase %u -> %u", fc->sf_max_recv_win, new_max_window);
        EV_LOG_CONN_EVENT(LSQUIC_LOG_CONN_ID, "max SFCW increase %u -> %u", fc->sf_max_recv_win, new_max_window);

        fc->sf_max_recv_win = new_max_window;
    }
    else LSQ_DEBUG("max window could use an increase, but we're stuck " "at %u", fc->sf_max_recv_win);

}


int lsquic_sfcw_fc_offsets_changed (struct lsquic_sfcw *fc)
{
    lsquic_time_t since_last_update, srtt, now;

    if (fc->sf_recv_off - fc->sf_read_off >= fc->sf_max_recv_win / 2)
    {
        LSQ_DEBUG("recv_off has not changed, still at %"PRIu64, fc->sf_recv_off);
        return 0;
    }

    now = lsquic_time_now();
    since_last_update = now - fc->sf_last_updated;
    fc->sf_last_updated = now;

    srtt = lsquic_rtt_stats_get_srtt(&fc->sf_conn_pub->rtt_stats);
    if (since_last_update < srtt * 2)
        sfcw_maybe_increase_max_window(fc);

    fc->sf_recv_off = fc->sf_read_off + fc->sf_max_recv_win;
    LSQ_DEBUG("recv_off changed: read_off: %"PRIu64"; " "recv_off: %"PRIu64, fc->sf_read_off, fc->sf_recv_off);
    return 1;
}


int lsquic_sfcw_set_max_recv_off (struct lsquic_sfcw *fc, uint64_t max_recv_off)
{
    if (max_recv_off <= fc->sf_recv_off)
    {
        if (!fc->sf_cfcw || lsquic_cfcw_incr_max_recv_off(fc->sf_cfcw, max_recv_off - fc->sf_max_recv_off))
        {
            LSQ_DEBUG("max_recv_off goes from %"PRIu64" to %"PRIu64, fc->sf_max_recv_off, max_recv_off);
            fc->sf_max_recv_off = max_recv_off;
            return 1;
        }
        else {
            
            return 0;
        }
    }
    else {
        LSQ_INFO("flow control violation: received at offset %"PRIu64", " "while flow control receive offset is %"PRIu64, max_recv_off, fc->sf_recv_off);

        return 0;
    }
}


void lsquic_sfcw_set_read_off (struct lsquic_sfcw *fc, uint64_t off)
{
    if (fc->sf_cfcw)
        lsquic_cfcw_incr_read_off(fc->sf_cfcw, off - fc->sf_read_off);
    LSQ_DEBUG("read_off goes from %"PRIu64" to %"PRIu64, fc->sf_read_off, off);
    fc->sf_read_off = off;
}
