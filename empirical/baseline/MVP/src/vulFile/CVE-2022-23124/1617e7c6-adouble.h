 




































































































































typedef uint32_t cnid_t;

struct ad_entry {
    off_t     ade_off;
    ssize_t   ade_len;
};

typedef struct adf_lock_t {
    struct flock lock;
    int user;
    int *refcount; 
} adf_lock_t;

struct ad_fd {
    int          adf_fd;        
    char         *adf_syml;
    int          adf_flags;
    adf_lock_t   *adf_lock;
    int          adf_refcount, adf_lockcount, adf_lockmax;
};





struct adouble;

struct adouble_fops {
    const char *(*ad_path)(const char *, int);
    int  (*ad_mkrf)(const char *);
    int  (*ad_rebuild_header)(struct adouble *);
    int  (*ad_header_read)(const char *, struct adouble *, const struct stat *);
    int  (*ad_header_upgrade)(struct adouble *, const char *);
};

struct adouble {
    uint32_t            ad_magic;         
    uint32_t            ad_version;       
    char                ad_filler[16];
    struct ad_entry     ad_eid[ADEID_MAX];

    struct ad_fd        ad_data_fork;     

    struct ad_fd        ad_resource_fork; 

    struct ad_fd        *ad_rfp;          

    struct ad_fd        *ad_mdp;          

    int                 ad_vers;          
    int                 ad_adflags;       
    uint32_t            ad_inited;
    int                 ad_options;
    int                 ad_refcount;       
    int                 ad_data_refcount;
    int                 ad_meta_refcount;
    int                 ad_reso_refcount;
    off_t               ad_rlen;           
    char                *ad_name;          
    struct adouble_fops *ad_ops;
    uint16_t            ad_open_forks;     
    char                ad_data[AD_DATASZ_MAX];
};















































































































































extern int ad_rebuild_adouble_header_v2(struct adouble *);
extern int ad_rebuild_adouble_header_ea(struct adouble *);
extern  int ad_rebuild_adouble_header_osx(struct adouble *ad, char *adbuf);
extern int ad_copy_header (struct adouble *, struct adouble *);
extern int ad_flush (struct adouble *);
extern int ad_close (struct adouble *, int);
extern int fsetrsrcea(struct adouble *ad, int fd, const char *eaname, const void *value, size_t size, int flags);


extern int ad_testlock      (struct adouble *adp, int eid, off_t off);
extern uint16_t ad_openforks(struct adouble *adp, uint16_t);
extern int ad_lock(struct adouble *, uint32_t eid, int type, off_t off, off_t len, int fork);
extern void ad_unlock(struct adouble *, int fork, int unlckbrl);
extern int ad_tmplock(struct adouble *, uint32_t eid, int type, off_t off, off_t len, int fork);


extern off_t ad_getentryoff(const struct adouble *ad, int eid);
extern const char *adflags2logstr(int adflags);
extern int ad_setfuid     (const uid_t );
extern uid_t ad_getfuid   (void );
extern char *ad_dir       (const char *);
extern const char *ad_path      (const char *, int);
extern const char *ad_path_ea   (const char *, int);
extern const char *ad_path_osx  (const char *path, int adflags);
extern int ad_mode        (const char *, mode_t);
extern int ad_mkdir       (const char *, mode_t);
struct vol;
extern void ad_init       (struct adouble *, const struct vol * restrict);
extern void ad_init_old   (struct adouble *ad, int flags, int options);
extern int ad_init_offsets(struct adouble *ad);
extern int ad_open        (struct adouble *ad, const char *path, int adflags, ...);
extern int ad_openat      (struct adouble *, int dirfd, const char *path, int adflags, ...);
extern int ad_refresh     (const char *path, struct adouble *);
extern int ad_stat        (const char *, struct stat *);
extern int ad_metadata    (const char *, int, struct adouble *);
extern int ad_metadataat  (int, const char *, int, struct adouble *);
extern mode_t ad_hf_mode(mode_t mode);
extern int ad_valid_header_osx(const char *path);
extern off_t ad_reso_size(const char *path, int adflags, struct adouble *ad);


extern int ad_convert(const char *path, const struct stat *sp, const struct vol *vol, const char **newpath);


extern int     sys_ftruncate(int fd, off_t length);
extern ssize_t ad_read(struct adouble *, uint32_t, off_t, char *, size_t);
extern ssize_t ad_pread(struct ad_fd *, void *, size_t, off_t);
extern ssize_t ad_write(struct adouble *, uint32_t, off_t, int, const char *, size_t);
extern ssize_t adf_pread(struct ad_fd *, void *, size_t, off_t);
extern ssize_t adf_pwrite(struct ad_fd *, const void *, size_t, off_t);
extern int     ad_dtruncate(struct adouble *, off_t);
extern int     ad_rtruncate(struct adouble *, const char *, off_t);
extern int     copy_fork(int eid, struct adouble *add, struct adouble *ads, char *buf, size_t buflen);


extern off_t ad_size (const struct adouble *, uint32_t );


extern void *ad_mmapread(struct adouble *, uint32_t, off_t, size_t);
extern void *ad_mmapwrite(struct adouble *, uint32_t, off_t, int, size_t);



extern int ad_setdate(struct adouble *, unsigned int, uint32_t);
extern int ad_getdate(const struct adouble *, unsigned int, uint32_t *);


extern int       ad_setattr(const struct adouble *, const uint16_t);
extern int       ad_getattr(const struct adouble *, uint16_t *);
extern int       ad_setname(struct adouble *, const char *);
extern int       ad_setid(struct adouble *, dev_t dev, ino_t ino, uint32_t, uint32_t, const void *);
extern uint32_t  ad_getid(struct adouble *, dev_t, ino_t, cnid_t, const void *);
extern uint32_t  ad_forcegetid(struct adouble *adp);


extern int ad_readfile_init(const struct adouble *ad, int eid, off_t *off, int end);


extern ssize_t ad_recvfile(struct adouble *ad, int eid,  int sock, off_t off, size_t len, int);



