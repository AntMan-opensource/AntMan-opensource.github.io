











typedef ut32 LUA_INSTRUCTION;


























typedef struct lua_proto_ex {
	ut64 offset; 
	ut64 size; 

	ut8 *proto_name; 
	int name_size; 

	ut64 line_defined; 
	ut64 lastline_defined; 

	ut8 num_params; 
	ut8 is_vararg; 
	ut8 max_stack_size; 

	
	ut64 code_offset; 
	ut64 code_size; 
	ut64 code_skipped; 

	
	RzList *const_entries; 
	ut64 const_offset; 
	ut64 const_size; 

	
	RzList *upvalue_entries; 
	ut64 upvalue_offset; 
	ut64 upvalue_size; 

	
	RzList *proto_entries; 
	ut64 inner_proto_offset; 
	ut64 inner_proto_size; 

	
	ut64 debug_offset; 
	ut64 debug_size; 
	RzList *line_info_entries; 
	RzList *abs_line_info_entries; 
	RzList *local_var_info_entries; 
	RzList *dbg_upvalue_entries; 

} LuaProtoHeavy;

typedef LuaProtoHeavy LuaProto;


typedef struct lua_constant_entry {
	ut8 tag; 
	void *data; 
	int data_len; 
	ut64 offset; 
} LuaConstEntry;


typedef struct lua_upvalue_entry {
	
	ut8 instack; 
	ut8 idx; 
	ut8 kind; 
	ut64 offset; 
} LuaUpvalueEntry;

typedef struct LuaProto LuaProtoEntry;


typedef struct lua_lineinfo_entry {
	ut32 info_data;
	ut64 offset;
} LuaLineinfoEntry;


typedef struct lua_abs_lineinfo_entry {
	int pc; 
	int line; 
	ut64 offset;
} LuaAbsLineinfoEntry;


typedef struct lua_local_var_entry {
	ut8 *varname; 
	int varname_len; 
	int start_pc; 
	int end_pc; 
	ut64 offset; 
} LuaLocalVarEntry;


typedef struct lua_dbg_upvalue_entry {
	ut8 *upvalue_name; 
	int name_len; 
	ut64 offset;
} LuaDbgUpvalueEntry;


typedef struct luac_bin_info {
	st32 major; 
	st32 minor; 
	RzList *section_list; 
	RzList *symbol_list; 
	RzList *entry_list; 
	RzList *string_list; 
	RzBinInfo *general_info; 
} LuacBinInfo;


LuaDbgUpvalueEntry *lua_new_dbg_upvalue_entry();
LuaLocalVarEntry *lua_new_local_var_entry();
LuaAbsLineinfoEntry *lua_new_abs_lineinfo_entry();
LuaLineinfoEntry *lua_new_lineinfo_entry();
LuaUpvalueEntry *lua_new_upvalue_entry();
LuaConstEntry *lua_new_const_entry();
LuaProto *lua_new_proto_entry();

void lua_free_dbg_upvalue_entry(LuaDbgUpvalueEntry *);
void lua_free_local_var_entry(LuaLocalVarEntry *);
void lua_free_const_entry(LuaConstEntry *);
void lua_free_proto_entry(LuaProto *);


void luac_add_section(RzList *section_list, char *name, ut64 offset, ut32 size, bool is_func);
void luac_add_symbol(RzList *symbol_list, char *name, ut64 offset, ut64 size, const char *type);
void luac_add_entry(RzList *entry_list, ut64 offset, int entry_type);
void luac_add_string(RzList *string_list, char *string, ut64 offset, ut64 size);

LuacBinInfo *luac_build_info(LuaProto *proto);
void _luac_build_info(LuaProto *proto, LuacBinInfo *info);


RzBinInfo *lua_parse_header_54(RzBinFile *bf, st32 major, st32 minor);
LuaProto *lua_parse_body_54(RzBuffer *buffer, ut64 offset, ut64 data_size);

RzBinInfo *lua_parse_header_53(RzBinFile *bf, st32 major, st32 minor);
LuaProto *lua_parse_body_53(RzBuffer *buffer, ut64 offset, ut64 data_size);













