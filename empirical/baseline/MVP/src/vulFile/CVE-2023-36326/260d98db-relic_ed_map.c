










void ed_map_ell2_5mod8(ed_t p, fp_t t) {
	bn_t h;
	fp_t tv1, tv2, tv3, tv4, tv5;
	bn_null(h);
	fp_null(tv1);
	fp_null(tv2);
	fp_null(tv3);
	fp_null(tv4);
	fp_null(tv5);

	
	ctx_t *ctx = core_get();
	dig_t *c_2exp = ctx->ed_map_c[0];
	dig_t *sqrt_M1 = ctx->ed_map_c[1];
	dig_t *sqrt_M486664 = ctx->ed_map_c[2];
	dig_t *c_486662 = ctx->ed_map_c[3];

	RLC_TRY {
		bn_new(h);
		fp_new(tv1);
		fp_new(tv2);
		fp_new(tv3);
		fp_new(tv4);
		fp_new(tv5);

		
		h->used = RLC_FP_DIGS;
		h->sign = RLC_POS;
		dv_copy(h->dp, fp_prime_get(), RLC_FP_DIGS); 
		bn_sub_dig(h, h, 5);                         
		bn_rsh(h, h, 3);                             

		
		fp_sqr(tv1, t);
		fp_dbl(tv1, tv1);
		fp_add_dig(tv3, tv1, 1);
		fp_sqr(tv2, tv3);
		fp_mul(p->z, tv2, tv3);

		
		fp_sqr(tv4, c_486662);
		fp_mul(tv4, tv4, tv1);
		fp_sub(tv4, tv4, tv2);
		fp_mul(tv4, tv4, c_486662);

		
		fp_sqr(tv3, p->z);
		fp_sqr(tv2, tv3);
		fp_mul(tv3, tv3, p->z);
		fp_mul(tv3, tv3, tv4);
		fp_mul(tv2, tv2, tv3);
		fp_exp(tv2, tv2, h);
		fp_mul(tv2, tv2, tv3);

		
		fp_mul(p->y, tv2, sqrt_M1);
		fp_sqr(p->x, tv2);
		fp_mul(p->x, p->x, p->z);
		{
			const int e1 = fp_cmp(p->x, tv4);
			dv_copy_cond(p->y, tv2, RLC_FP_DIGS, e1 == RLC_EQ);
		} 

		
		fp_mul(tv3, tv2, t);
		fp_mul(tv3, tv3, c_2exp);
		fp_mul(tv5, tv3, sqrt_M1);

		
		fp_mul(p->x, tv4, tv1);
		fp_sqr(tv2, tv3);
		fp_mul(tv2, tv2, p->z);
		{
			const int e2 = fp_cmp(p->x, tv2);
			dv_copy_cond(tv5, tv3, RLC_FP_DIGS, e2 == RLC_EQ);
		} 

		
		fp_sqr(tv2, p->y);
		fp_mul(tv2, tv2, p->z);
		{
			const int e3 = fp_cmp(tv2, tv4);
			fp_set_dig(p->x, 1);
			dv_copy_cond(p->x, tv1, RLC_FP_DIGS, e3 != RLC_EQ);
			fp_mul(p->x, p->x, c_486662);
			fp_neg(p->x, p->x);
			dv_copy_cond(p->y, tv5, RLC_FP_DIGS, e3 != RLC_EQ);

			
			fp_prime_back(h, p->y);
			const int e4 = bn_get_bit(h, 0);
			fp_neg(tv2, p->y);
			dv_copy_cond(p->y, tv2, RLC_FP_DIGS, (e3 == RLC_EQ) ^ (e4 == 1));
		} 
		fp_add_dig(p->z, tv1, 1);

		
		
		fp_mul(tv1, p->x, sqrt_M486664); 
		fp_mul(tv2, p->y, p->z);         
		fp_sub(tv3, p->x, p->z);         
		fp_add(tv4, p->x, p->z);         

		fp_mul(p->z, tv2, tv4);
		fp_mul(p->x, tv1, tv4);
		fp_mul(p->y, tv2, tv3);
		{
			
			const int e4 = fp_is_zero(p->z);
			fp_set_dig(tv5, 1);
			dv_copy_cond(p->x, p->z, RLC_FP_DIGS, e4); 
			dv_copy_cond(p->y, tv5, RLC_FP_DIGS, e4);
			dv_copy_cond(p->z, tv5, RLC_FP_DIGS, e4);
		} 

		

		p->coord = PROJC;

		
		fp_mul(p->t, p->x, p->y);
		fp_mul(p->x, p->x, p->z);
		fp_mul(p->y, p->y, p->z);
		fp_sqr(p->z, p->z);


		fp_inv(tv1, p->z);
		fp_mul(p->x, p->x, tv1);
		fp_mul(p->y, p->y, tv1);
		fp_set_dig(p->z, 1);
		p->coord = BASIC;

	}
	RLC_CATCH_ANY {
		RLC_THROW(ERR_CAUGHT)
	}
	RLC_FINALLY {
		bn_free(h);
		fp_free(tv1);
		fp_free(tv2);
		fp_free(tv3);
		fp_free(tv4);
		fp_free(tv5);
	}
}





void ed_map_dst(ed_t p, const uint8_t *msg, int len, const uint8_t *dst, int dst_len) {
	bn_t k;
	fp_t t;
	ed_t q;
	
	const int len_per_elm = (FP_PRIME + ed_param_level() + 7) / 8;
	uint8_t *pseudo_random_bytes = RLC_ALLOCA(uint8_t, 2 * len_per_elm);

	bn_null(k);
	fp_null(t);
	ed_null(q);

	RLC_TRY {
		bn_new(k);
		fp_new(t);
		ed_new(q);

		
		md_xmd(pseudo_random_bytes, 2 * len_per_elm, msg, len, dst, dst_len);






		
		ED_MAP_CONVERT_BYTES(0);
		ed_map_ell2_5mod8(p, t);

		
		ED_MAP_CONVERT_BYTES(1);
		ed_map_ell2_5mod8(q, t);



		ed_add(p, p, q);

		
		switch (ed_param_get()) {
			case CURVE_ED25519:
				ed_dbl(p, p);
				ed_dbl(p, p);
				ed_dbl(p, p);
				break;
			default:
				RLC_THROW(ERR_NO_VALID);
				break;
		}

		ed_norm(p, p);

		fp_mul(p->t, p->x, p->y);

		p->coord = BASIC;
	}
	RLC_CATCH_ANY {
		RLC_THROW(ERR_CAUGHT);
	}
	RLC_FINALLY {
		bn_free(k);
		fp_free(t);
		ed_free(q);
		RLC_FREE(pseudo_random_bytes);
	}
}

void ed_map(ed_t p, const uint8_t *msg, int len) {
	ed_map_dst(p, msg, len, (const uint8_t *)"RELIC", 5);
}
