













 
 



















 
 
 
 
 






 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 
 

 
 
 
 
 

















UINT  _ux_device_class_storage_csw_send(UX_SLAVE_CLASS_STORAGE *storage, ULONG lun,  UX_SLAVE_ENDPOINT *endpoint_in, UCHAR csw_status)
{

UINT                    status = UX_SUCCESS;
UX_SLAVE_TRANSFER       *transfer_request;
UCHAR                   *csw_buffer;


    UX_PARAMETER_NOT_USED(csw_status);
    UX_PARAMETER_NOT_USED(lun);



    
    storage -> ux_device_class_storage_ep_out -> ux_slave_endpoint_transfer_request. ux_slave_transfer_request_data_pointer = storage -> ux_device_class_storage_buffer[0];
    storage -> ux_device_class_storage_ep_in -> ux_slave_endpoint_transfer_request. ux_slave_transfer_request_data_pointer = storage -> ux_device_class_storage_buffer[1];


    
    if (UX_DEVICE_CLASS_STORAGE_CSW_SKIP(&storage -> ux_slave_class_storage_csw_status))
        return(UX_SUCCESS);

    
    transfer_request =  &endpoint_in -> ux_slave_endpoint_transfer_request;

    
    csw_buffer = transfer_request -> ux_slave_transfer_request_data_pointer;

    
    _ux_utility_memory_set(csw_buffer, 0, UX_SLAVE_CLASS_STORAGE_CSW_LENGTH); 

    
    _ux_utility_long_put(&csw_buffer[UX_SLAVE_CLASS_STORAGE_CSW_SIGNATURE], UX_SLAVE_CLASS_STORAGE_CSW_SIGNATURE_MASK);

    
    _ux_utility_long_put(&csw_buffer[UX_SLAVE_CLASS_STORAGE_CSW_TAG], storage -> ux_slave_class_storage_scsi_tag);

    
    _ux_utility_long_put(&csw_buffer[UX_SLAVE_CLASS_STORAGE_CSW_DATA_RESIDUE], storage -> ux_slave_class_storage_csw_residue);

    
    csw_buffer[UX_SLAVE_CLASS_STORAGE_CSW_STATUS] = (UCHAR)storage -> ux_slave_class_storage_csw_status;



    
    storage -> ux_device_class_storage_cmd_state = UX_DEVICE_CLASS_STORAGE_CMD_CSW;
    storage -> ux_device_class_storage_state = UX_DEVICE_CLASS_STORAGE_STATE_TRANS_START;
    storage -> ux_device_class_storage_transfer = transfer_request;

    storage -> ux_device_class_storage_device_length = UX_SLAVE_CLASS_STORAGE_CSW_LENGTH;
    storage -> ux_device_class_storage_data_length = UX_SLAVE_CLASS_STORAGE_CSW_LENGTH;
    storage -> ux_device_class_storage_data_count = 0;



    
    
    status =  _ux_device_stack_transfer_request(transfer_request, UX_SLAVE_CLASS_STORAGE_CSW_LENGTH,  UX_SLAVE_CLASS_STORAGE_CSW_LENGTH);


    
    return(status);
}

