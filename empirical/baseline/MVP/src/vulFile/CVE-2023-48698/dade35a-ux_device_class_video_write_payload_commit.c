






































































UINT _ux_device_class_video_write_payload_commit(UX_DEVICE_CLASS_VIDEO_STREAM *stream, ULONG length)
{

UX_SLAVE_ENDPOINT           *endpoint;
UX_SLAVE_DEVICE             *device;
UCHAR                       *next_pos;


    
    device =  &_ux_system_slave -> ux_system_slave_device;

    
    if (device -> ux_slave_device_state != UX_DEVICE_CONFIGURED)
    {

        
        _ux_system_error_handler(UX_SYSTEM_LEVEL_THREAD, UX_SYSTEM_CONTEXT_CLASS, UX_CONFIGURATION_HANDLE_UNKNOWN);

        
        return(UX_CONFIGURATION_HANDLE_UNKNOWN);
    }

    
    endpoint = stream -> ux_device_class_video_stream_endpoint;
    if (endpoint == UX_NULL)
        return(UX_ERROR);

    
    if ((endpoint -> ux_slave_endpoint_descriptor.bEndpointAddress & UX_ENDPOINT_DIRECTION) == UX_ENDPOINT_OUT)
        return(UX_ERROR);

    
    if (stream -> ux_device_class_video_stream_access_pos == stream -> ux_device_class_video_stream_transfer_pos && stream -> ux_device_class_video_stream_access_pos -> ux_device_class_video_payload_length != 0)
        return(UX_BUFFER_OVERFLOW);

    
    if ((stream -> ux_device_class_video_stream_payload_buffer_size - 4) < length)
        return(UX_ERROR);

    
    next_pos = (UCHAR *)stream -> ux_device_class_video_stream_access_pos;
    next_pos += stream -> ux_device_class_video_stream_payload_buffer_size;
    if (next_pos >= stream -> ux_device_class_video_stream_buffer + stream -> ux_device_class_video_stream_buffer_size)
        next_pos = stream -> ux_device_class_video_stream_buffer;

    
    stream -> ux_device_class_video_stream_access_pos -> ux_device_class_video_payload_length = length;

    
    stream -> ux_device_class_video_stream_access_pos = (UX_DEVICE_CLASS_VIDEO_PAYLOAD *)next_pos;

    return(UX_SUCCESS);
}

