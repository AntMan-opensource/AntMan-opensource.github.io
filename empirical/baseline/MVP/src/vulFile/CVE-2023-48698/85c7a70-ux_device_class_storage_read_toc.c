













 
 




















 
 
 
 
 






 
 
 
 
 
 
 


 
 
 
 
 
 
 
 
 
 



 
 
 

 
 
 
 
 











UINT  _ux_device_class_storage_read_toc(UX_SLAVE_CLASS_STORAGE *storage, ULONG lun,  UX_SLAVE_ENDPOINT *endpoint_in, UX_SLAVE_ENDPOINT *endpoint_out, UCHAR * cbwcb)

{

UINT                    status;
UX_SLAVE_TRANSFER       *transfer_request;
ULONG                   allocation_length;
ULONG                   toc_length;
UCHAR                   *toc_buffer;


    UX_PARAMETER_NOT_USED(lun);
    UX_PARAMETER_NOT_USED(endpoint_out);

    
    UX_TRACE_IN_LINE_INSERT(UX_TRACE_DEVICE_CLASS_STORAGE_READ_TOC, storage, lun, 0, 0, UX_TRACE_DEVICE_CLASS_EVENTS, 0, 0)

    
    transfer_request =  &endpoint_in -> ux_slave_endpoint_transfer_request;

    
    toc_buffer = transfer_request -> ux_slave_transfer_request_data_pointer;

    
    _ux_utility_memory_set(toc_buffer,0,20); 

    
    allocation_length =  _ux_utility_short_get_big_endian(cbwcb + UX_SLAVE_CLASS_STORAGE_READ_TOC_ALLOCATION_LENGTH);

    
    toc_buffer[2] =  0x01;
    toc_buffer[3] =  0x01;
    
    
    toc_length = 20;
    
    
    toc_buffer[5] =  0x14;
    
    
    toc_buffer[6] =  0x01;
        
    
    switch (*(cbwcb + UX_SLAVE_CLASS_STORAGE_READ_TOC_FORMAT))
    {

        case  0x02 :

            
            toc_length  = 20;
        
            
            toc_buffer[1] =  0x12;
            
            
            toc_buffer[10] =  0x02;
            toc_buffer[13] =  0x17;
            toc_buffer[14] =  0xAA;
            toc_buffer[18] =  0x04;
            toc_buffer[19] =  0x1a;
            
            break;

        case 0x01 :

            
            toc_length  = 19;
        
            
            toc_buffer[1] =  0x12;
            
            toc_buffer[13] =  0x17;
            toc_buffer[14] =  0xAA;
            toc_buffer[19] =  0xb0;
            
            break;

        case 0x00 :
        
            
            toc_length  = 20;
        
            
            toc_buffer[1] =  0x12;
            
            
            toc_buffer[10] =  0x02;
            toc_buffer[13] =  0x17;
            toc_buffer[14] =  0xAA;
            toc_buffer[18] =  0x04;
            toc_buffer[19] =  0x1a;

            break;
    }
            
    
    if (allocation_length > toc_length)
    
        
        allocation_length = toc_length;
    


    
    storage -> ux_device_class_storage_state = UX_DEVICE_CLASS_STORAGE_STATE_TRANS_START;
    storage -> ux_device_class_storage_cmd_state = UX_DEVICE_CLASS_STORAGE_CMD_READ;

    storage -> ux_device_class_storage_transfer = transfer_request;
    storage -> ux_device_class_storage_device_length = allocation_length;
    storage -> ux_device_class_storage_data_length = allocation_length;
    storage -> ux_device_class_storage_data_count = 0;



    
    _ux_device_stack_transfer_request(transfer_request, allocation_length, allocation_length);


    
    storage -> ux_slave_class_storage_csw_status = UX_SLAVE_CLASS_STORAGE_CSW_PASSED;
    status = UX_SUCCESS;
    
    
    return(status);
    
}
    
