












 
 
















 
 
 
 
 






 
 
 
 
 
 
 
 
 
 
 
 
 
 
 


 
 
 
 
 
 
 
 
 















UINT  _ux_device_class_hid_event_set(UX_SLAVE_CLASS_HID *hid,  UX_SLAVE_CLASS_HID_EVENT *hid_event)
{

UX_SLAVE_CLASS_HID_EVENT   *current_hid_event;
UX_SLAVE_CLASS_HID_EVENT   *next_hid_event;

    
    UX_TRACE_IN_LINE_INSERT(UX_TRACE_DEVICE_CLASS_HID_EVENT_SET, hid, hid_event, 0, 0, UX_TRACE_DEVICE_CLASS_EVENTS, 0, 0)

    
    current_hid_event =  hid -> ux_device_class_hid_event_array_head;
    
    
    if (current_hid_event == UX_NULL)
        return (UX_ERROR);
    
    
    if ((current_hid_event + 1) == hid -> ux_device_class_hid_event_array_end)

        
        next_hid_event =  hid -> ux_device_class_hid_event_array;
        
    else           next_hid_event = current_hid_event + 1;


    

    
    if (next_hid_event == hid -> ux_device_class_hid_event_array_tail)
        return (UX_ERROR);

    
    current_hid_event =  hid -> ux_device_class_hid_event_array_head;

    
    hid -> ux_device_class_hid_event_array_head = next_hid_event;

    
    if (hid -> ux_device_class_hid_report_id == UX_TRUE)
    {

        
        if (hid_event -> ux_device_class_hid_event_length + 1 > UX_DEVICE_CLASS_HID_EVENT_BUFFER_LENGTH)
        {

            
            _ux_system_error_handler(UX_SYSTEM_LEVEL_THREAD, UX_SYSTEM_CONTEXT_CLASS, UX_MEMORY_INSUFFICIENT);

            
            UX_TRACE_IN_LINE_INSERT(UX_TRACE_ERROR, UX_MEMORY_INSUFFICIENT, 0, 0, 0, UX_TRACE_ERRORS, 0, 0)

            
            return(UX_MEMORY_INSUFFICIENT);
        }

        
        *current_hid_event -> ux_device_class_hid_event_buffer =  (UCHAR)(hid_event -> ux_device_class_hid_event_report_id);  
                
        
        _ux_utility_memory_copy(current_hid_event -> ux_device_class_hid_event_buffer + 1, hid_event -> ux_device_class_hid_event_buffer, hid_event -> ux_device_class_hid_event_length);
    
        
        current_hid_event -> ux_device_class_hid_event_length =  hid_event -> ux_device_class_hid_event_length + 1;    
    }
    else {
    
        
        _ux_utility_memory_copy(current_hid_event -> ux_device_class_hid_event_buffer, hid_event -> ux_device_class_hid_event_buffer, hid_event -> ux_device_class_hid_event_length);

        
        current_hid_event -> ux_device_class_hid_event_length = hid_event -> ux_device_class_hid_event_length;    
    }



    
    if (hid -> ux_device_class_hid_event_state != UX_STATE_WAIT && hid -> ux_device_class_hid_event_state != UX_STATE_EXIT)
        hid -> ux_device_class_hid_event_state = UX_STATE_RESET;


    
    _ux_device_event_flags_set(&hid -> ux_device_class_hid_event_flags_group, UX_DEVICE_CLASS_HID_NEW_EVENT, UX_OR);                


    
    return(UX_SUCCESS);
}

