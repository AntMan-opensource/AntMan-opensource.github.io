















BOOL guac_rdp_pointer_new(rdpContext* context, rdpPointer* pointer) {

    guac_client* client = ((rdp_freerdp_context*) context)->client;
    guac_rdp_client* rdp_client = (guac_rdp_client*) client->data;

    
    guac_common_display_layer* buffer = guac_common_display_alloc_buffer( rdp_client->display, pointer->width, pointer->height);

    
    unsigned char* data = _aligned_malloc(pointer->width * pointer->height * 4, 16);

    cairo_surface_t* surface;

    
    if (pointer->andMaskData && pointer->xorMaskData)
        freerdp_image_copy_from_pointer_data(data, guac_rdp_get_native_pixel_format(TRUE), 0, 0, 0, pointer->width, pointer->height, pointer->xorMaskData, pointer->lengthXorMask, pointer->andMaskData, pointer->lengthAndMask, pointer->xorBpp, &context->gdi->palette);





    
    surface = cairo_image_surface_create_for_data( data, CAIRO_FORMAT_ARGB32, pointer->width, pointer->height, 4*pointer->width);


    
    guac_common_surface_draw(buffer->surface, 0, 0, surface);

    
    cairo_surface_destroy(surface);
    _aligned_free(data);

    
    ((guac_rdp_pointer*) pointer)->layer = buffer;

    return TRUE;

}

BOOL guac_rdp_pointer_set(rdpContext* context, const rdpPointer* pointer) {

    guac_client* client = ((rdp_freerdp_context*) context)->client;
    guac_rdp_client* rdp_client = (guac_rdp_client*) client->data;

    
    guac_common_cursor_set_surface(rdp_client->display->cursor, pointer->xPos, pointer->yPos, ((guac_rdp_pointer*) pointer)->layer->surface);


    return TRUE;

}

void guac_rdp_pointer_free(rdpContext* context, rdpPointer* pointer) {

    guac_client* client = ((rdp_freerdp_context*) context)->client;
    guac_rdp_client* rdp_client = (guac_rdp_client*) client->data;
    guac_common_display_layer* buffer = ((guac_rdp_pointer*) pointer)->layer;

    
    guac_common_display_free_buffer(rdp_client->display, buffer);

    

}

BOOL guac_rdp_pointer_set_null(rdpContext* context) {

    guac_client* client = ((rdp_freerdp_context*) context)->client;
    guac_rdp_client* rdp_client = (guac_rdp_client*) client->data;

    
    guac_common_cursor_set_blank(rdp_client->display->cursor);

    return TRUE;

}

BOOL guac_rdp_pointer_set_default(rdpContext* context) {

    guac_client* client = ((rdp_freerdp_context*) context)->client;
    guac_rdp_client* rdp_client = (guac_rdp_client*) client->data;

    
    guac_common_cursor_set_pointer(rdp_client->display->cursor);

    return TRUE;
}

