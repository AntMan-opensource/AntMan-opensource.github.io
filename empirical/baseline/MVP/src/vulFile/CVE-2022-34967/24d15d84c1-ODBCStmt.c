












ODBCStmt * newODBCStmt(ODBCDbc *dbc)
{
	ODBCStmt *stmt = (ODBCStmt *) malloc(sizeof(ODBCStmt));

	assert(dbc);
	assert(dbc->mid);

	if (stmt == NULL) {
		
		addDbcError(dbc, "HY001", NULL, 0);
		return NULL;
	}

	*stmt = (ODBCStmt) {
		.Dbc = dbc, .Error = NULL, .RetrievedErrors = 0,  .State = INITED, .hdl = mapi_new_handle(dbc->mid), .currentRow = 0, .startRow = 0, .rowSetSize = 0, .queryid = -1, .nparams = 0, .querytype = -1, .rowcount = 0,  .qtimeout = dbc->qtimeout,  .cursorType = SQL_CURSOR_FORWARD_ONLY, .cursorScrollable = SQL_NONSCROLLABLE, .retrieveData = SQL_RD_ON, .noScan = SQL_NOSCAN_OFF,  .ApplRowDescr = newODBCDesc(dbc), .ApplParamDescr = newODBCDesc(dbc), .ImplRowDescr = newODBCDesc(dbc), .ImplParamDescr = newODBCDesc(dbc),  .Type = ODBC_STMT_MAGIC_NR, };



























	if (stmt->hdl == NULL) {
		
		addDbcError(dbc, "HY001", NULL, 0);
		destroyODBCStmt(stmt);
		return NULL;
	}
	if (stmt->ApplRowDescr == NULL || stmt->ApplParamDescr == NULL || stmt->ImplRowDescr == NULL || stmt->ImplParamDescr == NULL) {
		destroyODBCStmt(stmt);
		return NULL;
	}

	stmt->ApplRowDescr->sql_desc_alloc_type = SQL_DESC_ALLOC_AUTO;
	stmt->ApplParamDescr->sql_desc_alloc_type = SQL_DESC_ALLOC_AUTO;
	stmt->ImplRowDescr->sql_desc_alloc_type = SQL_DESC_ALLOC_AUTO;
	stmt->ImplParamDescr->sql_desc_alloc_type = SQL_DESC_ALLOC_AUTO;
	stmt->ImplRowDescr->Stmt = stmt;
	stmt->ImplParamDescr->Stmt = stmt;
	stmt->AutoApplRowDescr = stmt->ApplRowDescr;
	stmt->AutoApplParamDescr = stmt->ApplParamDescr;

	
	stmt->next = dbc->FirstStmt, dbc->FirstStmt = stmt;

	return stmt;
}



int isValidStmt(ODBCStmt *stmt)
{

	if (!(stmt &&stmt->Type == ODBC_STMT_MAGIC_NR))
		ODBCLOG("stmt %p not a valid statement handle\n", stmt);

	return stmt &&stmt->Type == ODBC_STMT_MAGIC_NR;
}



void addStmtError(ODBCStmt *stmt, const char *SQLState, const char *errMsg, int nativeErrCode)
{
	ODBCError *error = NULL;


	ODBCLOG("addStmtError %p %s %s %d\n", stmt, SQLState, errMsg ? errMsg : getStandardSQLStateMsg(SQLState), nativeErrCode);

	assert(isValidStmt(stmt));

	error = newODBCError(SQLState, errMsg, nativeErrCode);
	appendODBCError(&stmt->Error, error);
}



ODBCError * getStmtError(ODBCStmt *stmt)
{
	assert(isValidStmt(stmt));
	return stmt->Error;
}




void destroyODBCStmt(ODBCStmt *stmt)
{
	ODBCStmt **stmtp;

	assert(isValidStmt(stmt));

	
	stmt->Type = 0;

	
	assert(stmt->Dbc);
	assert(stmt->Dbc->FirstStmt);

	
	stmtp = &stmt->Dbc->FirstStmt;

	while (*stmtp && *stmtp != stmt)
		stmtp = &(*stmtp)->next;
	

	assert(*stmtp == stmt);	

	
	*stmtp = stmt->next;

	
	deleteODBCErrorList(&stmt->Error);

	destroyODBCDesc(stmt->ImplParamDescr);
	destroyODBCDesc(stmt->ImplRowDescr);
	destroyODBCDesc(stmt->AutoApplParamDescr);
	destroyODBCDesc(stmt->AutoApplRowDescr);

	if (stmt->hdl)
		mapi_close_handle(stmt->hdl);

	free(stmt);
}
