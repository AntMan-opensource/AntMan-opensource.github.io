




















struct trans; 
struct xrdp_tls;

typedef int (*ttrans_data_in)(struct trans *self);
typedef int (*ttrans_conn_in)(struct trans *self, struct trans *new_self);
typedef int (*tis_term)(void);
typedef int (*trans_recv_proc) (struct trans *self, char *ptr, int len);
typedef int (*trans_send_proc) (struct trans *self, const char *data, int len);
typedef int (*trans_can_recv_proc) (struct trans *self, int sck, int millis);



enum xrdp_source {
    XRDP_SOURCE_NONE = 0, XRDP_SOURCE_CLIENT, XRDP_SOURCE_SESMAN, XRDP_SOURCE_CHANSRV, XRDP_SOURCE_MOD,  XRDP_SOURCE_MAX_COUNT };








struct source_info {
    enum xrdp_source cur_source;
    int source[XRDP_SOURCE_MAX_COUNT];
};

struct trans {
    tbus sck; 
    int mode; 
    int status;
    int type1; 
    ttrans_data_in trans_data_in;
    ttrans_conn_in trans_conn_in;
    void *callback_data;
    int header_size;
    struct stream *in_s;
    struct stream *out_s;
    char *listen_filename;
    tis_term is_term; 
    struct stream *wait_s;
    char addr[256];
    char port[256];
    int no_stream_init_on_data_in;
    int extra_flags; 
    struct ssl_tls *tls;
    const char *ssl_protocol; 
    const char *cipher_name;  
    trans_recv_proc trans_recv;
    trans_send_proc trans_send;
    trans_can_recv_proc trans_can_recv;
    struct source_info *si;
    enum xrdp_source my_source;
};

struct trans * trans_create(int mode, int in_size, int out_size);
void trans_delete(struct trans *self);
void trans_delete_from_child(struct trans *self);
int trans_get_wait_objs(struct trans *self, tbus *objs, int *count);
int trans_get_wait_objs_rw(struct trans *self, tbus *robjs, int *rcount, tbus *wobjs, int *wcount, int *timeout);


int trans_check_wait_objs(struct trans *self);
int trans_force_read_s(struct trans *self, struct stream *in_s, int size);
int trans_force_write_s(struct trans *self, struct stream *out_s);
int trans_force_read(struct trans *self, int size);
int trans_force_write(struct trans *self);
int trans_write_copy(struct trans *self);
int trans_write_copy_s(struct trans *self, struct stream *out_s);
int trans_connect(struct trans *self, const char *server, const char *port, int timeout);

int trans_listen_address(struct trans *self, const char *port, const char *address);
int trans_listen(struct trans *self, const char *port);
struct stream * trans_get_in_s(struct trans *self);
struct stream * trans_get_out_s(struct trans *self, int size);
int trans_set_tls_mode(struct trans *self, const char *key, const char *cert, long ssl_protocols, const char *tls_ciphers);

int trans_shutdown_tls_mode(struct trans *self);
int trans_tcp_force_read_s(struct trans *self, struct stream *in_s, int size);


