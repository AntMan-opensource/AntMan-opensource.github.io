






























typedef struct __flv_header {
    byte            signature[3]; 
    uint8           version; 
    uint8_bitmask   flags;
    uint32_be       offset; 
} flv_header;












typedef struct __flv_tag {
    uint8       type;
    uint24_be   body_length; 
    uint24_be   timestamp; 
    uint8       timestamp_extended; 
    uint24_be   stream_id; 
    
} flv_tag;


































typedef byte flv_audio_tag;





















typedef byte flv_video_tag;





typedef byte flv_avc_packet_type;






typedef byte flv_aac_packet_type;





extern "C" {



void flv_tag_set_timestamp(flv_tag * tag, uint32 timestamp);







typedef struct __flv_stream {
    FILE * flvin;
    uint8 state;
    flv_tag current_tag;
    file_offset_t current_tag_offset;
    uint32 current_tag_body_length;
    uint32 current_tag_body_overflow;
} flv_stream;


flv_stream * flv_open(const char * file);
int flv_read_header(flv_stream * stream, flv_header * header);
int flv_read_prev_tag_size(flv_stream * stream, uint32 * prev_tag_size);
int flv_read_tag(flv_stream * stream, flv_tag * tag);
int flv_read_audio_tag(flv_stream * stream, flv_audio_tag * tag);
int flv_read_video_tag(flv_stream * stream, flv_video_tag * tag);
int flv_read_metadata(flv_stream * stream, amf_data ** name, amf_data ** data);
size_t flv_read_tag_body(flv_stream * stream, void * buffer, size_t buffer_size);
file_offset_t flv_get_current_tag_offset(flv_stream * stream);
file_offset_t flv_get_offset(flv_stream * stream);
void flv_reset(flv_stream * stream);
void flv_close(flv_stream * stream);


size_t flv_copy_header(void * to, const flv_header * header, size_t buffer_size);
size_t flv_copy_tag(void * to, const flv_tag * tag, size_t buffer_size);
size_t flv_copy_prev_tag_size(void * to, uint32 prev_tag_size, size_t buffer_size);


size_t flv_write_header(FILE * out, const flv_header * header);
size_t flv_write_tag(FILE * out, const flv_tag * tag);


typedef struct __flv_parser {
    flv_stream * stream;
    void * user_data;
    int (* on_header)(flv_header * header, struct __flv_parser * parser);
    int (* on_tag)(flv_tag * tag, struct __flv_parser * parser);
    int (* on_metadata_tag)(flv_tag * tag, amf_data * name, amf_data * data, struct __flv_parser * parser);
    int (* on_audio_tag)(flv_tag * tag, flv_audio_tag audio_tag, struct __flv_parser * parser);
    int (* on_video_tag)(flv_tag * tag, flv_video_tag audio_tag, struct __flv_parser * parser);
    int (* on_unknown_tag)(flv_tag * tag, struct __flv_parser * parser);
    int (* on_prev_tag_size)(uint32 size, struct __flv_parser * parser);
    int (* on_stream_end)(struct __flv_parser * parser);
} flv_parser;

int flv_parse(const char * file, flv_parser * parser);


}



