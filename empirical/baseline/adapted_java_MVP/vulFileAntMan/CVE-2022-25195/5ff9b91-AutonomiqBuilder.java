package io.jenkins.plugins.autonomiq;
import hudson.Launcher;
import hudson.Extension;
import hudson.FilePath;
import hudson.model.*;
import hudson.util.FormValidation;
import hudson.tasks.Builder;
import hudson.tasks.BuildStepDescriptor;
import hudson.util.ListBoxModel;
import hudson.util.ListBoxModel.Option;
import io.jenkins.plugins.autonomiq.service.ServiceAccess;
import io.jenkins.plugins.autonomiq.service.ServiceException;
import io.jenkins.plugins.autonomiq.service.types.AutInformation;
import io.jenkins.plugins.autonomiq.service.types.DiscoveryResponse;
import io.jenkins.plugins.autonomiq.service.types.GetTestSuitesResponse;
import io.jenkins.plugins.autonomiq.service.types.TestCasesResponse;
import io.jenkins.plugins.autonomiq.testplan.TestPlan;
import io.jenkins.plugins.autonomiq.testplan.TestPlanParser;
import io.jenkins.plugins.autonomiq.util.AiqUtil;
import io.jenkins.plugins.autonomiq.util.TimeStampedLogger;
import org.kohsuke.stapler.DataBoundConstructor;
import org.kohsuke.stapler.QueryParameter;
import org.kohsuke.stapler.verb.POST;
import javax.servlet.ServletException;
import java.io.*;
import java.util.Collection;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import hudson.util.Secret;
import jenkins.model.Jenkins;
import jenkins.tasks.SimpleBuildStep;
import org.apache.commons.lang.StringUtils;
import org.jenkinsci.Symbol;
import org.kohsuke.stapler.DataBoundSetter;
public class AutonomiqBuilder extends Builder implements SimpleBuildStep {
    private String aiqUrl;
    private String login;
    private Secret password;
    private String project; 
    private Boolean genScripts;
    private Boolean runTestCases;
    private Boolean runTestSuites;
    private String platformTestCases;
    private String browserTestCases;
    private String platformTestSuites;
    private String browserTestSuites;
    private String genCaseList;
    private String runCaseList;
    private String runSuiteList;
    private String proxyHost;
    private String proxyPort;
    private String proxyUser;
    private Secret proxyPassword;
    private Boolean httpProxy;
    private String executionMode;
    private static Long pollingIntervalMs = 10000L;
    public AutonomiqBuilder(String aiqUrl, String login, Secret password, String project, Boolean genScripts, Boolean runTestCases, Boolean runTestSuites, String platformTestCases, String browserTestCases, String platformTestSuites, String browserTestSuites, String genCaseList, String runCaseList, String runSuiteList, String proxyHost, String proxyPort, String proxyUser, Secret proxyPassword, Boolean httpProxy, String executionMode ) {
        this.aiqUrl = aiqUrl;
        this.login = login;
        this.password = password;
        this.project = project;
        this.genScripts = genScripts;
        this.runTestCases = runTestCases;
        this.runTestSuites = runTestSuites;
        this.platformTestCases = platformTestCases;
        this.browserTestCases = browserTestCases;
        this.platformTestSuites = platformTestSuites;
        this.browserTestSuites = browserTestSuites;
        this.genCaseList = genCaseList;
        this.runCaseList = runCaseList;
        this.runSuiteList = runSuiteList;
        this.proxyHost = proxyHost;
        this.proxyPort = proxyPort;
        this.proxyUser = proxyUser;
        this.proxyPassword = proxyPassword;
        this.httpProxy = httpProxy;
        this.executionMode = executionMode;
    }
    
    public void setAiqUrl(String aiqUrl) {
        this.aiqUrl = aiqUrl;
    }
    
    public String getAiqUrl() {
        return aiqUrl;
    }
    
    public void setLogin(String login) {
        this.login = login;
    }
    
    public String getLogin() {
        return login;
    }
    
    public void setPassword(Secret password) {
        this.password = password;
    }
    
    public Secret getPassword() {
        return password;
    }
    
    public void setProject(String project) {
        this.project = project;
    }
    
    public String getProject() {
        return project;
    }
    
    public void setGenScripts(Boolean genScripts) {
        this.genScripts = genScripts;
    }
    
    public Boolean getGenScripts() {
        return genScripts;
    }
    
    public void setRunTestCases(Boolean runTestCases) {
        this.runTestCases = runTestCases;
    }
    
    public Boolean getRunTestCases() {
        return runTestCases;
    }
    
    public void setRunTestSuites(Boolean runTestSuites) {
        this.runTestSuites = runTestSuites;
    }
    
    public Boolean getRunTestSuites() {
        return runTestSuites;
    }
    
    public void setPlatformTestCases(String platform) {
        this.platformTestCases = platform;
    }
    
    public String getPlatformTestCases() {
        return platformTestCases;
    }
    
    public void setBrowserTestCases(String browser) {
        this.browserTestCases = browser;
    }
    
    public String getBrowserTestCases() {
        return browserTestCases;
    }
    
    public void setPlatformTestSuites(String platform) {
        this.platformTestSuites = platform;
    }
    
    public String getPlatformTestSuites() {
        return platformTestSuites;
    }
    
    public void setBrowserTestSuites(String browser) {
        this.browserTestSuites = browser;
    }
    
    public String getBrowserTestSuites() {
        return browserTestSuites;
    }
    
    public String getRunCaseList() {
        return runCaseList;
    }
    
    public void setRunCaseList(String runCaseList) {
        this.runCaseList = runCaseList;
    }
    
    public void setGenCaseList(String genCaseList) {
        this.genCaseList = genCaseList;
    }
    
    public void setRunSuiteList(String runSuiteList) {
        this.runSuiteList = runSuiteList;
    }
    
    public String getGenCaseList() {
        return genCaseList;
    }
    
    public String getRunSuiteList() {
        return runSuiteList;
    }
    
    public void setProxyHost(String proxyHost) {
        this.proxyHost = proxyHost;
    }
    
    public String getProxyHost() {
        return proxyHost;
    }
    
    public void setProxyPort(String proxyPort) {
        this.proxyPort = proxyPort;
    }
    
    public String getProxyPort() {
        return proxyPort;
    }
    
    public void setProxyUser(String proxyUser) {
        this.proxyUser = proxyUser;
    }
    
    public String getProxyUser() {
        return proxyUser;
    }
    
    public void setProxyPassword(Secret proxyPassword) {
        this.proxyPassword = proxyPassword;
    }
    
    public Secret getProxyPassword() {
        return proxyPassword;
    }
    
    public void setHttpProxy(Boolean httpProxy) {
        this.httpProxy = httpProxy;
    }
    
    public Boolean getHttpProxy() {
        return httpProxy;
    }
    
    public void setExecutionMode(String executionMode) {
        this.executionMode = executionMode;
    }
    
    public String getExecutionMode() {
        return executionMode;
    }
    
    private static ServiceAccess getServiceAccess(String proxyHost, String proxyPort, String proxyUser, Secret proxyPassword, String aiqUrl, String login, Secret password, Boolean httpProxy) throws ServiceException {
    	ServiceAccess svc = null;
    	if (httpProxy && !StringUtils.isEmpty(proxyHost) && !StringUtils.isEmpty(proxyPort) ) {
    		svc = new ServiceAccess(proxyHost, proxyPort, proxyUser, proxyPassword, aiqUrl, login, password);
    	}
    	 else {
    		 svc = new ServiceAccess(aiqUrl, login, password);
    	}
    	
    	return svc;
    }
    
    public void perform(Run<?, ?> run, FilePath workspace, Launcher launcher, TaskListener listener) throws InterruptedException, IOException {
        TimeStampedLogger log = new TimeStampedLogger(listener.getLogger());
        boolean ok = true;
        AiqUtil.gson.fromJson(project, ProjectData.class);
        log.println();
        log.printf("Logging in as user '%s' to Autonomiq service at: %s\n", login, aiqUrl);
        log.println();
        ProjectData pd;
        try {
            pd = AiqUtil.gson.fromJson(project, ProjectData.class);
        }
         catch (Exception e) {
            throw new IOException("Exception unpacking project data", e);
        }
        
        ServiceAccess svc = null;
        try {
        	svc = getServiceAccess(proxyHost, proxyPort, proxyUser, proxyPassword, aiqUrl, login, password, httpProxy);
        }
         catch (Exception e) {
            ok = false;
            log.println("Authentication with Autonomiq service failed");
            log.println(AiqUtil.getExceptionTrace(e));
        }
        
        if (ok) {
            try {
                RunTests rt = new RunTests(svc, log, pd, pollingIntervalMs);
                ok = rt.runTests(genScripts, runTestCases, runTestSuites, platformTestCases, browserTestCases, platformTestSuites, browserTestSuites, genCaseList, runCaseList, runSuiteList, executionMode);
            }
             catch (PluginException e) {
                log.println("Running test case failed with exception");
                log.println(AiqUtil.getExceptionTrace(e));
            }
            
        }
        
        if (ok) {
            run.setResult(Result.SUCCESS);
        }
         else {
            run.setResult(Result.FAILURE);
        }
        
    }
    
    public static final class DescriptorImpl extends BuildStepDescriptor<Builder> {
        public FormValidation doCheckAiqUrl(@QueryParameter String value, @QueryParameter String aiqUrl) throws IOException, ServletException {
        	Jenkins.get().checkPermission(Jenkins.ADMINISTER);
            if (value.length() == 0){
                return FormValidation.error(Messages.AutonomiqBuilder_DescriptorImpl_errors_missingAiqUrl());
}
            if (!(value.startsWith("http://") || value.startsWith("https://"))){
                return FormValidation.warning(Messages.AutonomiqBuilder_DescriptorImpl_errors_notUrl());
}
            return FormValidation.ok();
        }
        
        public FormValidation doCheckLogin(@QueryParameter String value, @QueryParameter String login) throws IOException, ServletException {
        	Jenkins.get().checkPermission(Jenkins.ADMINISTER);
            if (value.length() == 0){
                return FormValidation.error(Messages.AutonomiqBuilder_DescriptorImpl_errors_missingLogin());
}
            if (value.length() < 4){
                return FormValidation.warning(Messages.AutonomiqBuilder_DescriptorImpl_warnings_tooShort());
}
            return FormValidation.ok();
        }
        
        public FormValidation doCheckPassword(@QueryParameter String value, @QueryParameter Secret password) throws IOException, ServletException {
        	Jenkins.get().checkPermission(Jenkins.ADMINISTER);
            if (value.length() == 0){
                return FormValidation.error(Messages.AutonomiqBuilder_DescriptorImpl_errors_missingPassword());
}
            if (value.length() < 6){
                return FormValidation.warning(Messages.AutonomiqBuilder_DescriptorImpl_warnings_tooShort());
}
            return FormValidation.ok();
        }
        
        public FormValidation doCheckProject(@QueryParameter String value) throws IOException, ServletException {
        	Jenkins.get().checkPermission(Jenkins.ADMINISTER);
            if (value.length() == 0){
                return FormValidation.error(Messages.AutonomiqBuilder_DescriptorImpl_errors_missingProject());
}
            return FormValidation.ok();
        }
        
        public FormValidation doCheckGenCaseList(@QueryParameter String value, @QueryParameter String aiqUrl, @QueryParameter String login, @QueryParameter Secret password, @QueryParameter String project, @QueryParameter String proxyHost, @QueryParameter String proxyPort, @QueryParameter String proxyUser, @QueryParameter Secret proxyPassword, @QueryParameter Boolean httpProxy) throws IOException, ServletException {
        	Jenkins.get().checkPermission(Jenkins.ADMINISTER);
            return checkTestCasesFromText(value, aiqUrl, login, password, project, proxyHost, proxyPort, proxyUser, proxyPassword, httpProxy);
        }
        
        public FormValidation doCheckRunCaseList(@QueryParameter String value, @QueryParameter String aiqUrl, @QueryParameter String login, @QueryParameter Secret password, @QueryParameter String project, @QueryParameter String proxyHost, @QueryParameter String proxyPort, @QueryParameter String proxyUser, @QueryParameter Secret proxyPassword, @QueryParameter Boolean httpProxy) throws IOException, ServletException {
        	Jenkins.get().checkPermission(Jenkins.ADMINISTER);
            return checkTestCasesFromText(value, aiqUrl, login, password, project, proxyHost, proxyPort, proxyUser, proxyPassword, httpProxy);
        }
        
        public FormValidation doCheckRunSuiteList(@QueryParameter String value, @QueryParameter String aiqUrl, @QueryParameter String login, @QueryParameter Secret password, @QueryParameter String project, @QueryParameter String proxyHost, @QueryParameter String proxyPort, @QueryParameter String proxyUser, @QueryParameter Secret proxyPassword, @QueryParameter Boolean httpProxy) throws IOException, ServletException {
        	Jenkins.get().checkPermission(Jenkins.ADMINISTER);
            if (value.length() > 0 && aiqUrl.length() > 0 && login.length() > 0 && Secret.toString(password).length() > 0 && project.length() > 0) {
                ProjectData pd;
                try {
                    pd = AiqUtil.gson.fromJson(project, ProjectData.class);
                }
                 catch (Exception e) {
                    return FormValidation.ok();
                }
                
                AiqUtil.ItemListFromString itemsObj = AiqUtil.getItemListFromString(value);
                if (itemsObj.getError() != null) {
                    return FormValidation.error(itemsObj.getError());
                }
                 else if (itemsObj.getItemList().size() > 0) {
                    try {
                        ServiceAccess svc = AutonomiqBuilder.getServiceAccess(proxyHost, proxyPort, proxyUser, proxyPassword, aiqUrl, login, password, httpProxy);
                        Set<String> set = getTestSuiteSet(svc, pd.getProjectId());
                        if (set != null) {
                            for (String item : itemsObj.getItemList()) {
                                if (!set.contains(item)) {
                                    return FormValidation.error(String.format("Test suite not found: '%s'", item));
                                }
                                
                            }
                            
                        }
                        
                    }
                     catch (Exception e) {
                        return FormValidation.ok();
                    }
                    
                }
                
            }
            
            return FormValidation.ok();
        }
        
        private FormValidation checkTestCasesFromText(String value, String aiqUrl, String login, Secret password, String project, String proxyHost, String proxyPort, String proxyUser, Secret proxyPassword, Boolean httpProxy) {
        	Jenkins.get().checkPermission(Jenkins.ADMINISTER);
            if (value.length() > 0 && aiqUrl.length() > 0 && login.length() > 0 && Secret.toString(password).length() > 0 && project.length() > 0) {
                ProjectData pd;
                try {
                    pd = AiqUtil.gson.fromJson(project, ProjectData.class);
                }
                 catch (Exception e) {
                    return FormValidation.ok();
                }
                
                AiqUtil.ItemListFromString itemsObj = AiqUtil.getItemListFromString(value);
                if (itemsObj.getError() != null) {
                    return FormValidation.error(itemsObj.getError());
                }
                 else if (itemsObj.getItemList().size() > 0) {
                    try {
                        ServiceAccess svc = AutonomiqBuilder.getServiceAccess(proxyHost, proxyPort, proxyUser, proxyPassword, aiqUrl, login, password, httpProxy);
                        Set<String> set = getTestCaseSet(svc, pd.getProjectId());
                        if (set != null) {
                            for (String item : itemsObj.getItemList()) {
                                if (!set.contains(item)) {
                                    return FormValidation.error(String.format("Test case not found: '%s'", item));
                                }
                                
                            }
                            
                        }
                        
                    }
                     catch (Exception e) {
                        return FormValidation.ok();
                    }
                    
                }
                
            }
            
            return FormValidation.ok();
        }
        
        private Set<String> getTestCaseSet(ServiceAccess svc, Long projectId) {
            try {
                Set<String> set = new HashSet<>();
                List<TestCasesResponse> cases = svc.getTestCasesForProject(projectId);
                for (TestCasesResponse t : cases) {
                    set.add(t.getTestCaseName());
                }
                
                return set;
            }
             catch (Exception e) {
                return null;
            }
            
        }
        
        private Set<String> getTestSuiteSet(ServiceAccess svc, Long projectId) {
            try {
                Set<String> set = new HashSet<>();
                List<GetTestSuitesResponse> suites = svc.getTestSuitesForProject(projectId);
                for (GetTestSuitesResponse t : suites) {
                    set.add(t.getTestSuiteName());
                }
                
                return set;
            }
             catch (Exception e) {
                return null;
            }
            
        }
        
        public String getDefaultAiqUrl() {
            String ret = AutonomiqConfiguration.get().getDefaultAiqUrl();
            return ret;
        }
        
        public String getDefaultLogin() {
            String ret = AutonomiqConfiguration.get().getDefaultLogin();
            return ret;
        }
        
        public Secret getDefaultPassword() {
            Secret ret = AutonomiqConfiguration.get().getDefaultPassword();
            return ret;
        }
        
        public boolean isApplicable(Class<? extends AbstractProject> aClass) {
            return true;
        }
        
        public String getDisplayName() {
            return Messages.AutonomiqBuilder_DescriptorImpl_DisplayName();
        }
        
        public ListBoxModel doFillProjectItems(@QueryParameter String aiqUrl, @QueryParameter String login, @QueryParameter Secret password, @QueryParameter String proxyHost, @QueryParameter String proxyPort, @QueryParameter String proxyUser, @QueryParameter Secret proxyPassword, @QueryParameter Boolean httpProxy) {
            if (aiqUrl.length() > 0 && login.length() > 0 && Secret.toString(password).length() > 0) {
                try {
                    Option[] options = getProjectOptions(aiqUrl, login, password, proxyHost, proxyPort, proxyUser, proxyPassword, httpProxy);
                    return new ListBoxModel(options);
                }
                 catch (Exception e) {
                }
                
            }
            
            return new ListBoxModel();
        }
        
        public ListBoxModel doFillPlatformTestCasesItems() {
            String[] values = {"Linux"};  
            Option[] options = buildSimpleOptions(values);
            return new ListBoxModel(options);
        }
        
        public ListBoxModel doFillPlatformTestSuitesItems() {
            String[] values = {"Linux"};  
            Option[] options = buildSimpleOptions(values);
            return new ListBoxModel(options);
        }
        
        public ListBoxModel doFillBrowserTestCasesItems() {
            String[] values = {"Chrome", "Firefox"};
            Option[] options = buildSimpleOptions(values);
            return new ListBoxModel(options);
        }
        
        public ListBoxModel doFillBrowserTestSuitesItems() {
            String[] values = {"Chrome", "Firefox"};
            Option[] options = buildSimpleOptions(values);
            return new ListBoxModel(options);
        }
        
        public ListBoxModel doFillExecutionModeItems() {
            String[] values = {"serial", "parallel"};
            Option[] options = buildSimpleOptions(values);
            return new ListBoxModel(options);
        }
        
        private Option[] getProjectOptions(String aiqUrl, String login, Secret password, String proxyHost, String proxyPort, String proxyUser, Secret proxyPassword, Boolean httpProxy) throws ServiceException {
            Option[] ret;
            try {
                ServiceAccess svc = AutonomiqBuilder.getServiceAccess(proxyHost, proxyPort, proxyUser, proxyPassword, aiqUrl, login, password, httpProxy);
                Collection<DiscoveryResponse> dataList = svc.getProjectData();
                ret = new Option[dataList.size() + 1];
                ret[0] = new Option("-- select project --", "");
                int index = 1;
                for (DiscoveryResponse data : dataList) {
                    Long discoveryId = 0L;
                    List<AutInformation> aut = data.getAutInformations();
                    if (aut != null && aut.size() > 0) {
                        discoveryId = aut.get(0).getDiscoveryId();
                    }
                    
                    ProjectData pd = new ProjectData(data.getProjectId(), discoveryId, data.getProjectName());
                    Option op = new Option(data.getProjectName(), AiqUtil.gson.toJson(pd));
                    ret[index] = op;
                    index++;
                }
                
            }
             catch (Exception e) {
                throw new ServiceException("Exception getting project list");
            }
            
            return ret;
        }
        
        private Option[] buildSimpleOptions(String[] values) {
            Option[] options = new Option[values.length];
            int index = 0;
            for (String val : values) {
                Option o = new Option(val, val);
                options[index] = o;
                index++;
            }
            
            return options;
        }
        
    }
    
}


