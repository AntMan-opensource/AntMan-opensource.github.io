package emissary.pickup;
import java.io.Serializable;
import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;
import java.util.UUID;
import emissary.util.xml.JDOMUtil;
import org.jdom2.Document;
import org.jdom2.Element;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
public class WorkBundle implements Serializable, Comparable<WorkBundle> {
    static final long serialVersionUID = 6339812801001572532L;
    private static final Logger logger = LoggerFactory.getLogger(WorkBundle.class);
    String bundleId;
    String outputRoot;
    String eatPrefix;
    String caseId = null;
    int priority = Priority.DEFAULT;
    boolean simpleMode = false;
    List<WorkUnit> workUnitList = new ArrayList<>();
    String sentTo;
    int errorCount = 0;
    long oldestFileModificationTime = Long.MAX_VALUE;
    long youngestFileModificationTime = Long.MIN_VALUE;
    long totalFileSize = 0L;
    public WorkBundle() {
        bundleId = generateId();
    }
    
    public WorkBundle(String outputRoot, String eatPrefix) {
        bundleId = generateId();
        this.outputRoot = outputRoot;
        this.eatPrefix = eatPrefix;
    }
    
    public WorkBundle(WorkBundle that) {
        this.bundleId = that.bundleId;
        this.outputRoot = that.getOutputRoot();
        this.eatPrefix = that.getEatPrefix();
        this.caseId = that.getCaseId();
        this.sentTo = that.sentTo;
        this.errorCount = that.errorCount;
        this.priority = that.getPriority();
        this.simpleMode = that.getSimpleMode();
        this.oldestFileModificationTime = that.oldestFileModificationTime;
        this.youngestFileModificationTime = that.youngestFileModificationTime;
        this.totalFileSize = that.totalFileSize;
        if (that.getWorkUnitList().size() > 0) {
            this.addWorkUnits(that.getWorkUnitList());
        }
        
        resetBundleId();
    }
    
    public void setBundleId(String val) {
        this.bundleId = val;
    }
    
    public String resetBundleId() {
        bundleId = generateId();
        return bundleId;
    }
    
    public String getBundleId() {
        return bundleId;
    }
    
    protected static String generateId() {
        return UUID.randomUUID().toString();
    }
    
    public String getOutputRoot() {
        return this.outputRoot;
    }
    
    public void setOutputRoot(String argOutputRoot) {
        this.outputRoot = argOutputRoot;
    }
    
    public String getEatPrefix() {
        return this.eatPrefix;
    }
    
    public void setEatPrefix(String argEatPrefix) {
        this.eatPrefix = argEatPrefix;
    }
    
    public List<WorkUnit> getWorkUnitList() {
        return new ArrayList<>(workUnitList);
    }
    
    public Iterator<WorkUnit> getWorkUnitIterator() {
        return workUnitList.iterator();
    }
    
    public int addWorkUnit(WorkUnit workUnit) {
        workUnitList.add(workUnit);
        return size();
    }
    
    public int addWorkUnit(WorkUnit workUnit, long fileModificationTimeInMillis, long fileSize) {
        workUnitList.add(workUnit);
        if (fileModificationTimeInMillis < oldestFileModificationTime) {
            oldestFileModificationTime = fileModificationTimeInMillis;
        }
        
        if (fileModificationTimeInMillis > youngestFileModificationTime) {
            youngestFileModificationTime = fileModificationTimeInMillis;
        }
        
        totalFileSize += fileSize;
        return size();
    }
    
    protected int addWorkUnits(List<WorkUnit> list) { 
        workUnitList.addAll(list);
        return workUnitList.size();
    }
    
    public List<String> getFileNameList() {
        ArrayList<String> fileNameList = new ArrayList<>(workUnitList.size());
        for (WorkUnit workUnit : workUnitList) {
            fileNameList.add(workUnit.getFileName());
        }
        
        return fileNameList;
    }
    
    public Iterator<String> getFileNameIterator() {
        return getFileNameList().iterator();
    }
    
    public int addFileName(String file) {
        workUnitList.add(new WorkUnit(file));
        return size();
    }
    
    public int addFileName(String file, long fileModificationTimeInMillis, long fileSize) {
        return addWorkUnit(new WorkUnit(file), fileModificationTimeInMillis, fileSize);
    }
    
    protected int addFileNames(String[] file) { 
        for (int i = 0; file != null && i < file.length; i++) {
            workUnitList.add(new WorkUnit(file[i]));
        }
        
        return size();
    }
    
    protected int addFileNames(List<String> list) { 
        for (String file : list) {
            workUnitList.add(new WorkUnit(file));
        }
        
        return size();
    }
    
    public int size() {
        return workUnitList.size();
    }
    
    protected void clearFiles() {
        workUnitList.clear();
        oldestFileModificationTime = Long.MAX_VALUE;
        youngestFileModificationTime = Long.MIN_VALUE;
        totalFileSize = 0L;
    }
    
    public String getCaseId() {
        return this.caseId;
    }
    
    public void setCaseId(String argCaseId) {
        this.caseId = argCaseId;
    }
    
    public void setSentTo(String place) {
        this.sentTo = place;
    }
    
    public String getSentTo() {
        return sentTo;
    }
    
    public int getErrorCount() {
        return errorCount;
    }
    
    public int incrementErrorCount() {
        return ++errorCount;
    }
    
    public void setErrorCount(int val) {
        errorCount = val;
    }
    
    public void setPriority(int val) {
        priority = val;
    }
    
    public int getPriority() {
        return priority;
    }
    
    public void setSimpleMode(boolean val) {
        simpleMode = val;
    }
    
    public boolean getSimpleMode() {
        return simpleMode;
    }
    
    public long getOldestFileModificationTime() {
        return oldestFileModificationTime;
    }
    
    public void setOldestFileModificationTime(long oldestFileModificationTime) {
        this.oldestFileModificationTime = oldestFileModificationTime;
    }
    
    public long getYoungestFileModificationTime() {
        return youngestFileModificationTime;
    }
    
    public void setYoungestFileModificationTime(long youngestFileModificationTime) {
        this.youngestFileModificationTime = youngestFileModificationTime;
    }
    
    public long getTotalFileSize() {
        return totalFileSize;
    }
    
    public void setTotalFileSize(long totalFileSize) {
        this.totalFileSize = totalFileSize;
    }
    
    public int compareTo(WorkBundle that) {
        if (this.getPriority() < that.getPriority()) {
            return -1;
        }
         else if (that.getPriority() < this.getPriority()) {
            return 1;
        }
         else {
            return 0;
        }
        
    }
    
    public String toString() {
        return "WorkBundle[id=" + getBundleId() + ", pri=" + getPriority() + ", files=" + getFileNameList().toString() + ", eatPrefix=" + getEatPrefix() + ", outputRoot=" + getOutputRoot() + ", sentTo=" + getSentTo() + ", errorCount=" + getErrorCount() + ", totalFileSize=" + getTotalFileSize() + ", oldestModTime=" + getOldestFileModificationTime() + ", youngModTime=" + getYoungestFileModificationTime() + ", simple=" + getSimpleMode() + ", caseId=" + getCaseId() + ", size=" + size() + "]";
    }
    
    public String toXml() {
        Element root = new Element("workBundle");
        root.addContent(JDOMUtil.simpleElement("bundleId", getBundleId()));
        root.addContent(JDOMUtil.simpleElement("outputRoot", getOutputRoot()));
        root.addContent(JDOMUtil.simpleElement("eatPrefix", getEatPrefix()));
        root.addContent(JDOMUtil.simpleElement("caseId", getCaseId()));
        root.addContent(JDOMUtil.simpleElement("sentTo", getSentTo()));
        root.addContent(JDOMUtil.simpleElement("errorCount", getErrorCount()));
        root.addContent(JDOMUtil.simpleElement("priority", getPriority()));
        root.addContent(JDOMUtil.simpleElement("simpleMode", getSimpleMode()));
        root.addContent(JDOMUtil.simpleElement("oldestFileModificationTime", getOldestFileModificationTime()));
        root.addContent(JDOMUtil.simpleElement("youngestFileModificationTime", getYoungestFileModificationTime()));
        root.addContent(JDOMUtil.simpleElement("totalFileSize", getTotalFileSize()));
        for (WorkUnit wu : workUnitList) {
            Element workunit = new Element("workUnit");
            workunit.addContent(JDOMUtil.simpleElement("workFileName", wu.getFileName()));
            if (wu.getTransactionId() != null) {
                workunit.addContent(JDOMUtil.simpleElement("transactionId", wu.getTransactionId()));
            }
            
            workunit.addContent(JDOMUtil.simpleElement("failedToParse", wu.failedToParse()));
            workunit.addContent(JDOMUtil.simpleElement("failedToProcess", wu.failedToProcess()));
            root.addContent(workunit);
        }
        
        Document jdom = new Document(root);
        return JDOMUtil.toString(jdom);
    }
    
    public static WorkBundle buildWorkBundle(String xml) {
        Document jdoc;
        try {
            jdoc = JDOMUtil.createDocument(xml, false);
            return buildWorkBundle(jdoc);
        }
         catch (Exception ex) {
            logger.error("Cannot make WorkBundle from " + xml, ex);
            return null;
        }
        
    }
    
    private static WorkBundle buildWorkBundle(Document jdom) {
        Element root = jdom.getRootElement();
        if (root == null) {
            logger.error("Document does not have a root element!");
            return null;
        }
        
        WorkBundle wb = new WorkBundle();
        wb.setBundleId(root.getChildTextTrim("bundleId"));
        String s = root.getChildTextTrim("outputRoot");
        if (s != null && s.length() > 0) {
            wb.setOutputRoot(s);
        }
         else {
            wb.setOutputRoot(null);
        }
        
        s = root.getChildTextTrim("eatPrefix");
        if (s != null && s.length() > 0) {
            wb.setEatPrefix(s);
        }
         else {
            wb.setEatPrefix(null);
        }
        
        s = root.getChildTextTrim("caseId");
        if (s != null && s.length() > 0) {
            wb.setCaseId(s);
        }
         else {
            wb.setCaseId(null);
        }
        
        s = root.getChildTextTrim("sentTo");
        if (s != null && s.length() > 0) {
            wb.setSentTo(s);
        }
         else {
            wb.setSentTo(null);
        }
        
        wb.setPriority(JDOMUtil.getChildIntValue(root, "priority"));
        wb.setSimpleMode(JDOMUtil.getChildBooleanValue(root, "simpleMode"));
        wb.setOldestFileModificationTime(JDOMUtil.getChildLongValue(root, "oldestFileModificationTime"));
        wb.setYoungestFileModificationTime(JDOMUtil.getChildLongValue(root, "youngestFileModificationTime"));
        wb.setTotalFileSize(JDOMUtil.getChildLongValue(root, "totalFileSize"));
        String serr = root.getChildTextTrim("errorCount");
        if (serr != null && serr.length() > 0) {
            wb.setErrorCount(Integer.parseInt(serr));
        }
        
        for (Element wu : root.getChildren("workUnit")) {
            String filename = wu.getChildTextTrim("workFileName");
            String transactionId = wu.getChildTextTrim("transactionId");
            boolean failedToParse = Boolean.valueOf(wu.getChildTextTrim("failedToParse"));
            boolean failedToProcess = Boolean.valueOf(wu.getChildTextTrim("failedToProcess"));
            wb.addWorkUnit(new WorkUnit(filename, transactionId, failedToParse, failedToProcess));
        }
        
        return wb;
    }
    
}


