package emissary.server.mvc.adapters;
import java.io.IOException;
import java.nio.charset.Charset;
import java.rmi.RemoteException;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import javax.servlet.http.HttpServletRequest;
import javax.ws.rs.core.MediaType;
import emissary.client.EmissaryClient;
import emissary.client.EmissaryResponse;
import emissary.config.ConfigUtil;
import emissary.config.Configurator;
import emissary.core.EmissaryException;
import emissary.core.IMobileAgent;
import emissary.core.Namespace;
import emissary.core.NamespaceException;
import emissary.directory.DirectoryEntry;
import emissary.directory.KeyManipulator;
import emissary.log.MDCConstants;
import emissary.place.IServiceProviderPlace;
import emissary.pool.AgentPool;
import emissary.util.PayloadUtil;
import org.apache.http.HttpStatus;
import org.apache.http.HttpVersion;
import org.apache.http.NameValuePair;
import org.apache.http.client.entity.EntityBuilder;
import org.apache.http.client.entity.UrlEncodedFormEntity;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.impl.cookie.BasicClientCookie;
import org.apache.http.message.BasicHttpResponse;
import org.apache.http.message.BasicNameValuePair;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.slf4j.MDC;
public class MoveToAdapter extends EmissaryClient {
    private static final Logger logger = LoggerFactory.getLogger(MoveToAdapter.class);
    public static final String PLACE_NAME = "mtPlaceName";
    public static final String AGENT_OBJECT = "mtAgentObject";
    public static final String AGENT_SERIAL = "mtAgentSerialized";
    public static final String MOVE_ERROR_COUNT = "agentMoveErrorCount";
    public static final String ITINERARY_ITEM = "agentItineraryItem";
    private static String COOKIE_NAME = "PLACE";
    private static String COOKIE_DOMAIN = "www.example.com";
    private static String COOKIE_PATH = "/";
    private static String VIRTUAL_MOVETO_PROTOCOL = "http";
    private static String VIRTUAL_MOVETO_ADDR = null;
    static {
        reconfigure();
    }
    
    public static void reconfigure() {
        try {
            final Configurator conf = ConfigUtil.getConfigInfo(AgentPool.class);
            VIRTUAL_MOVETO_ADDR = conf.findStringEntry("VIRTUAL_MOVETO_ADDR", null);
            VIRTUAL_MOVETO_PROTOCOL = conf.findStringEntry("VIRTUAL_MOVETO_PROTOCOL", "http");
            COOKIE_NAME = conf.findStringEntry("VIRTUAL_COOKIE_NAME", COOKIE_NAME);
            COOKIE_DOMAIN = conf.findStringEntry("VIRTUAL_COOKIE_DOMAIN", COOKIE_DOMAIN);
            COOKIE_PATH = conf.findStringEntry("VIRTUAL_COOKIE_PATH", COOKIE_PATH);
        }
         catch (IOException e) {
            logger.warn("Cannot read config file, virtual hosting capability not available " + e.getMessage());
        }
        
    }
    
    public MoveToAdapter() {}
    public boolean inboundMoveTo(final HttpServletRequest req) throws RemoteException, NamespaceException {
        final MoveToRequestBean bean = new MoveToRequestBean(req);
        String placeKey = KeyManipulator.getServiceLocation(bean.getPlaceName());
        if (VIRTUAL_MOVETO_ADDR != null) {
            placeKey = KeyManipulator.getServiceClassname(bean.getPlaceName());
        }
        
        final IServiceProviderPlace place = (IServiceProviderPlace) Namespace.lookup(placeKey);
        if (place == null) {
            throw new NamespaceException("Nothing found for " + bean.getPlaceName() + " using " + placeKey + " as the lookup key");
        }
        
        try {
            emissary.pool.PayloadLauncher.launch(bean.getPayload(), place, bean.getErrorCount(), bean.getItineraryItems());
        }
         catch (EmissaryException ex) {
            logger.debug("Cannot launch incoming payload", ex);
            throw new RemoteException("Cannot launch payload", ex);
        }
         finally {
            MDC.remove(MDCConstants.SERVICE_LOCATION);
        }
        
        return true;
    }
    
    public EmissaryResponse outboundMoveTo(final String place, final IMobileAgent agent) {
        String url = null;
        if (VIRTUAL_MOVETO_ADDR != null) {
            url = VIRTUAL_MOVETO_PROTOCOL + "://" + VIRTUAL_MOVETO_ADDR + "/";
        }
         else {
            url = KeyManipulator.getServiceHostURL(place);
        }
        
        url += CONTEXT + "/MoveTo.action";
        final HttpPost method = createHttpPost(url, CONTEXT, "/MoveTo.action");
        method.setHeader("Content-type", "application/x-www-form-urlencoded; charset=ISO-8859-1");
        final List<NameValuePair> nvps = new ArrayList<NameValuePair>();
        nvps.add(new BasicNameValuePair(PLACE_NAME, place));
        nvps.add(new BasicNameValuePair(MOVE_ERROR_COUNT, Integer.toString(agent.getMoveErrorCount())));
        final DirectoryEntry[] iq = agent.getItineraryQueueItems();
        for (int j = 0; j < iq.length; j++) {
            nvps.add(new BasicNameValuePair(ITINERARY_ITEM, iq[j].getKey()));
        }
        
        try {
            final String agentData = PayloadUtil.serializeToString(agent.getPayloadForTransport());
            nvps.add(new BasicNameValuePair(AGENT_SERIAL, agentData));
        }
         catch (IOException iox) {
            logger.error("Cannot serialize agent data", iox);
            BasicHttpResponse response = new BasicHttpResponse(HttpVersion.HTTP_1_1, HttpStatus.SC_INTERNAL_SERVER_ERROR, "Cannot serialize agent data");
            response.setEntity(EntityBuilder.create().setText("").setContentEncoding(MediaType.TEXT_PLAIN).build());
            return new EmissaryResponse(response);
        }
        
        method.setEntity(new UrlEncodedFormEntity(nvps, Charset.forName("8859_1")));
        if (VIRTUAL_MOVETO_ADDR != null) {
            final BasicClientCookie cookie = new BasicClientCookie(COOKIE_NAME, KeyManipulator.getServiceClassname(place));
            cookie.setDomain(VIRTUAL_MOVETO_ADDR.substring(0, VIRTUAL_MOVETO_ADDR.indexOf(":")));
            cookie.setPath(COOKIE_PATH);
            return send(method, cookie);
        }
        
        return send(method);
    }
    
    static class MoveToRequestBean {
        String placeName;
        Object payload;
        int errorCount;
        List<DirectoryEntry> itineraryItems = null;
        MoveToRequestBean() {}
        MoveToRequestBean(final HttpServletRequest req) {
            setPlaceName(RequestUtil.getParameter(req, PLACE_NAME));
            if (getPlaceName() == null) {
                throw new IllegalArgumentException("Missing place name");
            }
            
            final String agentData = RequestUtil.getParameter(req, AGENT_SERIAL);
            if (agentData == null) {
                throw new IllegalArgumentException("Missing serialized agent data");
            }
            
            setPayload(agentData);
            setErrorCount(RequestUtil.getIntParam(req, MOVE_ERROR_COUNT, 0));
            final String[] p = req.getParameterValues(ITINERARY_ITEM);
            if (p != null && p.length > 0) {
                this.itineraryItems = new ArrayList<DirectoryEntry>();
                for (int i = 0; i < p.length; i++) {
                    this.itineraryItems.add(new DirectoryEntry(p[i]));
                }
                
            }
            
        }
        
        void setPayload(final String s) {
            this.payload = PayloadUtil.deserialize(s);
        }
        
        String getPlaceName() {
            return this.placeName;
        }
        
        void setPlaceName(final String argPlaceName) {
            this.placeName = argPlaceName;
        }
        
        Object getPayload() {
            return this.payload;
        }
        
        void setErrorCount(final int c) {
            this.errorCount = c;
        }
        
        int getErrorCount() {
            return this.errorCount;
        }
        
        int getItineraryItemCount() {
            return this.itineraryItems == null ? 0 : this.itineraryItems.size();
        }
        
        @SuppressWarnings("unchecked")
        List<DirectoryEntry> getItineraryItems() {
            return this.itineraryItems == null ? Collections.EMPTY_LIST : this.itineraryItems;
        }
        
    }
    
}


