package com.codename1.impl.android;
import android.app.Activity;
import android.app.PendingIntent;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.graphics.Bitmap;
import android.graphics.drawable.BitmapDrawable;
import android.os.Bundle;
import android.os.PowerManager;
import android.util.Log;
import android.view.Menu;
import android.view.MenuItem;
import android.view.Window;
import android.widget.Toast;
import com.codename1.payment.Product;
import com.codename1.ui.Command;
import com.codename1.ui.Display;
import com.codename1.ui.Form;
import com.codename1.ui.Image;
import com.codename1.ui.Toolbar;
import com.codename1.ui.events.ActionEvent;
import java.util.Vector;
public class CodenameOneActivity extends Activity {
    private Menu menu;
    private boolean nativeMenu = false;
    private IntentResultListener intentResultListener;
    private IntentResultListener defaultResultListener;
    private boolean waitingForResult, waitingForPermissionResult;
    private boolean background;
    private Vector intentResult = new Vector();
    boolean requestForPermission = false;
    private IBillingSupport billingSupport;
    private PowerManager.WakeLock wakeLock;
    protected Object getApp() {
        return null;
    }
    
    boolean wasPurchased(String item) {
        if (billingSupport != null) {
            return billingSupport.wasPurchased(item);
        }
        
        return false;
    }
    
    void purchase(final String item) {
        if (billingSupport != null) billingSupport.purchase(item);
    }
    
    void subscribe(final String item) {
        if (billingSupport != null) billingSupport.subscribe(item);
    }
    
    protected IBillingSupport createBillingSupport() {
        return null;
    }
    
    private IBillingSupport getBillingSupport() {
        if (billingSupport == null) {
            billingSupport = createBillingSupport();
        }
        
        return billingSupport;
    }
    
    protected void onResume() {
        super.onResume();
        AndroidImplementation.setActivity(this);
        AndroidNativeUtil.onResume();
        if (isBillingEnabled() && getBillingSupport() != null) {
            billingSupport.consumeAndAcknowlegePurchases();
        }
        
        background = false;
    }
    
    protected boolean isBillingEnabled() {
        return false;
    }
    
    public Menu getMenu() {
        return menu;
    }
    
    public void enableNativeMenu(boolean enable) {
        nativeMenu = enable;
    }
    
    public void onBackPressed() {
        Display.getInstance().keyPressed(AndroidImplementation.DROID_IMPL_KEY_BACK);
        Display.getInstance().keyReleased(AndroidImplementation.DROID_IMPL_KEY_BACK);
    }
    
    public void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        AndroidImplementation.setActivity(this);
        AndroidNativeUtil.onCreate(savedInstanceState);
        if (android.os.Build.VERSION.SDK_INT >= 11) {
            getWindow().requestFeature(Window.FEATURE_ACTION_BAR);
            getActionBar().hide();
        }
        
        try {
            if (isBillingEnabled()) {
                String k = getBase64EncodedPublicKey();
                if(k.length() == 0){
                    Log.e("Codename One", "android.licenseKey base64 is not configured");
                }
                
                getBillingSupport().initBilling();
            }
            
        }
         catch (Throwable t) {
            System.out.print("This exception is totally valid and here only for debugging purposes");
            t.printStackTrace();
        }
        
    }
    
    protected void onStart() {
        super.onStart();
    }
    
    protected void onStop() {
        AndroidImplementation.clearAppArg();
        super.onStop();
        background = true;
        unlockScreen();
    }
    
    protected void onDestroy() {
        super.onDestroy();
        AndroidNativeUtil.onDestroy();
        if (isBillingEnabled()) {
            getBillingSupport().onDestroy();
        }
        
        unlockScreen();
    }
    
    public boolean onCreateOptionsMenu(Menu menu) {
        super.onCreateOptionsMenu(menu);
        this.menu = menu;
        return nativeMenu && Display.isInitialized() && Display.getInstance().getCurrent() != null;
    }
    
    protected void onSaveInstanceState(Bundle outState) {
        super.onSaveInstanceState(outState);
        AndroidNativeUtil.onSaveInstanceState(outState);
    }
    
    protected void onNewIntent(Intent intent) {
        super.onNewIntent(intent);
        setIntent(intent);
    }
    
    public void onLowMemory() {
        super.onLowMemory();
        AndroidNativeUtil.onLowMemory();
    }
    
    protected void onPause() {
        if (InPlaceEditView.isEditing()) {
            AndroidImplementation.stopEditing(true);
        }
        
        super.onPause();
        AndroidNativeUtil.onPause();
    }
    
    public boolean onPrepareOptionsMenu(Menu menu) {
        super.onPrepareOptionsMenu(menu);
        menu.clear();
        try {
            Form currentForm = Display.getInstance().getCurrent();
            if (currentForm == null || Toolbar.isGlobalToolbar()) {
                return false;
            }
            
            int numCommands = currentForm.getCommandCount();
            if (numCommands == 0) {
                return false;
            }
            
            for (int n = 0; n < numCommands; n++) {
                Command command = currentForm.getCommand(n);
                if (command != null) {
                    String txt = currentForm.getUIManager().localize(command.getCommandName(), command.getCommandName());
                    MenuItem item = menu.add(Menu.NONE, n, Menu.NONE, txt);
                    Image icon = command.getIcon();
                    if (icon != null) {
                        Bitmap b = (Bitmap) icon.getImage();
                        BitmapDrawable d = new BitmapDrawable(getResources(), b);
                        item.setIcon(d);
                    }
                    
                    if (!command.isEnabled()) {
                        item.setEnabled(false);
                    }
                    
                    if (android.os.Build.VERSION.SDK_INT >= 11 && command.getClientProperty("android:showAsAction") != null) {
                        String androidShowAsAction = command.getClientProperty("android:showAsAction").toString();
                        if (androidShowAsAction.equalsIgnoreCase("ifRoom")) {
                            item.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM);
                        }
                         else if (androidShowAsAction.equalsIgnoreCase("never")) {
                            item.setShowAsAction(MenuItem.SHOW_AS_ACTION_NEVER);
                        }
                         else if (androidShowAsAction.equalsIgnoreCase("withText")) {
                            item.setShowAsAction(MenuItem.SHOW_AS_ACTION_IF_ROOM | MenuItem.SHOW_AS_ACTION_WITH_TEXT);
                        }
                         else if (androidShowAsAction.equalsIgnoreCase("always")) {
                            item.setShowAsAction(MenuItem.SHOW_AS_ACTION_ALWAYS);
                        }
                         else if (android.os.Build.VERSION.SDK_INT >= 14 && androidShowAsAction.equalsIgnoreCase("collapseActionView")) {
                            item.setShowAsAction(8); 
                        }
                        
                    }
                    
                }
                
            }
            
        }
         catch (Throwable t) {
        }
        
        return nativeMenu;
    }
    
    public boolean onOptionsItemSelected(MenuItem item) {
        super.onOptionsItemSelected(item);
        final Form currentForm = Display.getInstance().getCurrent();
        if (currentForm == null) {
            return false;
        }
        
        Command cmd = null;
        final boolean[] tmpProp = new boolean[1];
        if (item.getItemId() == android.R.id.home) {
            cmd = currentForm.getBackCommand();
            if (cmd == null) {
                return false;
            }
            
            cmd.putClientProperty("source", "ActionBar");
            tmpProp[0] = true;
        }
        
        int commandIndex = item.getItemId();
        if (cmd == null) {
            cmd = currentForm.getCommand(commandIndex);
        }
        
        final Command command = cmd;
        final ActionEvent actionEvent = new ActionEvent(command);
        AndroidImplementation.stopEditing();
        Display.getInstance().callSerially(new Runnable() {
            public void run() {
                try {
                    currentForm.dispatchCommand(command, actionEvent);
                    if (tmpProp[0]) {
                        command.putClientProperty("source", null);
                    }
                    
                }
                 catch (Throwable e) {
                    Log.e("CodenameOneActivity.onOptionsItemSelected", e.toString() + Log.getStackTraceString(e));
                }
                
            }
            
        }
        
);
        return true;
    }
    
    protected void fireIntentResult() {
        if (intentResult.size() > 0) {
            final IntentResult response = (IntentResult) intentResult.get(0);
            if (intentResultListener != null && response != null) {
                Display.getInstance().callSerially(new Runnable() {
                    public void run() {
                        intentResultListener.onActivityResult(response.getRequestCode(), response.getResultCode(), response.getData());
                    }
                    
                }
                
);
            }
            
        }
        
    }
    
    protected void onActivityResult(int requestCode, int resultCode, Intent data) {
        IntentResult response = new IntentResult(requestCode, resultCode, data);
        intentResult.add(response);
    }
    
    public void setIntentResultListener(IntentResultListener l) {
        if(waitingForResult){
            return;
        }
        
        this.intentResultListener = l;
        if (l != null && l != defaultResultListener) {
            waitingForResult = true;
        }
        
    }
    
    public void setDefaultIntentResultListener(IntentResultListener l) {
        this.defaultResultListener = l;
    }
    
    public void restoreIntentResultListener() {
        waitingForResult = false;
        setIntentResultListener(defaultResultListener);
    }
    
    public void startActivityForResult(Intent intent, int requestCode) {
        Bundle extra = intent.getExtras();
        if(extra != null && extra.containsKey("WaitForResult") && !extra.getBoolean("WaitForResult")){
            waitingForResult = false;            
        }
        else{
            waitingForResult = true;
        }
        
        intentResult = new Vector();
        if (InPlaceEditView.isEditing()) {
            AndroidImplementation.stopEditing(true);
        }
        
        super.startActivityForResult(intent, requestCode);
    }
    
    public void startActivity(Intent intent) {
        Bundle extra = intent.getExtras();
        if(extra != null && extra.containsKey("WaitForResult") && !extra.getBoolean("WaitForResult")){
            waitingForResult = false;            
        }
        else{
            waitingForResult = true;
        }
        
        if (InPlaceEditView.isEditing()) {
            AndroidImplementation.stopEditing(true);
        }
        
        super.startActivity(intent);
    }
    
    public boolean isWaitingForResult() {
        return waitingForResult;
    }
    
    protected void setWaitingForResult(boolean waitingForResult) {
        this.waitingForResult = waitingForResult;
    }
    
    public boolean isBackground() {
        return background;
    }
    
    public void registerForPush(String key) {
        Intent registrationIntent = new Intent("com.google.android.c2dm.intent.REGISTER");
        registrationIntent.setPackage("com.google.android.gms");
        registrationIntent.putExtra("app", PendingIntent.getBroadcast(this, 0, new Intent(), 0)); 
        registrationIntent.putExtra("sender", key);
        startService(registrationIntent);
    }
    
    public void stopReceivingPush() {
        Intent unregIntent = new Intent("com.google.android.c2dm.intent.UNREGISTER");
        unregIntent.setPackage("com.google.android.gms");
        unregIntent.putExtra("app", PendingIntent.getBroadcast(this, 0, new Intent(), 0));
        startService(unregIntent);
    }
    
    public void lockScreen() {
        unlockScreen();
        try {
            android.os.PowerManager pm = (android.os.PowerManager) getSystemService(android.content.Context.POWER_SERVICE);
            wakeLock = pm.newWakeLock(android.os.PowerManager.SCREEN_BRIGHT_WAKE_LOCK | android.os.PowerManager.ACQUIRE_CAUSES_WAKEUP | android.os.PowerManager.ON_AFTER_RELEASE, "Codename One");
        }
         catch (Exception excp) {
            excp.printStackTrace();
        }
        
        if (wakeLock != null) {
            wakeLock.acquire();
        }
        
    }
    
    public void unlockScreen() {
        if (wakeLock != null && wakeLock.isHeld()) {
            wakeLock.release();
            wakeLock = null;
        }
        
    }
    
    public String getBase64EncodedPublicKey() {
        String key = Display.getInstance().getProperty("android.licenseKey", "");        
        return key;
    }
    
    String getPayload() {
        return "";
    }
    
    public boolean isConsumable(String item) {
        if (getBillingSupport() != null) {
            return getBillingSupport().isConsumable(item);
        }
        
        return false;
    }
    
    Product[] getProducts(String[] skus){
        if (getBillingSupport() != null) {
            return getBillingSupport().getProducts(skus, false);
        }
        
        return new Product[0];
    }
    
    public void setRequestForPermission(boolean requestForPermission) {
        this.requestForPermission = requestForPermission;
    }
    
    public void setWaitingForPermissionResult(boolean waitingForPermissionResult) {
        this.waitingForPermissionResult = waitingForPermissionResult;
    }
    
    public boolean isWaitingForPermissionResult() {
        return waitingForPermissionResult;
    }
    
    public boolean isRequestForPermission() {
        return requestForPermission;
    }
    
    public void onRequestPermissionsResult(int requestCode, String[] permissions, int[] grantResults) {
        if(grantResults != null || grantResults.length == 0) {
            requestForPermission = false;
            return;
        }
        
        if (grantResults[0] == PackageManager.PERMISSION_GRANTED) {
            Log.i("Codename One", "PERMISSION_GRANTED");
        }
         else {
            Toast.makeText(this, "Permission is denied", Toast.LENGTH_SHORT).show();
        }
        
        requestForPermission = false;
    }
    
    public boolean hasUI(){
        return true;
    }
    
}


