package com.codename1.location;
import android.Manifest;
import android.app.PendingIntent;
import android.content.Context;
import android.content.Intent;
import android.content.pm.PackageManager;
import android.net.Uri;
import android.os.Build;
import android.os.Bundle;
import android.os.Handler;
import android.os.Looper;
import android.os.Parcel;
import android.os.Parcelable;
import android.support.annotation.NonNull;
import android.support.annotation.RequiresApi;
import android.support.v4.app.ActivityCompat;
import com.codename1.impl.android.AndroidImplementation;
import com.codename1.impl.android.AndroidNativeUtil;
import com.codename1.impl.android.LifecycleListener;
import com.codename1.impl.android.PlayServices;
import com.codename1.io.Log;
import com.codename1.ui.Display;
import com.google.android.gms.common.ConnectionResult;
import com.google.android.gms.common.api.GoogleApiClient;
import com.google.android.gms.location.*;
import com.google.android.gms.location.Geofence;
import com.google.android.gms.location.LocationRequest;
import com.google.android.gms.tasks.OnFailureListener;
import com.google.android.gms.tasks.OnSuccessListener;
import java.io.IOException;
import java.util.ArrayList;
public class AndroidLocationPlayServiceManager extends com.codename1.location.LocationManager implements GoogleApiClient.ConnectionCallbacks, GoogleApiClient.OnConnectionFailedListener, com.google.android.gms.location.LocationListener, LifecycleListener {
    static class ParcelableUtil {
        public static byte[] marshall(Parcelable parceable) {
            Parcel parcel = Parcel.obtain();
            parceable.writeToParcel(parcel, 0);
            byte[] bytes = parcel.marshall();
            parcel.recycle();
            return bytes;
        }
        
        public static Parcel unmarshall(byte[] bytes) {
            Parcel parcel = Parcel.obtain();
            parcel.unmarshall(bytes, 0, bytes.length);
            parcel.setDataPosition(0); 
            return parcel;
        }
        
        public static <T> T unmarshall(byte[] bytes, Parcelable.Creator<T> creator) {
            Parcel parcel = unmarshall(bytes);
            T result = creator.createFromParcel(parcel);
            parcel.recycle();
            return result;
        }
        
    }
    
    public final LocationCallback callback = new LocationCallback() {         public void onLocationResult(LocationResult var1) { AndroidLocationPlayServiceManager.this.onLocationChanged(var1.getLastLocation());
        }
        
        public void onLocationAvailability(LocationAvailability var1) {
        }
        
    };
    public static AndroidLocationPlayServiceManager inMemoryBackgroundLocationListener;
    private GoogleApiClient mGoogleApiClient;
    private GeofencingClient geofencingClient;
    private LocationRequest locationRequest;
    private static AndroidLocationPlayServiceManager instance = new AndroidLocationPlayServiceManager();
    public AndroidLocationPlayServiceManager() {
    }
    
    public static AndroidLocationPlayServiceManager getInstance() {
        return instance;
    }
    
    public Location getCurrentLocation() throws IOException {
        Location l = getLastKnownLocation();
        if (l == null) {
            throw new IOException("cannot retrieve location try later");
        }
        
        return l;
    }
    
    public Location getLastKnownLocation() {
        while (!getmGoogleApiClient().isConnected()) {
            try {
                Thread.sleep(300);
            }
             catch (Exception ex) {
            }
            
        }
        
        android.location.Location location = PlayServices.getInstance().getLastKnownLocation(getmGoogleApiClient());
        if (location != null) {
            return AndroidLocationManager.convert(location);
        }
        
        return null;
    }
    
    protected void bindListener() {
        final Class bgListenerClass = getBackgroundLocationListener();
        Thread t = new Thread(new Runnable() { 

            public void run() {
                while (!getmGoogleApiClient().isConnected()) {
                    try {
                        Thread.sleep(300);
                    }
                     catch (Exception ex) {
                    }
                    
                }
                
                Handler mHandler = new Handler(Looper.getMainLooper());
                mHandler.post(new Runnable() {
                    public void run() {
                        LocationRequest r = locationRequest;
                        com.codename1.location.LocationRequest request = getRequest();
                        if (request != null) {
                            LocationRequest lr = LocationRequest.create();
                            if (request.getPriority() == com.codename1.location.LocationRequest.PRIORITY_HIGH_ACCUARCY) {
                                lr.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);
                            }
                             else if (request.getPriority() == com.codename1.location.LocationRequest.PRIORITY_MEDIUM_ACCUARCY) {
                                lr.setPriority(LocationRequest.PRIORITY_BALANCED_POWER_ACCURACY);
                            }
                             else {
                                lr.setPriority(LocationRequest.PRIORITY_LOW_POWER);
                            }
                            
                            lr.setInterval(request.getInterval());
                            r = lr;
                        }
                        
                        if (AndroidImplementation.getActivity() == null) {
                            Context context = AndroidNativeUtil.getContext();
                            Intent intent = new Intent(context, BackgroundLocationHandler.class);
                            if (bgListenerClass != null) {
                                intent.setData(Uri.parse("http://codenameone.com/a?" + bgListenerClass.getName()));
                            }
                            
                            PendingIntent pendingIntent = PendingIntent.getService(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT);
                            inMemoryBackgroundLocationListener = AndroidLocationPlayServiceManager.this;
                            requestLocationUpdates(context, r, pendingIntent);
                        }
                         else {
                            requestLocationUpdates(AndroidNativeUtil.getContext(), r, AndroidLocationPlayServiceManager.this);
                        }
                        
                    }
                    
                }
                
);
            }
            
        }
        
);
        t.setUncaughtExceptionHandler(AndroidImplementation.exceptionHandler);
        t.start();
    }
    
    private void requestLocationUpdates(Context context, LocationRequest req, PendingIntent pendingIntent) {
        PlayServices.getInstance().requestLocationUpdates(getmGoogleApiClient(), context, req, pendingIntent);
    }
    
    private PendingIntent createBackgroundPendingIntent() {
        return createBackgroundPendingIntent(false);
    }
    
    private PendingIntent createBackgroundPendingIntent(boolean forceService) {
        Context context = AndroidNativeUtil.getContext().getApplicationContext();
        final Class bgListenerClass = getBackgroundLocationListener();
        if (bgListenerClass == null) {
            return null;
        }
        
        if (!forceService && Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            Intent intent = new Intent(context, BackgroundLocationBroadcastReceiver.class);
            intent.setData(Uri.parse("http://codenameone.com/a?" + bgListenerClass.getName()));
            intent.setAction(BackgroundLocationBroadcastReceiver.ACTION_PROCESS_UPDATES);
            PendingIntent pendingIntent = PendingIntent.getBroadcast(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT);
            return pendingIntent;
        }
         else {
            Intent intent = new Intent(context, BackgroundLocationHandler.class);
            intent.setData(Uri.parse("http://codenameone.com/a?" + bgListenerClass.getName()));
            PendingIntent pendingIntent = PendingIntent.getService(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT);
            return pendingIntent;
        }
        
    }
    
    static android.location.Location extractLocationFromIntent(Intent intent) {
        if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            LocationResult locationResult = LocationResult.extractResult(intent);
            if (locationResult == null) {
                return null;
            }
            
            return locationResult.getLastLocation();
        }
         else {
            return intent.getParcelableExtra(FusedLocationProviderApi.KEY_LOCATION_CHANGED);
        }
        
    }
    
    private void requestLocationUpdates(Context context, LocationRequest req, AndroidLocationPlayServiceManager mgr) {
        PlayServices.getInstance().requestLocationUpdates(getmGoogleApiClient(), context, req, mgr);
    }
    
    private void removeLocationUpdates(Context context, AndroidLocationPlayServiceManager mgr) {
        PlayServices.getInstance().removeLocationUpdates(getmGoogleApiClient(), context, mgr);
    }
    
    private void removeLocationUpdates(Context context, PendingIntent pendingIntent) {
        PlayServices.getInstance().removeLocationUpdates(getmGoogleApiClient(), context, pendingIntent);
    }
    
    protected void clearListener() {
        final Class bgListenerClass = getBackgroundLocationListener();
        Thread t = new Thread(new Runnable() { 

            public void run() {
                while (!getmGoogleApiClient().isConnected()) {
                    try {
                        Thread.sleep(300);
                    }
                     catch (Exception ex) {
                    }
                    
                }
                
                Handler mHandler = new Handler(Looper.getMainLooper());
                mHandler.post(new Runnable() {
                    public void run() {
                        if (inMemoryBackgroundLocationListener != null) {
                            Context context = AndroidNativeUtil.getContext();
                            Intent intent = new Intent(context, BackgroundLocationHandler.class);
                            if (bgListenerClass != null) {
                                intent.putExtra("backgroundClass", bgListenerClass.getName());
                            }
                            
                            PendingIntent pendingIntent = PendingIntent.getService(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT);
                            removeLocationUpdates(context, pendingIntent);
                            inMemoryBackgroundLocationListener = null;
                        }
                         else {
                            removeLocationUpdates(AndroidNativeUtil.getContext(), AndroidLocationPlayServiceManager.this);
                        }
                        
                    }
                    
                }
                
);
            }
            
        }
        
);
        t.setUncaughtExceptionHandler(AndroidImplementation.exceptionHandler);
        t.start();
    }
    
    protected void bindBackgroundListener() {
        if (!checkBackgroundLocationPermission()) {
            return;
        }
        
        final Class bgListenerClass = getBackgroundLocationListener();
        if (bgListenerClass == null) {
            return;
        }
        
        Thread t = new Thread(new Runnable() { 

            public void run() {
                while (!getmGoogleApiClient().isConnected()) {
                    try {
                        Thread.sleep(300);
                    }
                     catch (Exception ex) {
                    }
                    
                }
                
                Handler mHandler = new Handler(Looper.getMainLooper());
                mHandler.post(new Runnable() {
                    public void run() {
                        LocationRequest req = LocationRequest.create();
                        setupBackgroundLocationRequest(req);
                        Context context = AndroidNativeUtil.getContext().getApplicationContext();
                        PendingIntent pendingIntent = createBackgroundPendingIntent();
                        requestLocationUpdates(context, req, pendingIntent);
                    }
                    
                }
                
);
            }
            
        }
        
);
        t.setUncaughtExceptionHandler(AndroidImplementation.exceptionHandler);
        t.start();
    }
    
    private void setupBackgroundLocationRequest(LocationRequest req) {
        Display d = Display.getInstance();
        String priorityStr = d.getProperty("android.backgroundLocation.priority", "PRIORITY_BALANCED_POWER_ACCURACY");
        String fastestIntervalStr = d.getProperty("android.backgroundLocation.fastestInterval", "5000");
        String intervalStr = d.getProperty("android.backgroundLocation.interval", "10000");
        String smallestDisplacementStr = d.getProperty("android.backgroundLocation.smallestDisplacement", "50");
        int priority = LocationRequest.PRIORITY_BALANCED_POWER_ACCURACY;
        if ("PRIORITY_HIGH_ACCURACY".equals(priorityStr)) {
            priority = LocationRequest.PRIORITY_HIGH_ACCURACY;
        }
         else if ("PRIORITY_LOW_POWER".equals(priorityStr)) {
            priority = LocationRequest.PRIORITY_LOW_POWER;
        }
         else if ("PRIORITY_NO_POWER".equals(priorityStr)) {
            priority = LocationRequest.PRIORITY_NO_POWER;
        }
        
        long interval = Long.parseLong(intervalStr);
        long fastestInterval = Long.parseLong(fastestIntervalStr);
        int smallestDisplacement = Integer.parseInt(smallestDisplacementStr);
        req.setPriority(priority) .setFastestInterval(fastestInterval) .setInterval(interval) .setSmallestDisplacement(smallestDisplacement);
    }
    
    protected void clearBackgroundListener() {
        final Class bgListenerClass = getBackgroundLocationListener();
        if (bgListenerClass == null) {
            return;
        }
        
        Thread t = new Thread(new Runnable() { 

            public void run() {
                while (!getmGoogleApiClient().isConnected()) {
                    try {
                        Thread.sleep(300);
                    }
                     catch (Exception ex) {
                    }
                    
                }
                
                Handler mHandler = new Handler(Looper.getMainLooper());
                mHandler.post(new Runnable() {
                    public void run() {
                        Context context = AndroidNativeUtil.getContext().getApplicationContext();
                        PendingIntent pendingIntent = createBackgroundPendingIntent();
                        removeLocationUpdates(context, pendingIntent);
                    }
                    
                }
                
);
            }
            
        }
        
);
        t.setUncaughtExceptionHandler(AndroidImplementation.exceptionHandler);
        t.start();
    }
    
    public void onLocationChanged(final android.location.Location loc) {
        synchronized (this) {
            final com.codename1.location.LocationListener l = getLocationListener();
            if (l != null) {
                Display.getInstance().callSerially(new Runnable() {
                    public void run() {
                        Location lastLocation = AndroidLocationManager.convert(loc);
                        l.locationUpdated(lastLocation);
                    }
                    
                }
                
);
            }
            
        }
        
    }
    
    public void onConnected(Bundle bundle) {
        locationRequest = LocationRequest.create();
        locationRequest.setPriority(LocationRequest.PRIORITY_HIGH_ACCURACY);
        locationRequest.setInterval(1000); 
        setLocationManagerStatus(AVAILABLE);
    }
    
    public void onConnectionSuspended(int i) {
        setLocationManagerStatus(TEMPORARILY_UNAVAILABLE);
    }
    
    public void onConnectionFailed(ConnectionResult cr) {
        setLocationManagerStatus(OUT_OF_SERVICE);
    }
    
    private void setLocationManagerStatus(final int status) {
        int current = getStatus();
        if (current != status) {
            setStatus(status);
            synchronized (this) {
                Display.getInstance().callSerially(new Runnable() {
                    public void run() {
                        com.codename1.location.LocationListener l = getLocationListener();
                        if (l != null) {
                            l.providerStateChanged(status);
                        }
                        
                    }
                    
                }
                
);
            }
            
        }
        
    }
    
    private PendingIntent geofencePendingIntent;
    private PendingIntent createGeofencePendingIntent(Class geofenceListenerClass, com.codename1.location.Geofence gf, boolean forceService) {
        Context context = AndroidNativeUtil.getContext().getApplicationContext();
        if (!forceService && Build.VERSION.SDK_INT >= Build.VERSION_CODES.O) {
            if (geofencePendingIntent != null) {
                return geofencePendingIntent;
            }
            
            Intent intent = new Intent(context, BackgroundLocationBroadcastReceiver.class);
            intent.setAction(BackgroundLocationBroadcastReceiver.ACTION_PROCESS_GEOFENCE_TRANSITIONS);
            intent.setData(Uri.parse("http://codenameone.com/a?" + geofenceListenerClass.getName()));
            geofencePendingIntent = PendingIntent.getBroadcast(AndroidNativeUtil.getContext().getApplicationContext(), 0, intent, PendingIntent.FLAG_UPDATE_CURRENT);
            return geofencePendingIntent;
        }
         else {
            Intent intent = new Intent(context, GeofenceHandler.class);
            intent.putExtra("geofenceClass", geofenceListenerClass.getName());
            intent.putExtra("geofenceID", gf.getId());
            PendingIntent pendingIntent = PendingIntent.getService(context, 0, intent, PendingIntent.FLAG_UPDATE_CURRENT);
            return pendingIntent;
        }
        
    }
    
    @RequiresApi(api = 29)
    private boolean checkBackgroundLocationPermission() {
        if (!AndroidNativeUtil.checkForPermission("android.permission.ACCESS_BACKGROUND_LOCATION", "This is required to get the location")) {
            return false;
        }
        
        return true;
    }
    
    public void addGeoFencing(final Class GeofenceListenerClass, final com.codename1.location.Geofence gf) {
        boolean fineLocationAllowed = AndroidNativeUtil.checkForPermission(Manifest.permission.ACCESS_FINE_LOCATION, "This is required to get location");
        if (fineLocationAllowed && android.os.Build.VERSION.SDK_INT >= 29) {
            if (!checkBackgroundLocationPermission()) {
                return;
            }
            
        }
         else if (!fineLocationAllowed) {
            fineLocationAllowed = AndroidNativeUtil.checkForPermission(Manifest.permission.ACCESS_FINE_LOCATION, "This is required to get the location");
        }
        
        if (!fineLocationAllowed) {
            Log.e(new RuntimeException("Permission denied for geofence"));
            return;
        }
        
        Thread t = new Thread(new Runnable() { 

            public void run() {
                while (!getmGoogleApiClient().isConnected()) {
                    try {
                        Thread.sleep(300);
                    }
                     catch (Exception ex) {
                    }
                    
                }
                
                Handler mHandler = new Handler(Looper.getMainLooper());
                mHandler.post(new Runnable() {
                    public void run() {
                        Context context = AndroidNativeUtil.getContext().getApplicationContext();
                        PendingIntent pendingIntent = createGeofencePendingIntent(GeofenceListenerClass, gf, false);
                        final ArrayList<Geofence> geofences = new ArrayList<Geofence>();
                        geofences.add(new Geofence.Builder() .setRequestId(gf.getId()) .setCircularRegion(gf.getLoc().getLatitude(), gf.getLoc().getLongitude(), gf.getRadius()) .setTransitionTypes(Geofence.GEOFENCE_TRANSITION_ENTER | Geofence.GEOFENCE_TRANSITION_EXIT) .setExpirationDuration(gf.getExpiration() > 0 ? gf.getExpiration() : Geofence.NEVER_EXPIRE) .build());
                        GeofencingRequest.Builder builder = new GeofencingRequest.Builder();
                        builder.setInitialTrigger(GeofencingRequest.INITIAL_TRIGGER_ENTER);
                        builder.addGeofences(geofences);
                        if (!AndroidNativeUtil.checkForPermission(Manifest.permission.ACCESS_FINE_LOCATION, "Fine location permission required")) {
                            System.out.println("No permission");
                            return;
                        }
                        
                        geofencingClient = geofencingClient == null ? LocationServices.getGeofencingClient(AndroidNativeUtil.getContext().getApplicationContext()) : geofencingClient;
                        geofencingClient.addGeofences(builder.build(), pendingIntent) .addOnSuccessListener(AndroidNativeUtil.getActivity(), new OnSuccessListener<Void>() {
                                    public void onSuccess(Void aVoid) {
                                    }
                                    
                                }
) .addOnFailureListener(AndroidNativeUtil.getActivity(), new OnFailureListener() {
                                    public void onFailure(@NonNull Exception e) {
                                        com.codename1.io.Log.e(e);
                                    }
                                    
                                }
                                
);
                    }
                    
                }
                
);
            }
            
        }
        
);
        t.setUncaughtExceptionHandler(AndroidImplementation.exceptionHandler);
        t.start();
    }
    
    public void removeGeoFencing(final String id) {
        Thread t = new Thread(new Runnable() { 

            public void run() {
                while (!getmGoogleApiClient().isConnected()) {
                    try {
                        Thread.sleep(300);
                    }
                     catch (Exception ex) {
                    }
                    
                }
                
                Handler mHandler = new Handler(Looper.getMainLooper());
                mHandler.post(new Runnable() {
                    public void run() {
                        ArrayList<String> ids = new ArrayList<String>();
                        ids.add(id);
                        geofencingClient = geofencingClient == null ? LocationServices.getGeofencingClient(AndroidNativeUtil.getContext().getApplicationContext()) : geofencingClient;
                        geofencingClient.removeGeofences(ids);
                    }
                    
                }
                
);
            }
            
        }
        
);
        t.setUncaughtExceptionHandler(AndroidImplementation.exceptionHandler);
        t.start();
    }
    
    public void onCreate(Bundle savedInstanceState) {
    }
    
    public void onResume() {
        getmGoogleApiClient(); 
    }
    
    public void onPause() {
    }
    
    public void onDestroy() {
        if (mGoogleApiClient != null && mGoogleApiClient.isConnected()) {
            mGoogleApiClient.disconnect();
        }
        
        if (mGoogleApiClient != null) {
            mGoogleApiClient = null;
        }
        
    }
    
    public void onSaveInstanceState(Bundle b) {
    }
    
    public void onLowMemory() {
    }
    
    public boolean isGPSDetectionSupported() {
        return true;
    }
    
    public boolean isBackgroundLocationSupported() {
        return true;
    }
    
    public boolean isGeofenceSupported() {
        return true;
    }
    
    public boolean isGPSEnabled() {
        Context context = AndroidNativeUtil.getContext();
        android.location.LocationManager locationManager = (android.location.LocationManager) context.getSystemService(Context.LOCATION_SERVICE);
        return locationManager.isProviderEnabled(android.location.LocationManager.GPS_PROVIDER);
    }
    
    private GoogleApiClient getmGoogleApiClient() {
        if (mGoogleApiClient == null) {
            mGoogleApiClient = new GoogleApiClient.Builder(AndroidNativeUtil.getContext()) .addApi(LocationServices.API) .addConnectionCallbacks(this) .addOnConnectionFailedListener(this) .build();
            if (!mGoogleApiClient.isConnected()) {
                mGoogleApiClient.connect();
            }
            
        }
        
        return mGoogleApiClient;
    }
    
    private void setmGoogleApiClient(GoogleApiClient mGoogleApiClient) {
        this.mGoogleApiClient = mGoogleApiClient;
    }
    
}

