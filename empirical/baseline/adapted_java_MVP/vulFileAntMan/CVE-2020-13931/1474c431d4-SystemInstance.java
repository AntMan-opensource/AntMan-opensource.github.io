package org.apache.openejb.loader;
import org.apache.openejb.loader.event.ComponentAdded;
import org.apache.openejb.loader.event.ComponentRemoved;
import org.apache.openejb.loader.provisining.ProvisioningResolver;
import org.apache.openejb.observer.ObserverManager;
import java.io.File;
import java.io.IOException;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;
import java.util.concurrent.atomic.AtomicReference;
public final class SystemInstance {
    private static final String PROFILE_PROP = "openejb.profile";
    private static final String DEFAULT_PROFILE = "development";
    private final long startTime = System.currentTimeMillis();
    private final Properties internalProperties = new Properties(System.getProperties());
    private final Options options;
    private final FileUtils home;
    private final FileUtils base;
    private final ClassLoader classLoader;
    private final Map<Class, Object> components;
    private final ClassPath classPath;
    private final ObserverManager observerManager = new ObserverManager();
    private SystemInstance(final Properties properties) {
        this.components = new HashMap<Class, Object>();
        for (final String key : System.getProperties().stringPropertyNames()) {
            if (key.startsWith("sun.")) {
                continue;
            }
            
            if (key.startsWith("os.")) {
                continue;
            }
            
            if (key.startsWith("user.")) {
                continue;
            }
            
            if (key.startsWith("awt.")) {
                continue;
            }
            
            if (key.startsWith("java.")) {
                final String pkg = key.substring("java.".length());
                if (pkg.startsWith("vm.")) {
                    continue;
                }
                
                if (pkg.startsWith("runtime.")) {
                    continue;
                }
                
                if (pkg.startsWith("awt.")) {
                    continue;
                }
                
                if (pkg.startsWith("specification.")) {
                    continue;
                }
                
                if (pkg.startsWith("class.")) {
                    continue;
                }
                
                if (pkg.startsWith("library.")) {
                    continue;
                }
                
                if (pkg.startsWith("ext.")) {
                    continue;
                }
                
                if (pkg.startsWith("vendor.")) {
                    continue;
                }
                
                if (pkg.startsWith("endorsed.")) {
                    continue;
                }
                
            }
            
            final String value = System.getProperty(key);
            if (value != null) {
                this.internalProperties.put(key, value);
            }
            
        }
        
        this.internalProperties.putAll(properties);
        this.options = new Options(internalProperties, new Options(System.getProperties()));
        this.home = new FileUtils("openejb.home", "user.dir", this.internalProperties);
        this.base = new FileUtils("openejb.base", "openejb.home", this.internalProperties);
        this.classPath = ClassPathFactory.createClassPath(this.internalProperties.getProperty("openejb.loader", "context"));
        this.classLoader = classPath.getClassLoader();
        final String homeDirCanonicalPath;
        final String baseDirCanonicalPath;
        try {
            homeDirCanonicalPath = home.getDirectory().getCanonicalPath();
            baseDirCanonicalPath = base.getDirectory().getCanonicalPath();
        }
         catch (final IOException e) {
            throw new LoaderRuntimeException("Failed to create default instance of SystemInstance", e);
        }
        
        this.internalProperties.setProperty("openejb.home", homeDirCanonicalPath);
        this.internalProperties.setProperty("openejb.base", baseDirCanonicalPath);
        System.setProperty("derby.system.home", System.getProperty("derby.system.home", baseDirCanonicalPath));
    }
    
    public <E> E fireEvent(final E event) {
        return observerManager.fireEvent(event);
    }
    
    public boolean addObserver(final Object observer) {
        return observerManager.addObserver(observer);
    }
    
    public boolean removeObserver(final Object observer) {
        return observerManager.removeObserver(observer);
    }
    
    public long getStartTime() {
        return startTime;
    }
    
    public Options getOptions() {
        return options;
    }
    
    public Properties getProperties() {
        return internalProperties;
    }
    
    public String getProperty(final String key) {
        return internalProperties.getProperty(key);
    }
    
    public String getProperty(final String key, final String defaultValue) {
        return internalProperties.getProperty(key, defaultValue);
    }
    
    public Object setProperty(final String key, final String value) {
        return setProperty(key, value, false);
    }
    
    public Object setProperty(final String key, final String value, final boolean isExternalProperty) {
        if (isExternalProperty) {
            System.setProperty(key, value);
        }
        
        return internalProperties.setProperty(key, value);
    }
    
    public FileUtils getHome() {
        if (!isInitialized()) {
            return new FileUtils("openejb.home", "user.dir", System.getProperties());
        }
        
        return home;
    }
    
    public FileUtils getBase() {
        if (!isInitialized()) {
            return new FileUtils("openejb.base", "openejb.home", System.getProperties());
        }
        
        return base;
    }
    
    public ClassPath getClassPath() {
        return classPath;
    }
    
    public ClassLoader getClassLoader() {
        return classLoader;
    }
    
    public <T> T getComponent(final Class<T> type) {
        final T component = (T) components.get(type);
        if (component != null) {
            return component;
        }
        
        final String classname = getProperty(type.getName());
        if (classname != null) {
            try {
                final T instance = type.cast(Thread.currentThread().getContextClassLoader() .loadClass(classname).newInstance());
                components.put(type, instance);
                return instance;
            }
             catch (final Throwable e) {
                System.err.println("Failed to load class: " + classname);
            }
            
        }
        
        return null;
    }
    
    public <T> T removeComponent(final Class<T> type) {
        final T component = (T) components.remove(type);
        if (component != null) {
            fireEvent(new ComponentRemoved(type, component));
        }
        
        return component;
    }
    
    public <T> T setComponent(final Class<T> type, final T value) {
        final T removed = (T) components.put(type, value);
        if (removed != null) {
            fireEvent(new ComponentRemoved(type, value));
        }
        
        if (value != null) {
            fireEvent(new ComponentAdded(type, value));
        }
        
        return removed;
    }
    
    private static final AtomicReference<SystemInstance> system = new AtomicReference<SystemInstance>();
    static {
        reset();
    }
    
    private static boolean initialized;
    public static boolean isInitialized() {
        return initialized;
    }
    
    public static synchronized void reset() {
        try {
            System.clearProperty("openejb.loader");
            system.set(new SystemInstance(new Properties())); 
            initialized = false;
        }
         catch (final Exception e) {
            throw new LoaderRuntimeException("Failed to create default instance of SystemInstance", e);
        }
        
    }
    
    public static synchronized void init(final Properties properties) throws Exception {
        if (initialized) {
            return;
        }
        
        system.set(new SystemInstance(properties));
        readSystemProperties(get().currentProfile());
        readSystemProperties();
        readUserSystemProperties();
        System.getProperties().putAll(system.get().getProperties());
        initialized = true;
        get().setProperty("openejb.profile.custom", Boolean.toString(!get().isDefaultProfile()));
        initDefaultComponents();
    }
    
    private static void initDefaultComponents() {
        system.get().components.put(ProvisioningResolver.class, new ProvisioningResolver());
    }
    
    private static void readUserSystemProperties() {
        final File file = new File(System.getProperty("user.home"), ".openejb/system.properties");
        addSystemProperties(file);
    }
    
    public File getConf(final String subPath) {
        File conf = null;
        final FileUtils base = system.get().getBase();
        try {
            conf = base.getDirectory("conf");
        }
         catch (final IOException e) {
        }
        
        if (conf == null || !conf.exists()) {
            try {
                conf = base.getDirectory("etc");
            }
             catch (final IOException e) {
            }
            
        }
        
        if (conf == null || !conf.exists()) {
            return new File(base.getDirectory(), "conf");
        }
        
        if (subPath == null) {
            return conf;
        }
        
        return new File(conf, subPath);
    }
    
    private static void readSystemProperties(final String prefix) {
        final String completePrefix;
        if (prefix != null && !prefix.isEmpty()) {
            completePrefix = prefix + ".";
        }
         else {
            completePrefix = "";
        }
        
        final File conf = system.get().getConf(completePrefix + "system.properties");
        if (conf != null && conf.exists()) {
            addSystemProperties(conf);
        }
        
    }
    
    private static void readSystemProperties() {
        readSystemProperties(null);
    }
    
    private static void addSystemProperties(final File file) {
        if (!file.exists()) {
            return;
        }
        
        final Properties systemProperties;
        try {
            systemProperties = IO.readProperties(file);
        }
         catch (final IOException e) {
            return;
        }
        
        for (final String key : systemProperties.stringPropertyNames()) {
            final SystemInstance systemInstance = system.get();
            if (systemInstance.getProperty(key) == null) {
                systemInstance.setProperty(key, systemProperties.getProperty(key));
            }
            
        }
        
    }
    
    public static SystemInstance get() {
        return system.get();
    }
    
    public String currentProfile() {
        return getProperty(PROFILE_PROP, DEFAULT_PROFILE);
    }
    
    public boolean isDefaultProfile() {
        return DEFAULT_PROFILE.equals(currentProfile());
    }
    
    public boolean hasProperty(final String propName) {
        return this.internalProperties.get(propName) != null;
    }
    
    public void removeObservers() {
        observerManager.destroy();
    }
    
}


