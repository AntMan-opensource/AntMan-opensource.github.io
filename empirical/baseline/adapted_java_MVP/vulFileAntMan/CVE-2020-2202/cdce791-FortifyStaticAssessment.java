package org.jenkinsci.plugins.fodupload.steps;
import java.io.PrintStream;
import java.util.Set;
import com.google.common.collect.ImmutableSet;
import jenkins.model.Jenkins;
import org.jenkinsci.plugins.fodupload.SharedUploadBuildStep;
import org.jenkinsci.plugins.workflow.steps.StepContext;
import org.jenkinsci.plugins.workflow.steps.StepDescriptor;
import org.jenkinsci.plugins.workflow.steps.StepExecution;
import org.jenkinsci.plugins.workflow.steps.SynchronousNonBlockingStepExecution;
import org.kohsuke.stapler.DataBoundConstructor;
import org.kohsuke.stapler.DataBoundSetter;
import org.kohsuke.stapler.QueryParameter;
import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
import hudson.Extension;
import hudson.FilePath;
import hudson.Launcher;
import hudson.model.AbstractBuild;
import hudson.model.BuildListener;
import hudson.model.Run;
import hudson.model.TaskListener;
import hudson.util.FormValidation;
import hudson.util.ListBoxModel;
import hudson.util.Secret;
import org.kohsuke.stapler.verb.POST;
public class FortifyStaticAssessment extends FortifyStep {
    private static final ThreadLocal<TaskListener> taskListener = new ThreadLocal<>();
    private String releaseId;
    private String bsiToken;
    private boolean overrideGlobalConfig;
    private String username;
    private String personalAccessToken;
    private String tenantId;
    private boolean purchaseEntitlements;
    private String entitlementPreference;
    private String srcLocation;
    private String remediationScanPreferenceType;
    private String inProgressScanActionType;
    private SharedUploadBuildStep commonBuildStep;
    public FortifyStaticAssessment(String releaseId, String bsiToken) {
        super();
        this.releaseId = releaseId != null ? releaseId.trim() : "";
        this.bsiToken = bsiToken != null ? bsiToken.trim() : "";
    }
    
    public String getBsiToken() {
        return bsiToken;
    }
    
    public String getReleaseId() { return releaseId; }
    public boolean getOverrideGlobalConfig() {
        return overrideGlobalConfig;
    }
    
    public void setOverrideGlobalConfig(boolean overrideGlobalConfig) {
        this.overrideGlobalConfig = overrideGlobalConfig;
    }
    
    public String getUsername() {
        return username;
    }
    
    public void setUsername(String username) {
        this.username = username;
    }
    
    public String getPersonalAccessToken() {
        return personalAccessToken;
    }
    
    public void setPersonalAccessToken(String personalAccessToken) {
        this.personalAccessToken = personalAccessToken;
    }
    
    public String getTenantId() {
        return tenantId;
    }
    
    public void setTenantId(String tenantId) {
        this.tenantId = tenantId;
    }
    
    public boolean getPurchaseEntitlements() {
        return purchaseEntitlements;
    }
    
    public void setPurchaseEntitlements(boolean purchaseEntitlements) {
        this.purchaseEntitlements = purchaseEntitlements;
    }
    
    public String getEntitlementPreference() {
        return entitlementPreference;
    }
    
    public void setEntitlementPreference(String entitlementPreference) {
        this.entitlementPreference = entitlementPreference;
    }
    
    public String getSrcLocation() {
        return srcLocation;
    }
    
    public void setSrcLocation(String srcLocation) {
        this.srcLocation = srcLocation != null ? srcLocation.trim() : "";
    }
    
    public String getRemediationScanPreferenceType() {
        return remediationScanPreferenceType;
    }
    
    public void setRemediationScanPreferenceType(String remediationScanPreferenceType) {
        this.remediationScanPreferenceType = remediationScanPreferenceType;
    }
    
    public String getInProgressScanActionType() {
        return inProgressScanActionType;
    }
    
    public void setInProgressScanActionType(String inProgressScanActionType) {
        this.inProgressScanActionType = inProgressScanActionType;
    }
    
    public boolean prebuild(AbstractBuild<?, ?> build, BuildListener listener) {
        PrintStream log = listener.getLogger();
        log.println("Fortify on Demand Upload PreBuild Running...");
        commonBuildStep = new SharedUploadBuildStep(releaseId, bsiToken, overrideGlobalConfig, username, personalAccessToken, tenantId, purchaseEntitlements, entitlementPreference, srcLocation, remediationScanPreferenceType, inProgressScanActionType);
        return true;
    }
    
    public StepExecution start(StepContext context) throws Exception {
        return new Execution(this, context);
    }
    
    public void perform(Run<?, ?> build, FilePath workspace, Launcher launcher, TaskListener listener) {
        PrintStream log = listener.getLogger();
        log.println("Fortify on Demand Upload Running...");
        commonBuildStep = new SharedUploadBuildStep(releaseId, bsiToken, overrideGlobalConfig, username, personalAccessToken, tenantId, purchaseEntitlements, entitlementPreference, srcLocation, remediationScanPreferenceType, inProgressScanActionType);
        commonBuildStep.perform(build, workspace, launcher, listener);
    }
    
    public static class DescriptorImpl extends StepDescriptor {
        public String getDisplayName() {
            return "Run Fortify on Demand Upload";
        }
        
        public String getFunctionName() {
            return "fodStaticAssessment";
        }
        
        public Set<? extends Class<?>> getRequiredContext() {
            return ImmutableSet.of(Run.class, FilePath.class, Launcher.class, TaskListener.class);
        }
        
        @SuppressWarnings({"ThrowableResultOfMethodCallIgnored", "unused"})
        public FormValidation doTestPersonalAccessTokenConnection(@QueryParameter(SharedUploadBuildStep.USERNAME) final String username, @QueryParameter(SharedUploadBuildStep.PERSONAL_ACCESS_TOKEN) final String personalAccessToken, @QueryParameter(SharedUploadBuildStep.TENANT_ID) final String tenantId) {
            Jenkins.get().checkPermission(Jenkins.ADMINISTER);
            return SharedUploadBuildStep.doTestPersonalAccessTokenConnection(username, personalAccessToken, tenantId);
        }
        
        public ListBoxModel doFillEntitlementPreferenceItems() {
            return SharedUploadBuildStep.doFillEntitlementPreferenceItems();
        }
        
        public ListBoxModel doFillRemediationScanPreferenceTypeItems() {
            return SharedUploadBuildStep.doFillRemediationScanPreferenceTypeItems();
        }
        
        public ListBoxModel doFillUsernameItems() {
            return SharedUploadBuildStep.doFillStringCredentialsItems();
        }
        
        public ListBoxModel doFillPersonalAccessTokenItems() {
            return SharedUploadBuildStep.doFillStringCredentialsItems();
        }
        
        public ListBoxModel doFillTenantIdItems() {
            return SharedUploadBuildStep.doFillStringCredentialsItems();
        }
        
        public ListBoxModel doFillInProgressScanActionTypeItems() {
            return SharedUploadBuildStep.doFillInProgressScanActionTypeItems();
        }
        
    }
    
    private static class Execution extends SynchronousNonBlockingStepExecution<Void> {
        private static final long serialVersionUID = 1L;
        private transient FortifyStaticAssessment upload;
        protected Execution(FortifyStaticAssessment upload, StepContext context) {
            super(context);
            this.upload = upload;
        }
        
        protected Void run() throws Exception {
            getContext().get(TaskListener.class).getLogger().println("Running fodStaticAssessment step");
            upload.perform(getContext().get(Run.class), getContext().get(FilePath.class), getContext().get(Launcher.class), getContext().get(TaskListener.class));
            return null;
        }
        
    }
    
}

