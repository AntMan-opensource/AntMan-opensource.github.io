package org.eclipse.jdt.internal.ui.jarpackagerfat;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.parsers.ParserConfigurationException;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerException;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;
import org.w3c.dom.Document;
import org.w3c.dom.Element;
import org.w3c.dom.Node;
import org.eclipse.core.runtime.IPath;
import org.eclipse.debug.core.ILaunchConfiguration;
public class UnpackJarAntExporter extends FatJarAntExporter {
	public UnpackJarAntExporter(IPath antScriptLocation, IPath jarLocation, ILaunchConfiguration launchConfiguration) {
		super(antScriptLocation, jarLocation, launchConfiguration);
	}
	
	protected void buildANTScript(IPath antScriptLocation, String projectName, IPath absJarfile, String mainClass, SourceInfo[] sourceInfos) throws IOException {
		try (OutputStream outputStream = new FileOutputStream(antScriptLocation.toFile())) {
			String absJarname= absJarfile.toString();
			String subfolder= absJarfile.removeFileExtension().lastSegment() + "_lib"; 
			String absSubfolder= absJarfile.removeLastSegments(1).append(subfolder).toString();
			DocumentBuilder docBuilder= null;
			DocumentBuilderFactory factory= DocumentBuilderFactory.newInstance();
			factory.setValidating(false);
			try {
				docBuilder= factory.newDocumentBuilder();
			}
			 catch (ParserConfigurationException ex) {
				throw new IOException(FatJarPackagerMessages.FatJarPackageAntScript_error_couldNotGetXmlBuilder);
			}
			
			Document document= docBuilder.newDocument();
			Node comment;
			 Element project= document.createElement("project"); 
			project.setAttribute("name", "Create Runnable Jar for Project " + projectName + " with libraries in sub-folder"); 
			project.setAttribute("default", "create_run_jar"); 
			comment= document.createComment("this file was created by Eclipse Runnable JAR Export Wizard"); 
			project.appendChild(comment);
			comment= document.createComment("ANT 1.7 is required                                        "); 
			project.appendChild(comment);
			document.appendChild(project);
			addBaseDirProperties(document, project);
			Element target= document.createElement("target"); 
			target.setAttribute("name", "create_run_jar"); 
			project.appendChild(target);
			Element jar= document.createElement("jar"); 
			jar.setAttribute("destfile", substituteBaseDirs(absJarname)); 
			target.appendChild(jar);
			Element manifest= document.createElement("manifest"); 
			jar.appendChild(manifest);
			Element attribute= document.createElement("attribute"); 
			attribute.setAttribute("name", "Main-Class"); 
			attribute.setAttribute("value", mainClass); 
			manifest.appendChild(attribute);
			attribute= document.createElement("attribute"); 
			attribute.setAttribute("name", "Class-Path"); 
			StringBuilder classPath= new StringBuilder();
			classPath.append("."); 
			for (SourceInfo sourceInfo : sourceInfos) {
				if (sourceInfo.isJar) {
					classPath.append(" ").append(subfolder).append("/")  .append(new File(sourceInfo.absPath).getName());
				}
				
			}
			
			attribute.setAttribute("value", classPath.toString()); 
			manifest.appendChild(attribute);
			 for (SourceInfo sourceInfo : sourceInfos) {
				if (!sourceInfo.isJar) {
					Element fileset= document.createElement("fileset"); 
					fileset.setAttribute("dir", substituteBaseDirs(sourceInfo.absPath)); 
					jar.appendChild(fileset);
				}
				
			}
			
			Element delete= document.createElement("delete"); 
			delete.setAttribute("dir", substituteBaseDirs(absSubfolder)); 
			target.appendChild(delete);
			Element mkdir= document.createElement("mkdir"); 
			mkdir.setAttribute("dir", substituteBaseDirs(absSubfolder)); 
			target.appendChild(mkdir);
			 for (SourceInfo sourceInfo : sourceInfos) {
				if (sourceInfo.isJar) {
					Element copy= document.createElement("copy"); 
					copy.setAttribute("file", substituteBaseDirs(sourceInfo.absPath)); 
					copy.setAttribute("todir", substituteBaseDirs(absSubfolder)); 
					target.appendChild(copy);
				}
				
			}
			
			 for (SourceInfo sourceInfo : sourceInfos) {
				if (!sourceInfo.isJar) {
				}
				
			}
			
			try {
				 Transformer transformer= TransformerFactory.newInstance().newTransformer();
				transformer.setOutputProperty(OutputKeys.METHOD, "xml"); 
				transformer.setOutputProperty(OutputKeys.ENCODING, "UTF-8"); 
				transformer.setOutputProperty(OutputKeys.INDENT, "yes"); 
				transformer.setOutputProperty("{http://xml.apache.org/xslt}indent-amount", "4"); 
				DOMSource source= new DOMSource(document);
				StreamResult result= new StreamResult(outputStream);
				transformer.transform(source, result);
			}
			 catch (TransformerException e) {
				throw new IOException(FatJarPackagerMessages.FatJarPackageAntScript_error_couldNotTransformToXML);
			}
			
		}
		
	}
	
}


