package org.ballerinalang.cli.module;
import me.tongfei.progressbar.ProgressBar;
import me.tongfei.progressbar.ProgressBarStyle;
import org.ballerinalang.cli.module.util.ErrorUtil;
import org.ballerinalang.cli.module.util.Utils;
import org.ballerinalang.jvm.JSONParser;
import org.ballerinalang.jvm.values.MapValue;
import java.io.BufferedReader;
import java.io.DataOutputStream;
import java.io.FileInputStream;
import java.io.IOException;
import java.io.InputStreamReader;
import java.io.PrintStream;
import java.net.Authenticator;
import java.net.HttpURLConnection;
import java.nio.charset.Charset;
import java.nio.file.Files;
import java.nio.file.Path;
import javax.ws.rs.core.HttpHeaders;
import javax.ws.rs.core.MediaType;
import static org.ballerinalang.cli.module.util.CliModuleConstants.PUSH_ORGANIZATION;
import static org.ballerinalang.cli.module.util.Utils.convertToUrl;
import static org.ballerinalang.cli.module.util.Utils.createHttpUrlConnection;
import static org.ballerinalang.cli.module.util.Utils.getStatusCode;
import static org.ballerinalang.cli.module.util.Utils.initializeSsl;
import static org.ballerinalang.cli.module.util.Utils.setRequestMethod;
public class Push {
    private static PrintStream errStream = System.err;
    private static PrintStream outStream = System.out;
    private static final int NO_OF_BYTES = 64;
    private static final int BUFFER_SIZE = 1024 * NO_OF_BYTES;
    private Push() {
    }
    
    public static void execute(String url, String proxyHost, int proxyPort, String proxyUsername, String proxyPassword, String accessToken, String orgName, String moduleName, String version, Path baloPath) {
        initializeSsl();
        HttpURLConnection conn = createHttpUrlConnection(convertToUrl(url), proxyHost, proxyPort, proxyUsername, proxyPassword);
        conn.setInstanceFollowRedirects(false);
        setRequestMethod(conn, Utils.RequestMethod.POST);
        conn.setRequestProperty(HttpHeaders.AUTHORIZATION, "Bearer " + accessToken);
        conn.setRequestProperty(PUSH_ORGANIZATION, orgName);
        conn.setRequestProperty(HttpHeaders.CONTENT_TYPE, MediaType.APPLICATION_OCTET_STREAM);
        conn.setDoOutput(true);
        conn.setChunkedStreamingMode(BUFFER_SIZE);
        try (DataOutputStream outputStream = new DataOutputStream(conn.getOutputStream())) {
            byte[] buffer = new byte[BUFFER_SIZE];
            int count;
            try (ProgressBar progressBar = new ProgressBar( orgName + "/" + moduleName + ":" + version + " [project repo -> central]", getTotalFileSizeInKB(baloPath), 1000, outStream, ProgressBarStyle.ASCII, " KB", 1); FileInputStream fis = new FileInputStream(baloPath.toFile())) {
                while ((count = fis.read(buffer)) > 0) {
                    outputStream.write(buffer, 0, count);
                    outputStream.flush();
                    progressBar.stepBy((long) NO_OF_BYTES);
                }
                
            }
            
        }
         catch (IOException e) {
            throw ErrorUtil.createCommandException("error occurred while uploading balo to central: " + e.getMessage());
        }
        
        handleResponse(conn, orgName, moduleName, version);
        Authenticator.setDefault(null);
    }
    
    private static void handleResponse(HttpURLConnection conn, String orgName, String moduleName, String version) {
        try {
            int statusCode = getStatusCode(conn);
            if (statusCode == HttpURLConnection.HTTP_OK) {
                outStream.println(orgName + "/" + moduleName + ":" + version + " pushed to central successfully");
            }
             else if (statusCode == HttpURLConnection.HTTP_UNAUTHORIZED) {
                errStream.println("unauthorized access token for organization: " + orgName);
            }
             else if (statusCode == HttpURLConnection.HTTP_BAD_REQUEST) {
                try (BufferedReader reader = new BufferedReader( new InputStreamReader(conn.getErrorStream(), Charset.defaultCharset()))) {
                    StringBuilder result = new StringBuilder();
                    String line;
                    while ((line = reader.readLine()) != null) {
                        result.append(line);
                    }
                    
                    MapValue payload = (MapValue) JSONParser.parse(result.toString());
                    String message = payload.getStringValue("message");
                    if (message.contains("module md file cannot be empty")) {
                        errStream.println(message);
                    }
                     else {
                        throw ErrorUtil.createCommandException(message);
                    }
                    
                }
                 catch (IOException e) {
                    throw ErrorUtil.createCommandException( "failed to push the module '" + orgName + "/" + moduleName + ":" + version + "' to the remote repository '" + conn.getURL() + "'");
                }
                
            }
             else {
                throw ErrorUtil.createCommandException( "failed to push the module '" + orgName + "/" + moduleName + ":" + version + "' to the remote repository '" + conn.getURL() + "'");
            }
            
        }
         finally {
            conn.disconnect();
        }
        
    }
    
    private static long getTotalFileSizeInKB(Path filePath) {
        byte[] baloContent;
        try {
            baloContent = Files.readAllBytes(filePath);
            return baloContent.length / 1024;
        }
         catch (IOException e) {
            throw ErrorUtil.createCommandException("cannot read the balo content");
        }
        
    }
    
}


