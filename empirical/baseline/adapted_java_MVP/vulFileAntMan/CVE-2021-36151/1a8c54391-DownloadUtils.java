package org.apache.gobblin.util;
import java.io.BufferedOutputStream;
import java.io.File;
import java.io.FileOutputStream;
import java.io.IOException;
import java.io.OutputStream;
import java.net.URI;
import java.net.URL;
import java.security.AccessController;
import java.security.PrivilegedAction;
import java.util.Map;
import java.util.logging.Logger;
import com.google.common.collect.Maps;
import com.google.common.io.Resources;
import groovy.grape.Grape;
import groovy.lang.GroovyClassLoader;
import lombok.NonNull;
public class DownloadUtils {
  private DownloadUtils() {
  }
  
  public static final String IVY_SETTINGS_FILE_NAME = "ivysettings.xml";
  private static final String CLIENT_IVY_SETTINGS_FILE_NAME = "client_ivysettings.xml";
  private static final Logger logger = Logger.getLogger(DownloadUtils.class.getName());
  public static URI[] downloadJar(String org, String module, String version, boolean transitive) throws IOException {
    Map<String, Object> artifactMap = Maps.newHashMap();
    artifactMap.put("org", org);
    artifactMap.put("module", module);
    artifactMap.put("version", version);
    artifactMap.put("transitive", transitive);
    return downloadJar(artifactMap);
  }
  
  public static URI[] downloadJar(Map<String, Object> artifactMap) throws IOException {
    System.setProperty("grape.config", getIvySettingsFile().getAbsolutePath());
    Map<String, Object> args = Maps.newHashMap();
    args.put("classLoader",  AccessController.doPrivileged(new PrivilegedAction<GroovyClassLoader>() {
      public GroovyClassLoader run() {
        return new GroovyClassLoader();
      }
      
    }
    
));
    return Grape.resolve(args, artifactMap);
  }
  
  private static URL getSettingsUrl() throws IOException {
    URL clientSettingsUrl = Thread.currentThread().getContextClassLoader().getResource(CLIENT_IVY_SETTINGS_FILE_NAME);
    if (clientSettingsUrl == null) {
      URL settingsUrl = Thread.currentThread().getContextClassLoader().getResource(IVY_SETTINGS_FILE_NAME);
      if (settingsUrl == null) {
        throw new IOException("Failed to find " + IVY_SETTINGS_FILE_NAME + "and " + CLIENT_IVY_SETTINGS_FILE_NAME +" from class path");
      }
       else {
        logger.info("Fallback to ivysettings.xml in the classpath");
        return settingsUrl;
      }
      
    }
     else {
      logger.info("Using customized client_ivysettings.xml file");
      return clientSettingsUrl;
    }
    
  }
  
  public static File getIvySettingsFile() throws IOException {
    URL settingsUrl = getSettingsUrl();
    File ivySettingsFile = new File(settingsUrl.getFile());
    if (ivySettingsFile.exists()) {
      return ivySettingsFile;
    }
    
    ivySettingsFile = File.createTempFile("ivy.settings", ".xml");
    ivySettingsFile.deleteOnExit();
    try (OutputStream os = new BufferedOutputStream(new FileOutputStream(ivySettingsFile))) {
      Resources.copy(settingsUrl, os);
    }
    
    return ivySettingsFile;
  }
  
}


