package io.goobi.viewer.managedbeans;
import java.io.IOException;
import java.io.OutputStream;
import java.io.Serializable;
import java.nio.file.Paths;
import java.util.ArrayList;
import java.util.Collection;
import java.util.Collections;
import java.util.HashMap;
import java.util.HashSet;
import java.util.List;
import java.util.Locale;
import java.util.Map;
import java.util.Optional;
import java.util.stream.Collectors;
import javax.enterprise.context.SessionScoped;
import javax.faces.context.ExternalContext;
import javax.faces.context.FacesContext;
import javax.inject.Inject;
import javax.inject.Named;
import javax.servlet.http.HttpServletRequest;
import javax.servlet.http.HttpSession;
import org.apache.commons.lang3.StringUtils;
import org.apache.commons.text.StringEscapeUtils;
import org.apache.http.client.ClientProtocolException;
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.apache.solr.common.SolrDocument;
import org.apache.solr.common.SolrDocumentList;
import com.ocpsoft.pretty.PrettyContext;
import com.ocpsoft.pretty.faces.url.URL;
import de.intranda.api.annotation.wa.TypedResource;
import de.intranda.metadata.multilanguage.IMetadataValue;
import de.intranda.metadata.multilanguage.MultiLanguageMetadataValue;
import io.goobi.viewer.controller.DataManager;
import io.goobi.viewer.controller.IndexerTools;
import io.goobi.viewer.controller.NetTools;
import io.goobi.viewer.controller.PrettyUrlTools;
import io.goobi.viewer.controller.StringConstants;
import io.goobi.viewer.controller.StringTools;
import io.goobi.viewer.exceptions.DAOException;
import io.goobi.viewer.exceptions.IDDOCNotFoundException;
import io.goobi.viewer.exceptions.IndexUnreachableException;
import io.goobi.viewer.exceptions.PresentationException;
import io.goobi.viewer.exceptions.RecordDeletedException;
import io.goobi.viewer.exceptions.RecordLimitExceededException;
import io.goobi.viewer.exceptions.RecordNotFoundException;
import io.goobi.viewer.exceptions.ViewerConfigurationException;
import io.goobi.viewer.faces.validators.PIValidator;
import io.goobi.viewer.faces.validators.SolrQueryValidator;
import io.goobi.viewer.managedbeans.utils.BeanUtils;
import io.goobi.viewer.messages.Messages;
import io.goobi.viewer.messages.ViewerResourceBundle;
import io.goobi.viewer.model.annotation.PublicationStatus;
import io.goobi.viewer.model.annotation.comments.CommentGroup;
import io.goobi.viewer.model.cms.pages.CMSPage;
import io.goobi.viewer.model.crowdsourcing.DisplayUserGeneratedContent;
import io.goobi.viewer.model.crowdsourcing.DisplayUserGeneratedContent.ContentType;
import io.goobi.viewer.model.job.download.DownloadJob;
import io.goobi.viewer.model.job.download.DownloadOption;
import io.goobi.viewer.model.job.download.EPUBDownloadJob;
import io.goobi.viewer.model.job.download.PDFDownloadJob;
import io.goobi.viewer.model.maps.GeoMap;
import io.goobi.viewer.model.maps.GeoMap.GeoMapType;
import io.goobi.viewer.model.maps.GeoMapFeature;
import io.goobi.viewer.model.search.BrowseElement;
import io.goobi.viewer.model.search.SearchHelper;
import io.goobi.viewer.model.search.SearchHit;
import io.goobi.viewer.model.security.AccessConditionUtils;
import io.goobi.viewer.model.security.AccessPermission;
import io.goobi.viewer.model.security.IPrivilegeHolder;
import io.goobi.viewer.model.statistics.usage.RequestType;
import io.goobi.viewer.model.toc.TOC;
import io.goobi.viewer.model.toc.TOCElement;
import io.goobi.viewer.model.toc.export.pdf.TocWriter;
import io.goobi.viewer.model.toc.export.pdf.WriteTocException;
import io.goobi.viewer.model.translations.language.Language;
import io.goobi.viewer.model.viewer.PageOrientation;
import io.goobi.viewer.model.viewer.PageType;
import io.goobi.viewer.model.viewer.PhysicalElement;
import io.goobi.viewer.model.viewer.StructElement;
import io.goobi.viewer.model.viewer.ViewManager;
import io.goobi.viewer.model.viewer.pageloader.AbstractPageLoader;
import io.goobi.viewer.modules.IModule;
import io.goobi.viewer.solr.SolrConstants;
import io.goobi.viewer.solr.SolrConstants.DocType;
import io.goobi.viewer.solr.SolrSearchIndex;
import io.goobi.viewer.solr.SolrTools;
public class ActiveDocumentBean implements Serializable {
    private static final long serialVersionUID = -8686943862186336894L;
    private static final Logger logger = LogManager.getLogger(ActiveDocumentBean.class);
    private static final String DOUBLE_PAGE_PATTERN = "\\d+-\\d+";
    private static int imageContainerWidth = 600;
    private final transient Object lock = new Object();
    private NavigationHelper navigationHelper;
    private CmsBean cmsBean;
    private SearchBean searchBean;
    private BookmarkBean bookmarkBean;
    private ImageDeliveryBean imageDelivery;
    private BreadcrumbBean breadcrumbBean;
    private String action = "";
    private String imageToShow = "1";
    private String logid = "";
    private int tocCurrentPage = 1;
    private ViewManager viewManager;
    private boolean anchor = false;
    private boolean volume = false;
    private boolean group = false;
    protected long topDocumentIddoc = 0;
    private BrowseElement prevHit;
    private BrowseElement nextHit;
    String lastReceivedIdentifier;
    private List<String> recordLanguages;
    private String selectedRecordLanguage;
    private Boolean deleteRecordKeepTrace;
    private String clearCacheMode;
    private Map<String, GeoMap> geoMaps = new HashMap<>();
    private int reloads = 0;
    private boolean downloadImageModalVisible = false;
    private String selectedDownloadOptionLabel;
    private Map<String, String> prevDocstructUrlCache = new HashMap<>();
    private Map<String, String> nextDocstructUrlCache = new HashMap<>();
    public ActiveDocumentBean() {
    }
    
    public void setNavigationHelper(NavigationHelper navigationHelper) {
        this.navigationHelper = navigationHelper;
    }
    
    public void setCmsBean(CmsBean cmsBean) {
        this.cmsBean = cmsBean;
    }
    
    public void setSearchBean(SearchBean searchBean) {
        this.searchBean = searchBean;
    }
    
    public void setBookshelfBean(BookmarkBean bookshelfBean) {
        this.bookmarkBean = bookshelfBean;
    }
    
    public void setBreadcrumbBean(BreadcrumbBean breadcrumbBean) {
        this.breadcrumbBean = breadcrumbBean;
    }
    
    public void reset() throws IndexUnreachableException {
        synchronized (this) {
            logger.trace("reset (thread {})", Thread.currentThread().getId());
            String pi = viewManager != null ? viewManager.getPi() : null;
            viewManager = null;
            topDocumentIddoc = 0;
            logid = "";
            action = "";
            prevHit = null;
            nextHit = null;
            group = false;
            clearCacheMode = null;
            prevDocstructUrlCache.clear();
            nextDocstructUrlCache.clear();
            lastReceivedIdentifier = null;
            for (IModule module : DataManager.getInstance().getModules()) {
                module.augmentResetRecord();
            }
            
            if (BeanUtils.getSession() != null) {
                DataManager.getInstance() .getRecordLockManager() .removeLockForPiAndSessionId(pi, BeanUtils.getSession().getId());
            }
            
        }
        
    }
    
    public ViewManager getViewManager() {
        if (viewManager == null) {
            try {
                try {
                    update();
                }
                 catch (IDDOCNotFoundException e) {
                    reload(lastReceivedIdentifier);
                }
                
            }
             catch (PresentationException e) {
                logger.debug(StringConstants.LOG_PRESENTATION_EXCEPTION_THROWN_HERE, e.getMessage());
            }
             catch (RecordNotFoundException | RecordDeletedException | RecordLimitExceededException e) {
                if (e.getMessage() != null && !"null".equals(e.getMessage()) && !"???".equals(e.getMessage())) {
                    logger.warn("{}: {}", e.getClass().getName(), e.getMessage());
                }
                
            }
             catch (IndexUnreachableException | DAOException | ViewerConfigurationException e) {
                logger.error(e.getMessage(), e);
            }
            
        }
        
        return viewManager;
    }
    
    public String reload(String pi) throws PresentationException, RecordNotFoundException, RecordDeletedException, IndexUnreachableException, DAOException, ViewerConfigurationException, RecordLimitExceededException {
        logger.trace("reload({})", pi);
        reloads++;
        reset();
        if (reloads > 3) {
            throw new RecordNotFoundException(pi);
        }
        
        setPersistentIdentifier(pi);
        return open();
    }
    
    public void update() throws PresentationException, IndexUnreachableException, RecordNotFoundException, RecordDeletedException, DAOException, ViewerConfigurationException, IDDOCNotFoundException, NumberFormatException, RecordLimitExceededException {
        synchronized (this) {
            if (topDocumentIddoc == 0) {
                try {
                    if (StringUtils.isNotEmpty(lastReceivedIdentifier)) {
                        throw new RecordNotFoundException(lastReceivedIdentifier);
                    }
                    
                    throw new RecordNotFoundException("???");
                }
                 finally {
                    lastReceivedIdentifier = null;
                }
                
            }
            
            logger.debug("update(): (IDDOC {} ; page {} ; thread {})", topDocumentIddoc, imageToShow, Thread.currentThread().getId());
            prevHit = null;
            nextHit = null;
            boolean doublePageMode = isDoublePageUrl();
            boolean mayChangeHitIndex = false;
            if (viewManager == null || viewManager.getTopStructElement() == null || viewManager.getTopStructElementIddoc() != topDocumentIddoc) {
                anchor = false;
                volume = false;
                group = false;
                if (searchBean != null && searchBean.getCurrentSearch() != null) {
                    searchBean.increaseCurrentHitIndex();
                    mayChangeHitIndex = true;
                }
                
                StructElement topStructElement = new StructElement(topDocumentIddoc);
                if (!topStructElement.isExists()) {
                    logger.info("IDDOC for the current record '{}' ({}) no longer seems to exist, attempting to retrieve an updated IDDOC...", topStructElement.getPi(), topDocumentIddoc);
                    topDocumentIddoc = DataManager.getInstance().getSearchIndex().getIddocFromIdentifier(topStructElement.getPi());
                    if (topDocumentIddoc == 0) {
                        logger.warn("New IDDOC for the current record '{}' could not be found. Perhaps this record has been deleted?", topStructElement.getPi());
                        reset();
                        try {
                            throw new RecordNotFoundException(lastReceivedIdentifier);
                        }
                         finally {
                            lastReceivedIdentifier = null;
                        }
                        
                    }
                    
                }
                 else if (topStructElement.isDeleted()) {
                    logger.debug("Record '{}' is deleted and only available as a trace document.", topStructElement.getPi());
                    reset();
                    throw new RecordDeletedException(topStructElement.getPi());
                }
                
                List<String> requiredAccessConditions = topStructElement.getMetadataValues(SolrConstants.ACCESSCONDITION);
                if (requiredAccessConditions != null && !requiredAccessConditions.isEmpty()) {
                    AccessPermission access = AccessConditionUtils.checkAccessPermission(new HashSet<>(requiredAccessConditions), IPrivilegeHolder.PRIV_LIST, new StringBuilder().append('+').append(SolrConstants.PI).append(':').append(topStructElement.getPi()).toString(), (HttpServletRequest) FacesContext.getCurrentInstance().getExternalContext().getRequest());
                    if (!access.isGranted()) {
                        logger.debug("User may not open {}", topStructElement.getPi());
                        try {
                            throw new RecordNotFoundException(lastReceivedIdentifier);
                        }
                         finally {
                            lastReceivedIdentifier = null;
                        }
                        
                    }
                    
                    if (access.isRedirect() && StringUtils.isNotEmpty(access.getRedirectUrl())) {
                        logger.debug("Redirecting to {}", access.getRedirectUrl());
                        try {
                            FacesContext.getCurrentInstance().getExternalContext().redirect(access.getRedirectUrl());
                            return;
                        }
                         catch (IOException e) {
                            logger.error(e.getMessage());
                            return;
                        }
                        
                    }
                    
                }
                
                viewManager = new ViewManager(topStructElement, AbstractPageLoader.create(topStructElement), topDocumentIddoc, logid, topStructElement.getMetadataValue(SolrConstants.MIMETYPE), imageDelivery);
                viewManager.setToc(createTOC());
                HttpSession session = BeanUtils.getSession();
                if (session != null) {
                    DataManager.getInstance() .getRecordLockManager() .removeLocksForSessionId(session.getId(), Collections.singletonList(viewManager.getPi()));
                }
                
                String limit = viewManager.getTopStructElement().getMetadataValue(SolrConstants.ACCESSCONDITION_CONCURRENTUSE);
                if (limit != null && AccessConditionUtils.isConcurrentViewsLimitEnabledForAnyAccessCondition( viewManager.getTopStructElement().getMetadataValues(SolrConstants.ACCESSCONDITION))) {
                    if (session != null) {
                        DataManager.getInstance() .getRecordLockManager() .lockRecord(viewManager.getPi(), session.getId(), Integer.valueOf(limit));
                    }
                     else {
                        logger.debug("No session found, unable to lock limited view record {}", topStructElement.getPi());
                        try {
                            throw new RecordLimitExceededException(lastReceivedIdentifier + ":" + limit);
                        }
                         finally {
                            lastReceivedIdentifier = null;
                        }
                        
                    }
                    
                }
                
            }
            
            DataManager.getInstance() .getUsageStatisticsRecorder() .recordRequest(RequestType.RECORD_VIEW, viewManager.getPi(), BeanUtils.getRequest());
            if (StringUtils.isNotEmpty(logid) && viewManager != null && !logid.equals(viewManager.getLogId())) {
                logger.debug("Find doc by LOGID: {}", logid);
                new StructElement(topDocumentIddoc);
                String query = new StringBuilder("+") .append(SolrConstants.LOGID) .append(":\"") .append(logid) .append("\" +") .append(SolrConstants.PI_TOPSTRUCT) .append(":") .append(viewManager.getPi()) .append(" +") .append(SolrConstants.DOCTYPE) .append(':') .append(DocType.DOCSTRCT.name()) .toString();
                SolrDocumentList docList = DataManager.getInstance() .getSearchIndex() .search(query, 1, null, Collections.singletonList(SolrConstants.IDDOC));
                long subElementIddoc = 0;
                if (!docList.isEmpty()) {
                    subElementIddoc = Long.valueOf((String) docList.get(0).getFieldValue(SolrConstants.IDDOC));
                    PageOrientation firstPageOrientation = viewManager.getFirstPageOrientation();
                    viewManager = new ViewManager(viewManager.getTopStructElement(), viewManager.getPageLoader(), subElementIddoc, logid, viewManager.getMimeType(), imageDelivery);
                    viewManager.setFirstPageOrientation(firstPageOrientation);
                    viewManager.setToc(createTOC());
                }
                 else {
                    logger.warn("{} not found for LOGID '{}'.", SolrConstants.IDDOC, logid);
                }
                
            }
            
            if (viewManager != null && viewManager.getCurrentStructElement() != null) {
                viewManager.setDoublePageMode(doublePageMode);
                StructElement structElement = viewManager.getCurrentStructElement();
                if (!structElement.isExists()) {
                    logger.trace("StructElement {} is not marked as existing. Record will be reloaded", structElement.getLuceneId());
                    try {
                        throw new IDDOCNotFoundException(lastReceivedIdentifier + " - " + structElement.getLuceneId());
                    }
                     finally {
                        lastReceivedIdentifier = null;
                    }
                    
                }
                
                if (structElement.isAnchor()) {
                    anchor = true;
                }
                
                if (structElement.isVolume()) {
                    volume = true;
                }
                
                if (structElement.isGroup()) {
                    group = true;
                }
                
                viewManager.setCurrentImageOrderString(imageToShow);
                viewManager.updateDropdownSelected();
                if (searchBean != null && searchBean.getCurrentSearch() != null) {
                    if (searchBean.getCurrentHitIndex() < 0) {
                        searchBean.findCurrentHitIndex(getPersistentIdentifier(), viewManager.getCurrentImageOrder(), true);
                    }
                     else if (mayChangeHitIndex) {
                        searchBean.increaseCurrentHitIndex();
                    }
                     else if (searchBean.getHitIndexOperand() != 0) {
                        searchBean.setHitIndexOperand(0);
                    }
                    
                }
                
            }
             else {
                logger.debug("ViewManager is null or ViewManager.currentDocument is null.");
                try {
                    throw new RecordNotFoundException(lastReceivedIdentifier);
                }
                 finally {
                    lastReceivedIdentifier = null;
                }
                
            }
            
            recordLanguages = viewManager.getTopStructElement().getMetadataValues(SolrConstants.LANGUAGE);
            if (StringUtils.isBlank(selectedRecordLanguage) && navigationHelper != null) {
                selectedRecordLanguage = navigationHelper.getLocaleString();
            }
            
            if (bookmarkBean != null) {
                bookmarkBean.prepareItemForBookmarkList();
                if (bookmarkBean.getCurrentBookmark() == null || !viewManager.getPi().equals(bookmarkBean.getCurrentBookmark().getPi())) {
                    bookmarkBean.prepareItemForBookmarkList();
                }
                
            }
            
        }
        
    }
    
    private boolean isDoublePageUrl() {
        return StringUtils.isNotBlank(imageToShow) && imageToShow.matches(DOUBLE_PAGE_PATTERN);
    }
    
    private TOC createTOC() throws PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        TOC toc = new TOC();
        synchronized (toc) {
            if (viewManager != null) {
                toc.generate(viewManager.getTopStructElement(), viewManager.isListAllVolumesInTOC(), viewManager.getMimeType(), tocCurrentPage);
                if (toc.getCurrentPage() != this.tocCurrentPage) {
                    this.tocCurrentPage = toc.getCurrentPage();
                }
                
            }
            
        }
        
        return toc;
    }
    
    public String open() throws RecordNotFoundException, RecordDeletedException, IndexUnreachableException, DAOException, ViewerConfigurationException, RecordLimitExceededException {
        synchronized (this) {
            logger.trace("open()");
            try {
                update();
                if (navigationHelper == null || viewManager == null) {
                    return "";
                }
                
                IMetadataValue name = viewManager.getTopStructElement().getMultiLanguageDisplayLabel();
                HttpServletRequest request = (HttpServletRequest) FacesContext.getCurrentInstance().getExternalContext().getRequest();
                URL url = PrettyContext.getCurrentInstance(request).getRequestURL();
                for (String language : name.getLanguages()) {
                    String translation = name.getValue(language).orElse(getPersistentIdentifier());
                    if (translation != null && translation.length() > DataManager.getInstance().getConfiguration().getBreadcrumbsClipping()) {
                        translation = new StringBuilder(translation.substring(0, DataManager.getInstance().getConfiguration().getBreadcrumbsClipping())) .append("...") .toString();
                        name.setValue(translation, language);
                    }
                    
                }
                
                if (name.isEmpty()) {
                    name.setValue(getPersistentIdentifier());
                }
                
                logger.trace("topdocument label: {} ", name.getValue());
                if (!PrettyContext.getCurrentInstance(request).getRequestURL().toURL().contains("/crowd")) {
                    breadcrumbBean.addRecordBreadcrumbs(viewManager, name, url);
                }
                
            }
             catch (PresentationException e) {
                logger.debug(StringConstants.LOG_PRESENTATION_EXCEPTION_THROWN_HERE, e.getMessage(), e);
                Messages.error(e.getMessage());
            }
             catch (IDDOCNotFoundException e) {
                try {
                    return reload(lastReceivedIdentifier);
                }
                 catch (PresentationException e1) {
                    logger.debug(StringConstants.LOG_PRESENTATION_EXCEPTION_THROWN_HERE, e.getMessage(), e);
                }
                
            }
            
            reloads = 0;
            return "";
        }
        
    }
    
    public String openFulltext() throws RecordNotFoundException, RecordDeletedException, IndexUnreachableException, DAOException, ViewerConfigurationException, PresentationException, NumberFormatException, RecordLimitExceededException {
        open();
        return "viewFulltext";
    }
    
    public BrowseElement getPrevHit() throws PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        if (prevHit == null && searchBean != null) {
            prevHit = searchBean.getPreviousElement();
        }
        
        return prevHit;
    }
    
    public BrowseElement getNextHit() throws PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        if (nextHit == null && searchBean != null) {
            nextHit = searchBean.getNextElement();
        }
        
        return nextHit;
    }
    
    public long getActiveDocumentIddoc() {
        if (viewManager != null) {
            return viewManager.getTopStructElementIddoc();
        }
        
        return 0;
    }
    
    public StructElement getCurrentElement() throws IndexUnreachableException {
        if (viewManager != null) {
            return viewManager.getCurrentStructElement();
        }
        
        return null;
    }
    
    public void setImageToShow(String imageToShow) {
        synchronized (lock) {
            this.imageToShow = imageToShow;
            if (viewManager != null) {
                viewManager.setDropdownSelected(String.valueOf(imageToShow));
            }
            
            setLogid("");
            logger.trace("imageToShow: {}", this.imageToShow);
        }
        
    }
    
    public String getImageToShow() {
        synchronized (lock) {
            return imageToShow;
        }
        
    }
    
    public void setLogid(String logid) {
        synchronized (this) {
            if ("-".equals(logid)) {
                this.logid = "";
            }
             else {
                this.logid = SolrTools.escapeSpecialCharacters(logid);
            }
            
        }
        
    }
    
    public String getLogid() {
        synchronized (this) {
            if (StringUtils.isEmpty(logid)) {
                return "-";
            }
            
            return logid;
        }
        
    }
    
    public boolean isAnchor() {
        return anchor;
    }
    
    public void setAnchor(boolean anchor) {
        this.anchor = anchor;
    }
    
    public boolean isVolume() {
        return volume;
    }
    
    public boolean isGroup() {
        return group;
    }
    
    public String getAction() {
        synchronized (this) {
            return action;
        }
        
    }
    
    public void setAction(String action) {
        synchronized (this) {
            logger.trace("setAction: " + action);
            this.action = action;
            if (searchBean != null && action != null) {
                switch (action) {
                    case "nextHit":
                        searchBean.setHitIndexOperand(1);
                        break;
                    case "prevHit":
                        searchBean.setHitIndexOperand(-1);
                        break;
                    default: break;
                }
                
            }
            
        }
        
    }
    
    public void setPersistentIdentifier(String persistentIdentifier) throws PresentationException, RecordNotFoundException, IndexUnreachableException {
        synchronized (this) {
            logger.trace("setPersistentIdentifier: {}", persistentIdentifier);
            lastReceivedIdentifier = persistentIdentifier;
            if (!PIValidator.validatePi(persistentIdentifier)) {
                logger.warn("Invalid identifier '{}'.", persistentIdentifier);
                reset();
                return;
            }
            
            if (!"-".equals(persistentIdentifier) && (viewManager == null || !persistentIdentifier.equals(viewManager.getPi()))) {
                long id = DataManager.getInstance().getSearchIndex().getIddocFromIdentifier(persistentIdentifier);
                if (id > 0) {
                    if (topDocumentIddoc != id) {
                        topDocumentIddoc = id;
                        logger.trace("IDDOC found for {}: {}", persistentIdentifier, id);
                    }
                    
                }
                 else {
                    logger.warn("No IDDOC for identifier '{}' found.", persistentIdentifier);
                    reset();
                    return;
                }
                
            }
            
        }
        
    }
    
    public String getPersistentIdentifier() throws IndexUnreachableException {
        synchronized (this) {
            if (viewManager != null) {
                return viewManager.getPi();
            }
            
            return "-";
        }
        
    }
    
    public String getThumbPart() throws IndexUnreachableException {
        if (viewManager != null) {
            return new StringBuilder("/").append(getPersistentIdentifier()) .append('/') .append(viewManager.getCurrentThumbnailPage()) .append('/') .toString();
        }
        
        return "";
    }
    
    public String getLogPart() throws IndexUnreachableException {
        return new StringBuilder("/").append(getPersistentIdentifier()) .append('/') .append(imageToShow) .append('/') .append(getLogid()) .append('/') .toString();
    }
    
    public String getPageUrl(String pageType, String pageOrderRange) throws IndexUnreachableException {
        StringBuilder sbUrl = new StringBuilder();
        if (StringUtils.isBlank(pageType)) {
            if (navigationHelper != null) {
                pageType = navigationHelper.getCurrentView();
                if (pageType == null) {
                    pageType = PageType.viewObject.name();
                }
                
            }
            
            if (StringUtils.isBlank(pageType)) {
                pageType = PageType.viewObject.name();
            }
            
        }
        
        int[] pages = StringTools.getIntegerRange(pageOrderRange);
        int page = pages[0];
        int page2 = pages[1];
        if (viewManager != null) {
            page = Math.max(page, viewManager.getPageLoader().getFirstPageOrder());
            page = Math.min(page, viewManager.getPageLoader().getLastPageOrder());
            if (page2 != Integer.MAX_VALUE) {
                page2 = Math.max(page2, viewManager.getPageLoader().getFirstPageOrder());
                page2 = Math.min(page2, viewManager.getPageLoader().getLastPageOrder());
            }
            
        }
        
        String range = page + (page2 != Integer.MAX_VALUE ? "-" + page2 : "");
        sbUrl.append(BeanUtils.getServletPathWithHostAsUrlFromJsfContext()) .append('/') .append(PageType.getByName(pageType).getName()) .append('/') .append(getPersistentIdentifier()) .append('/') .append(range) .append('/');
        return sbUrl.toString();
    }
    
    public String getPageUrl(String pageOrderRange) throws IndexUnreachableException {
        return getPageUrl(null, pageOrderRange);
    }
    
    public String getPageUrl() throws IndexUnreachableException {
        String pageType = null;
        if (StringUtils.isBlank(pageType)) {
            pageType = navigationHelper.getPreferredView();
        }
        
        if (StringUtils.isBlank(pageType)) {
            pageType = navigationHelper.getCurrentView();
        }
        
        return getPageUrlByType(pageType);
    }
    
    public String getPageUrlByType(String pageType) throws IndexUnreachableException {
        StringBuilder sbUrl = new StringBuilder();
        sbUrl.append(BeanUtils.getServletPathWithHostAsUrlFromJsfContext()) .append('/') .append(PageType.getByName(pageType).getName()) .append('/') .append(getPersistentIdentifier()) .append('/');
        return sbUrl.toString();
    }
    
    public String getFirstPageUrl() throws IndexUnreachableException {
        if (viewManager != null) {
            int image = viewManager.getPageLoader().getFirstPageOrder();
            if (viewManager.isDoublePageMode()) {
                return getPageUrl(image + "-" + image);
            }
            
            return getPageUrl(Integer.toString(image));
        }
        
        return null;
    }
    
    public String getLastPageUrl() throws IndexUnreachableException {
        if (viewManager != null) {
            int image = viewManager.getPageLoader().getLastPageOrder();
            if (viewManager.isDoublePageMode()) {
                return getPageUrl(image + "-" + image);
            }
            
            return getPageUrl(Integer.toString(image));
        }
        
        return null;
    }
    
    public String getPageUrlRelativeToCurrentPage(int step) throws IndexUnreachableException, DAOException {
        if (viewManager == null) {
            return getPageUrl(imageToShow);
        }
        
        if (!viewManager.isDoublePageMode()) {
            int number = viewManager.getCurrentImageOrder() + step;
            return getPageUrl(String.valueOf(number));
        }
        
        int number;
        if (viewManager.getCurrentPage().isDoubleImage()) {
            if (step < 0) {
                number = viewManager.getCurrentImageOrder() + 2 * step;
            }
             else {
                number = viewManager.getCurrentImageOrder() + step;
            }
            
            return getPageUrl(number + "-" + (number + 1));
        }
        
        Optional<PhysicalElement> currentLeftPage = viewManager.getTopStructElement().isRtl() ? viewManager.getCurrentRightPage() : viewManager.getCurrentLeftPage();
        Optional<PhysicalElement> currentRightPage = viewManager.getTopStructElement().isRtl() ? viewManager.getCurrentLeftPage() : viewManager.getCurrentRightPage();
        if (currentLeftPage.isPresent()) {
            number = currentLeftPage.get().getOrder() + step;
        }
         else if (currentRightPage.isPresent()) {
            number = currentRightPage.get().getOrder();
        }
         else {
            number = viewManager.getCurrentImageOrder() + step;
        }
        
        Optional<PhysicalElement> nextPage = viewManager.getPage(number);
        if (nextPage.isPresent() && nextPage.get().isDoubleImage()) {
            return getPageUrl(String.valueOf(number) + "-" + String.valueOf(number));
        }
        
        number += step;
        nextPage = viewManager.getPage(number);
        if (nextPage.isPresent() && nextPage.get().isDoubleImage()) {
            return getPageUrl(String.valueOf(number) + "-" + String.valueOf(number));
        }
        
        return getPageUrl(number + "-" + (number + 1));
    }
    
    public String getPageUrl(int order) throws IndexUnreachableException {
        return getPageUrl(Integer.toString(order));
    }
    
    public String getPreviousPageUrl(int step) throws IndexUnreachableException, DAOException {
        return getPageUrlRelativeToCurrentPage(step * -1);
    }
    
    public String getNextPageUrl(int step) throws IndexUnreachableException, DAOException {
        return getPageUrlRelativeToCurrentPage(step);
    }
    
    public String getPreviousPageUrl() throws IndexUnreachableException, DAOException {
        return getPreviousPageUrl(1);
    }
    
    public String getNextPageUrl() throws IndexUnreachableException, DAOException {
        return getNextPageUrl(1);
    }
    
    public String getPreviousDocstructUrl() throws IndexUnreachableException, PresentationException, DAOException, ViewerConfigurationException {
        if (viewManager == null) {
            return null;
        }
        
        List<String> docstructTypes = DataManager.getInstance().getConfiguration().getDocstructNavigationTypes(viewManager.getTopStructElement().getDocStructType(), true);
        if (docstructTypes.isEmpty()) {
            return null;
        }
        
        String currentDocstructIddoc = String.valueOf(viewManager.getCurrentStructElementIddoc());
        if (prevDocstructUrlCache.get(currentDocstructIddoc) == null) {
            int currentElementIndex = getToc().findTocElementIndexByIddoc(currentDocstructIddoc);
            if (currentElementIndex == -1) {
                logger.warn("Current IDDOC not found in TOC: {}", viewManager.getCurrentStructElement().getLuceneId());
                return null;
            }
            
            boolean found = false;
            for (int i = currentElementIndex - 1; i >= 0; --i) {
                TOCElement tocElement = viewManager.getToc().getTocElements().get(i);
                String docstructType = tocElement.getMetadataValue(SolrConstants.DOCSTRCT);
                if (docstructType != null && docstructTypes.contains(docstructType) && StringUtils.isNotBlank(tocElement.getPageNo())) {
                    logger.trace("Found previous {}: {}", docstructType, tocElement.getLogId());
                    prevDocstructUrlCache.put(currentDocstructIddoc, "/" + viewManager.getPi() + "/" + Integer.valueOf(tocElement.getPageNo()) + "/" + tocElement.getLogId() + "/");
                    found = true;
                    break;
                }
                
            }
            
            if (!found) {
                prevDocstructUrlCache.put(currentDocstructIddoc, "");
            }
            
        }
        
        if (StringUtils.isNotEmpty(prevDocstructUrlCache.get(currentDocstructIddoc))) {
            return BeanUtils.getServletPathWithHostAsUrlFromJsfContext() + "/" + navigationHelper.getCurrentPageType().getName() + prevDocstructUrlCache.get(currentDocstructIddoc);
        }
        
        return "";
    }
    
    public String getNextDocstructUrl() throws IndexUnreachableException, PresentationException, DAOException, ViewerConfigurationException {
        if (viewManager == null) {
            return "";
        }
        
        List<String> docstructTypes = DataManager.getInstance().getConfiguration().getDocstructNavigationTypes(viewManager.getTopStructElement().getDocStructType(), true);
        if (docstructTypes.isEmpty()) {
            return null;
        }
        
        String currentDocstructIddoc = String.valueOf(viewManager.getCurrentStructElementIddoc());
        if (nextDocstructUrlCache.get(currentDocstructIddoc) == null) {
            int currentElementIndex = getToc().findTocElementIndexByIddoc(currentDocstructIddoc);
            logger.trace("currentIndexElement: {}", currentElementIndex);
            if (currentElementIndex == -1) {
                return null;
            }
            
            boolean found = false;
            for (int i = currentElementIndex + 1; i < viewManager.getToc().getTocElements().size(); ++i) {
                TOCElement tocElement = viewManager.getToc().getTocElements().get(i);
                String docstructType = tocElement.getMetadataValue(SolrConstants.DOCSTRCT);
                if (docstructType != null && docstructTypes.contains(docstructType)) {
                    logger.trace("Found next {}: {}", docstructType, tocElement.getLogId());
                    nextDocstructUrlCache.put(currentDocstructIddoc, "/" + viewManager.getPi() + "/" + Integer.valueOf(tocElement.getPageNo()) + "/" + tocElement.getLogId() + "/");
                    found = true;
                    break;
                }
                
            }
            
            if (!found) {
                nextDocstructUrlCache.put(currentDocstructIddoc, "");
            }
            
        }
        
        if (StringUtils.isNotEmpty(nextDocstructUrlCache.get(currentDocstructIddoc))) {
            return BeanUtils.getServletPathWithHostAsUrlFromJsfContext() + "/" + navigationHelper.getCurrentPageType().getName() + nextDocstructUrlCache.get(currentDocstructIddoc);
        }
        
        return "";
    }
    
    public String getImageUrl() throws IndexUnreachableException {
        return getPageUrl(PageType.viewImage.getName(), imageToShow);
    }
    
    public String getFullscreenImageUrl() throws IndexUnreachableException, DAOException {
        if (viewManager != null && viewManager.isDoublePageMode() && !viewManager.getCurrentPage().isDoubleImage()) {
            Optional<PhysicalElement> currentLeftPage = viewManager.getCurrentLeftPage();
            Optional<PhysicalElement> currentRightPage = viewManager.getCurrentRightPage();
            if (currentLeftPage.isPresent() && currentRightPage.isPresent()) {
                return getPageUrl(PageType.viewFullscreen.getName(), currentLeftPage.get().getOrder() + "-" + currentRightPage.get().getOrder());
            }
            
        }
        
        return getPageUrl(PageType.viewFullscreen.getName(), imageToShow);
    }
    
    public String getReadingModeUrl() throws IndexUnreachableException, DAOException {
        return getFullscreenImageUrl();
    }
    
    public String getFulltextUrl() throws IndexUnreachableException {
        return getPageUrl(PageType.viewFulltext.getName(), imageToShow);
    }
    
    public String getMetadataUrl() throws IndexUnreachableException {
        return getPageUrl(PageType.viewMetadata.getName(), imageToShow);
    }
    
    public StructElement getTopDocument() {
        if (viewManager != null) {
            return viewManager.getTopStructElement();
        }
        
        return null;
    }
    
    public void setChildrenVisible(TOCElement element) throws PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        if (getToc() != null) {
            synchronized (getToc()) {
                getToc().setChildVisible(element.getID());
                getToc().getActiveElement();
            }
            
        }
        
    }
    
    public void setChildrenInvisible(TOCElement element) throws PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        if (getToc() != null) {
            synchronized (getToc()) {
                getToc().setChildInvisible(element.getID());
                getToc().getActiveElement();
            }
            
        }
        
    }
    
    public String calculateSidebarToc() throws IOException, PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        if (getToc() != null) {
            TOCElement activeTocElement = getToc().getActiveElement();
            if (activeTocElement != null) {
                String result = new StringBuilder("#").append(activeTocElement.getLogId()).toString();
                FacesContext.getCurrentInstance().getExternalContext().redirect(result);
                return result;
            }
            
        }
        
        return null;
    }
    
    public TOC getToc() throws PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        if (viewManager == null) {
            return null;
        }
        
        if (viewManager.getToc() == null) {
            viewManager.setToc(createTOC());
        }
        
        return viewManager.getToc();
    }
    
    public String getTocCurrentPage() {
        synchronized (this) {
            return Integer.toString(tocCurrentPage);
        }
        
    }
    
    public void setTocCurrentPage(String tocCurrentPage) throws PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        synchronized (this) {
            int[] pages = StringTools.getIntegerRange(tocCurrentPage);
            this.tocCurrentPage = pages[0];
            if (this.tocCurrentPage < 1) {
                this.tocCurrentPage = 1;
            }
            
            if (viewManager != null && viewManager.getToc() != null) {
                int currentCurrentPage = viewManager.getToc().getCurrentPage();
                viewManager.getToc().setCurrentPage(this.tocCurrentPage);
                if (viewManager.getToc().getCurrentPage() != this.tocCurrentPage) {
                    this.tocCurrentPage = viewManager.getToc().getCurrentPage();
                }
                
                if (currentCurrentPage != this.tocCurrentPage && DataManager.getInstance().getConfiguration().getTocAnchorGroupElementsPerPage() > 0 && viewManager != null) {
                    viewManager.getToc() .generate(viewManager.getTopStructElement(), viewManager.isListAllVolumesInTOC(), viewManager.getMimeType(), this.tocCurrentPage);
                }
                
            }
            
        }
        
    }
    
    public String getTitleBarLabel(Locale locale) throws IndexUnreachableException, PresentationException, DAOException, ViewerConfigurationException {
        return getTitleBarLabel(locale.getLanguage());
    }
    
    public String getTitleBarLabel() throws IndexUnreachableException, PresentationException, DAOException, ViewerConfigurationException {
        Locale locale = BeanUtils.getLocale();
        if (locale != null) {
            return getTitleBarLabel(locale.getLanguage());
        }
        
        return getTitleBarLabel(MultiLanguageMetadataValue.DEFAULT_LANGUAGE);
    }
    
    public String getTitleBarLabel(String language) throws IndexUnreachableException, PresentationException, DAOException, ViewerConfigurationException {
        if (navigationHelper == null) {
            return null;
        }
        
        if (PageType.getByName(navigationHelper.getCurrentPage()) != null && PageType.getByName(navigationHelper.getCurrentPage()).isDocumentPage() && viewManager != null) {
            TOC toc = getToc();
            if (toc != null && toc.getTocElements() != null && !toc.getTocElements().isEmpty()) {
                String label = null;
                String labelTemplate = "_DEFAULT";
                if (getViewManager() != null) {
                    labelTemplate = getViewManager().getTopStructElement().getDocStructType();
                }
                
                if (DataManager.getInstance().getConfiguration().isDisplayAnchorLabelInTitleBar(labelTemplate) && StringUtils.isNotBlank(viewManager.getAnchorPi())) {
                    String prefix = DataManager.getInstance().getConfiguration().getAnchorLabelInTitleBarPrefix(labelTemplate);
                    String suffix = DataManager.getInstance().getConfiguration().getAnchorLabelInTitleBarSuffix(labelTemplate);
                    prefix = ViewerResourceBundle.getTranslation(prefix, Locale.forLanguageTag(language)).replace("_SPACE_", " ");
                    suffix = ViewerResourceBundle.getTranslation(suffix, Locale.forLanguageTag(language)).replace("_SPACE_", " ");
                    label = prefix = toc.getLabel(viewManager.getAnchorPi(), language) + suffix + toc.getLabel(viewManager.getPi(), language);
                }
                 else {
                    label = toc.getLabel(viewManager.getPi(), language);
                }
                
                if (label != null) {
                    return label;
                }
                
            }
            
            String label = viewManager.getTopStructElement().getLabel(selectedRecordLanguage);
            if (StringUtils.isNotEmpty(label)) {
                return label;
            }
            
        }
         else if (cmsBean != null && navigationHelper.isCmsPage()) {
            CMSPage cmsPage = cmsBean.getCurrentPage();
            if (cmsPage != null) {
                String cmsPageName = StringUtils.isNotBlank(cmsPage.getMenuTitle()) ? cmsPage.getMenuTitle() : cmsPage.getTitle();
                if (StringUtils.isNotBlank(cmsPageName)) {
                    return cmsPageName;
                }
                
            }
            
        }
        
        if (navigationHelper.getCurrentPageType() != null) {
            PageType pageType = navigationHelper.getCurrentPageType();
            if (PageType.other.equals(pageType)) {
                String pageLabel = navigationHelper.getCurrentPage();
                if (StringUtils.isNotBlank(pageLabel)) {
                    return Messages.translate(pageLabel, Locale.forLanguageTag(language));
                }
                
            }
            
            return Messages.translate(pageType.getLabel(), Locale.forLanguageTag(language));
        }
        
        return null;
    }
    
    public String getLabelForJS() throws IndexUnreachableException, PresentationException, DAOException, ViewerConfigurationException {
        String label = getTitleBarLabel();
        if (label != null) {
            return StringEscapeUtils.escapeEcmaScript(label);
        }
        
        return null;
    }
    
    public int getImageContainerWidth() {
        return imageContainerWidth;
    }
    
    public int getNumberOfImages() throws IndexUnreachableException {
        if (viewManager != null) {
            return viewManager.getImagesCount();
        }
        
        return 0;
    }
    
    public long getTopDocumentIddoc() {
        if (viewManager != null) {
            return viewManager.getTopStructElementIddoc();
        }
        
        return 0;
    }
    
    public boolean isRecordLoaded() {
        return viewManager != null;
    }
    
    public boolean hasAnchor() throws IndexUnreachableException {
        return getTopDocument().isAnchorChild();
    }
    
    public String reIndexRecordAction() throws IndexUnreachableException, DAOException, RecordNotFoundException {
        if (viewManager != null) {
            if (IndexerTools.reIndexRecord(viewManager.getPi())) {
                Messages.info("reIndexRecordSuccess");
            }
             else {
                Messages.error("reIndexRecordFailure");
            }
            
        }
        
        return "";
    }
    
    public String deleteRecordAction(boolean keepTraceDocument) throws IOException, IndexUnreachableException {
        try {
            if (viewManager == null) {
                return "";
            }
            
            if (IndexerTools.deleteRecord(viewManager.getPi(), keepTraceDocument, Paths.get(DataManager.getInstance().getConfiguration().getHotfolder()))) {
                Messages.info("deleteRecord_success");
                return "pretty:index";
            }
            
            Messages.error("deleteRecord_failure");
        }
         finally {
            deleteRecordKeepTrace = null;
        }
        
        return "";
    }
    
    public String clearCacheAction() throws ClientProtocolException, IOException, IndexUnreachableException {
        logger.trace("clearCacheAction: {}", clearCacheMode);
        if (clearCacheMode == null || viewManager == null) {
            return "";
        }
        
        String url = NetTools.buildClearCacheUrl(clearCacheMode, viewManager.getPi(), navigationHelper.getApplicationUrl(), DataManager.getInstance().getConfiguration().getWebApiToken());
        try {
            try {
                NetTools.getWebContentDELETE(url, null, null, null, null);
                Messages.info("cache_clear__success");
            }
             catch (ClientProtocolException e) {
                logger.error(e.getMessage());
                Messages.error("cache_clear__failure");
            }
             catch (IOException e) {
                logger.error(e.getMessage());
                Messages.error("cache_clear__failure");
            }
            
        }
         finally {
            clearCacheMode = null;
        }
        
        return "";
    }
    
    public int getCurrentThumbnailPage() {
        synchronized (this) {
            return viewManager != null ? viewManager.getCurrentThumbnailPage() : 1;
        }
        
    }
    
    public void setCurrentThumbnailPage(int currentThumbnailPage) {
        synchronized (this) {
            if (viewManager != null) {
                viewManager.setCurrentThumbnailPage(currentThumbnailPage);
            }
            
        }
        
    }
    
    public boolean isHasLanguages() {
        return recordLanguages != null && !recordLanguages.isEmpty();
    }
    
    public List<String> getRecordLanguages() {
        return recordLanguages;
    }
    
    public void setRecordLanguages(List<String> recordLanguages) {
        this.recordLanguages = recordLanguages;
    }
    
    public String getSelectedRecordLanguage() {
        return selectedRecordLanguage;
    }
    
    public void setSelectedRecordLanguage(String selectedRecordLanguage) {
        logger.trace("setSelectedRecordLanguage: {}", selectedRecordLanguage);
        if (selectedRecordLanguage != null && selectedRecordLanguage.length() == 3) {
            Language language = DataManager.getInstance().getLanguageHelper().getLanguage(selectedRecordLanguage);
            if (language != null) {
                logger.trace("Mapped language found: {}", language.getIsoCodeOld());
                this.selectedRecordLanguage = language.getIsoCodeOld();
            }
             else {
                logger.warn("Language not found for code: {}", selectedRecordLanguage);
                this.selectedRecordLanguage = selectedRecordLanguage;
            }
            
        }
         else {
            this.selectedRecordLanguage = selectedRecordLanguage;
        }
        
        MetadataBean mdb = BeanUtils.getMetadataBean();
        if (mdb != null) {
            mdb.setSelectedRecordLanguage(this.selectedRecordLanguage);
        }
        
    }
    
    public boolean isAccessPermissionEpub() {
        synchronized (this) {
            try {
                if ((navigationHelper != null && !isEnabled(EPUBDownloadJob.LOCAL_TYPE, navigationHelper.getCurrentPage())) || viewManager == null || !DownloadJob.ocrFolderExists(viewManager.getPi())) {
                    return false;
                }
                
            }
             catch (PresentationException | IndexUnreachableException e) {
                logger.error("Error checking EPUB resources: {}", e.getMessage());
                return false;
            }
            
            return viewManager.isAccessPermissionPdf();
        }
        
    }
    
    public boolean isAccessPermissionPdf() {
        synchronized (this) {
            if ((navigationHelper != null && !isEnabled(PDFDownloadJob.LOCAL_TYPE, navigationHelper.getCurrentPage())) || viewManager == null) {
                return false;
            }
            
            return viewManager.isAccessPermissionPdf();
        }
        
    }
    
    private static boolean isEnabled(String downloadType, String pageTypeName) {
        if (downloadType.equals(EPUBDownloadJob.LOCAL_TYPE) && !DataManager.getInstance().getConfiguration().isGeneratePdfInTaskManager()) {
            return false;
        }
        
        PageType pageType = PageType.getByName(pageTypeName);
        boolean pdf = PDFDownloadJob.LOCAL_TYPE.equals(downloadType);
        if (pageType != null) {
            switch (pageType) {
                case viewToc:
                    return pdf ? DataManager.getInstance().getConfiguration().isTocPdfEnabled() : DataManager.getInstance().getConfiguration().isTocEpubEnabled();
                case viewMetadata:
                    return pdf ? DataManager.getInstance().getConfiguration().isMetadataPdfEnabled() : DataManager.getInstance().getConfiguration().isMetadataEpubEnabled();
                default: return pdf ? DataManager.getInstance().getConfiguration().isTitlePdfEnabled() : DataManager.getInstance().getConfiguration().isTitleEpubEnabled();
            }
            
        }
        
        logger.warn("Unknown page type: {}", pageTypeName);
        return false;
    }
    
    public void downloadTOCAction() throws IOException, PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        try {
            String fileNameRaw = getToc().getTocElements().get(0).getLabel();
            String fileName = fileNameRaw + ".pdf";
            FacesContext fc = FacesContext.getCurrentInstance();
            ExternalContext ec = fc.getExternalContext();
            ec.responseReset(); 
            ec.setResponseContentType("application/pdf");
            ec.setResponseHeader("Content-Disposition", "attachment; filename=\"" + fileName + "\"");
            OutputStream os = ec.getResponseOutputStream();
            TocWriter writer = new TocWriter("", fileNameRaw);
            writer.createPdfDocument(os, getToc().getTocElements());
            fc.responseComplete(); 
        }
         catch (IndexOutOfBoundsException e) {
            logger.error("No toc to generate");
        }
         catch (WriteTocException e) {
            logger.error("Error writing toc: " + e.getMessage(), e);
        }
        
    }
    
    public List<SearchHit> getRelatedItems(String identifierField) throws PresentationException, IndexUnreachableException, DAOException, ViewerConfigurationException {
        logger.trace("getRelatedItems: {}", identifierField);
        if (identifierField == null) {
            return null;
        }
        
        if (viewManager == null) {
            return null;
        }
        
        String query = getRelatedItemsQueryString(identifierField);
        if (query == null) {
            return null;
        }
        
        List<SearchHit> ret = SearchHelper.searchWithAggregation(query, 0, SolrSearchIndex.MAX_HITS, null, null, null, null, null, null, navigationHelper.getLocale(), 0);
        logger.trace("{} related items found", ret.size());
        return ret;
    }
    
    public String getRelatedItemsQueryString(String identifierField) {
        logger.trace("getRelatedItemsQueryString: {}", identifierField);
        List<String> relatedItemIdentifiers = viewManager.getTopStructElement().getMetadataValues(identifierField);
        if (relatedItemIdentifiers.isEmpty()) {
            return null;
        }
        
        StringBuilder sbQuery = new StringBuilder(SolrConstants.PI).append(":(");
        int initLength = sbQuery.length();
        for (String identifier : relatedItemIdentifiers) {
            if (sbQuery.length() > initLength) {
                sbQuery.append(" OR ");
            }
            
            sbQuery.append(identifier);
        }
        
        sbQuery.append(')');
        return sbQuery.toString();
    }
    
    public String getRelativeUrlTags() throws IndexUnreachableException, DAOException, PresentationException {
        if (!isRecordLoaded() || navigationHelper == null) {
            return "";
        }
        
        if (logger.isTraceEnabled()) {
            logger.trace("current view: {}", navigationHelper.getCurrentView());
        }
        
        StringBuilder sb = new StringBuilder();
        if (viewManager.getCurrentPage() != null) {
            if (StringUtils.isNotEmpty(viewManager.getCurrentPage().getUrn())) {
                String urnResolverUrl = DataManager.getInstance().getConfiguration().getUrnResolverUrl() + viewManager.getCurrentPage().getUrn();
                sb.append("\n<link rel=\"canonical\" href=\"").append(urnResolverUrl).append("\" />");
            }
            
            if (viewManager.getCurrentPage().equals(viewManager.getRepresentativePage())) {
                String piResolverUrl = navigationHelper.getApplicationUrl() + "piresolver?id=" + viewManager.getPi();
                sb.append("\n<link rel=\"canonical\" href=\"").append(piResolverUrl).append("\" />");
            }
            
        }
        
        PageType currentPageType = PageType.getByName(navigationHelper.getCurrentView());
        if (currentPageType != null && StringUtils.isNotEmpty(currentPageType.name())) {
            String currentUrl = navigationHelper.getCurrentUrl();
            if(currentUrl.contains(SolrTools.unescapeSpecialCharacters(getLogid()))) {
                currentUrl = currentUrl.replace(SolrTools.unescapeSpecialCharacters(getLogid()), getLogid());
            }
            
            if (currentUrl.contains("!" + currentPageType.getName())) {
                sb.append("\n<link rel=\"canonical\" href=\"") .append(currentUrl.replace("!" + currentPageType.getName(), currentPageType.getName())) .append("\" />");
            }
             else if (currentUrl.contains(currentPageType.getName())) {
                sb.append("\n<link rel=\"canonical\" href=\"") .append(currentUrl.replace(currentPageType.getName(), "!" + currentPageType.getName())) .append("\" />");
            }
            
        }
        
        if (PageType.viewMetadata.equals(currentPageType) || PageType.viewToc.equals(currentPageType)) {
            return "";
        }
        
        String currentUrl = getPageUrl(imageToShow);
        String prevUrl = getPreviousPageUrl();
        String nextUrl = getNextPageUrl();
        if (StringUtils.isNotEmpty(nextUrl) && !nextUrl.equals(currentUrl)) {
            sb.append("\n<link rel=\"next\" href=\"").append(nextUrl).append("\" />");
        }
        
        if (StringUtils.isNotEmpty(prevUrl) && !prevUrl.equals(currentUrl)) {
            sb.append("\n<link rel=\"prev\" href=\"").append(prevUrl).append("\" />");
        }
        
        return sb.toString();
    }
    
    public void resetAccess() {
        if (getViewManager() != null) {
            getViewManager().resetAccessPermissionPdf();
            getViewManager().resetAllowUserComments();
        }
        
    }
    
    public Boolean getDeleteRecordKeepTrace() {
        return deleteRecordKeepTrace;
    }
    
    public void setDeleteRecordKeepTrace(Boolean deleteRecordKeepTrace) {
        this.deleteRecordKeepTrace = deleteRecordKeepTrace;
    }
    
    public String getClearCacheMode() {
        return clearCacheMode;
    }
    
    public void setClearCacheMode(String clearCacheMode) {
        logger.trace("setClearCacheMode: {}", clearCacheMode);
        this.clearCacheMode = clearCacheMode;
    }
    
    public synchronized GeoMap getGeoMap() throws PresentationException, DAOException, IndexUnreachableException {
        GeoMap widget = this.geoMaps.get(getPersistentIdentifier());
        if (widget == null) {
            widget = generateGeoMap(getPersistentIdentifier());
            this.geoMaps = Collections.singletonMap(getPersistentIdentifier(), widget);
        }
        
        return widget;
    }
    
    public GeoMap generateGeoMap(String pi) throws PresentationException, DAOException {
        try {
            if ("-".equals(pi)) {
                return null;
            }
            
            GeoMap map = new GeoMap();
            map.setId(Long.MAX_VALUE);
            map.setType(GeoMapType.MANUAL);
            map.setShowPopover(true);
            map.setMarkerTitleField(null);
            map.setMarker("default");
            String mainDocQuery = String.format("PI:%s", pi);
            List<String> mainDocFields = PrettyUrlTools.getSolrFieldsToDeterminePageType();
            SolrDocument mainDoc = DataManager.getInstance().getSearchIndex().getFirstDoc(mainDocQuery, mainDocFields);
            PageType pageType = PrettyUrlTools.getPreferredPageType(mainDoc);
            boolean addMetadataFeatures = DataManager.getInstance().getConfiguration().includeCoordinateFieldsFromMetadataDocs();
            String docTypeFilter = "+DOCTYPE:DOCSTRCT";
            if (addMetadataFeatures) {
                docTypeFilter = "+(DOCTYPE:DOCSTRCT DOCTYPE:METADATA)";
            }
            
            String subDocQuery = String.format("+PI_TOPSTRUCT:%s " + docTypeFilter, pi);
            List<String> coordinateFields = DataManager.getInstance().getConfiguration().getGeoMapMarkerFields();
            List<String> subDocFields = new ArrayList<>();
            subDocFields.add(SolrConstants.LABEL);
            subDocFields.add(SolrConstants.PI_TOPSTRUCT);
            subDocFields.add(SolrConstants.THUMBPAGENO);
            subDocFields.add(SolrConstants.LOGID);
            subDocFields.add(SolrConstants.ISWORK);
            subDocFields.add(SolrConstants.DOCTYPE);
            subDocFields.add("MD_VALUE");
            subDocFields.addAll(coordinateFields);
            Collection<GeoMapFeature> features = new ArrayList<>();
            List<DisplayUserGeneratedContent> annos = DataManager.getInstance() .getDao() .getAnnotationsForWork(pi) .stream() .filter(a -> PublicationStatus.PUBLISHED.equals(a.getPublicationStatus())) .filter(a -> StringUtils.isNotBlank(a.getBody())) .map(a -> new DisplayUserGeneratedContent(a)) .filter(a -> ContentType.GEOLOCATION.equals(a.getType())) .filter(a -> ContentBean.isAccessible(a, BeanUtils.getRequest())) .collect(Collectors.toList());
            for (DisplayUserGeneratedContent anno : annos) {
                if (anno.getAnnotationBody() instanceof TypedResource) {
                    GeoMapFeature feature = new GeoMapFeature(((TypedResource) anno.getAnnotationBody()).asJson());
                    features.add(feature);
                }
                
            }
            
            SolrDocumentList subDocs = DataManager.getInstance().getSearchIndex().getDocs(subDocQuery, subDocFields);
            if (subDocs != null) {
                for (SolrDocument solrDocument : subDocs) {
                    List<GeoMapFeature> docFeatures = new ArrayList<>();
                    for (String coordinateField : coordinateFields) {
                        String docType = solrDocument.getFieldValue(SolrConstants.DOCTYPE).toString();
                        String labelField = "METADATA".equals(docType) ? "MD_VALUE" : SolrConstants.LABEL;
                        docFeatures.addAll(GeoMap.getGeojsonPoints(solrDocument, coordinateField, labelField, null));
                    }
                    
                    if (!solrDocument.containsKey(SolrConstants.ISWORK) && solrDocument.getFieldValue(SolrConstants.DOCTYPE).equals("DOCSTRCT")) {
                        docFeatures.forEach(f -> f.setLink(PrettyUrlTools.getRecordUrl(solrDocument, pageType)));
                    }
                     else {
                        docFeatures.forEach(f -> f.setLink(null));
                    }
                    
                    docFeatures.forEach(f -> f.setDocumentId((String) solrDocument.getFieldValue(SolrConstants.LOGID)));
                    features.addAll(docFeatures);
                }
                
            }
            
            features = features.stream().distinct().collect(Collectors.toList());
            if (!features.isEmpty()) {
                map.setFeatures(features.stream().map(f -> f.getJsonObject().toString()).collect(Collectors.toList()));
            }
            
            return map;
        }
         catch (IndexUnreachableException e) {
            logger.error("Unable to load geomap", e);
            return null;
        }
        
    }
    
    public void toggleDownloadImageModal() {
        downloadImageModalVisible = !downloadImageModalVisible;
    }
    
    public boolean isDownloadImageModalVisible() {
        return downloadImageModalVisible;
    }
    
    public DownloadOption getSelectedDownloadOption() {
        if (selectedDownloadOptionLabel == null) {
            return null;
        }
        
        return DownloadOption.getByLabel(selectedDownloadOptionLabel);
    }
    
    public String getSelectedDownloadOptionLabel() {
        return selectedDownloadOptionLabel;
    }
    
    public void setSelectedDownloadOptionLabel(String selectedDownloadOptionLabel) {
        logger.trace("setSelectedDownloadOption: {}", selectedDownloadOptionLabel != null ? selectedDownloadOptionLabel : null);
        this.selectedDownloadOptionLabel = selectedDownloadOptionLabel;
    }
    
    public void setDownloadOptionLabelFromRequestParameter() {
        Map<String, String> params = FacesContext.getCurrentInstance().getExternalContext().getRequestParameterMap();
        String value = params.get("optionvalue");
        if (StringUtils.isNotBlank(value)) {
            setSelectedDownloadOptionLabel(value);
        }
        
    }
    
    public String setDoublePageModeAction(boolean doublePageMode) throws IndexUnreachableException, DAOException {
        if (viewManager == null) {
            return "";
        }
        
        try {
            if (viewManager.isDoublePageMode() != doublePageMode) {
                if (doublePageMode && !viewManager.getCurrentPage().isDoubleImage()) {
                    Optional<PhysicalElement> currentLeftPage = viewManager.getCurrentLeftPage();
                    Optional<PhysicalElement> currentRightPage = viewManager.getCurrentRightPage();
                    if (currentLeftPage.isPresent() && currentRightPage.isPresent()) {
                        imageToShow = currentLeftPage.get().getOrder() + "-" + currentRightPage.get().getOrder();
                    }
                     else if (currentLeftPage.isPresent()) {
                        imageToShow = currentLeftPage.get().getOrder() + "-" + currentLeftPage.get().getOrder();
                    }
                     else if (currentRightPage.isPresent()) {
                        imageToShow = currentRightPage.get().getOrder() + "-" + currentRightPage.get().getOrder();
                    }
                    
                }
                 else if (doublePageMode) {
                    imageToShow = String.valueOf(viewManager.getCurrentPage().getOrder() + "-" + viewManager.getCurrentPage().getOrder());
                }
                 else {
                    imageToShow = String.valueOf(viewManager.getCurrentPage().getOrder());
                }
                
            }
            
        }
         finally {
            viewManager.setDoublePageMode(doublePageMode);
        }
        
        if (PrettyContext.getCurrentInstance() != null && PrettyContext.getCurrentInstance().getCurrentMapping() != null) {
            return "pretty:" + PrettyContext.getCurrentInstance().getCurrentMapping().getId();
        }
        
        return "";
    }
    
    public synchronized boolean isAllowUserComments() throws DAOException {
        if (viewManager == null) {
            return false;
        }
        
        CommentGroup commentGroupAll = DataManager.getInstance().getDao().getCommentGroupUnfiltered();
        if (commentGroupAll == null) {
            logger.warn("Comment view for all comments not found in the DB, please insert.");
            return false;
        }
        
        if (!commentGroupAll.isEnabled()) {
            logger.trace("User comments disabled globally.");
            viewManager.setAllowUserComments(false);
            return false;
        }
        
        if (viewManager.isAllowUserComments() == null) {
            try {
                if (StringUtils.isNotEmpty(commentGroupAll.getSolrQuery()) && DataManager.getInstance() .getSearchIndex() .getHitCount(new StringBuilder("+").append(SolrConstants.PI) .append(':') .append(viewManager.getPi()) .append(" +(") .append(commentGroupAll.getSolrQuery()) .append(')') .toString()) == 0) {
                    viewManager.setAllowUserComments(false);
                    logger.trace("User comments are not allowed for this record.");
                }
                 else {
                    viewManager.setAllowUserComments(true);
                }
                
            }
             catch (IndexUnreachableException e) {
                logger.debug("IndexUnreachableException thrown here: {}", e.getMessage());
                return false;
            }
             catch (PresentationException e) {
                logger.debug(StringConstants.LOG_PRESENTATION_EXCEPTION_THROWN_HERE, e.getMessage());
                return false;
            }
            
        }
        
        return viewManager.isAllowUserComments();
    }
    
    public boolean isRequiresWebSocket() {
        if (viewManager != null && viewManager.getTopStructElement() != null && viewManager.getTopStructElement().getMetadataFields() != null) {
            return viewManager.getTopStructElement().getMetadataFields().containsKey(SolrConstants.ACCESSCONDITION_CONCURRENTUSE);
        }
        
        return false;
    }
    
}


