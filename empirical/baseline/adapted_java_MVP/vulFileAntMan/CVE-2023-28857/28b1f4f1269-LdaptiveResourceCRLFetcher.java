package org.apereo.cas.adaptors.x509.authentication.ldap;
import org.apereo.cas.adaptors.x509.authentication.ResourceCRLFetcher;
import org.apereo.cas.util.EncodingUtils;
import org.apereo.cas.util.LdapUtils;
import org.apereo.cas.util.LoggingUtils;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import lombok.val;
import org.ldaptive.ConnectionConfig;
import org.ldaptive.ConnectionFactory;
import org.ldaptive.DefaultConnectionFactory;
import org.ldaptive.LdapAttribute;
import org.ldaptive.LdapException;
import org.ldaptive.SearchOperation;
import org.ldaptive.SearchResponse;
import org.springframework.core.io.ByteArrayResource;
import org.springframework.core.io.Resource;
import java.net.URI;
import java.net.URL;
import java.security.cert.CertificateException;
import java.security.cert.X509CRL;
import java.util.Objects;
public class LdaptiveResourceCRLFetcher extends ResourceCRLFetcher {
    private final ConnectionConfig connectionConfig;
    private final SearchOperation searchOperation;
    private final String certificateAttribute;
    public X509CRL fetch(final Resource crl) throws Exception {
        if (LdapUtils.isLdapConnectionUrl(crl.toString())) {
            return fetchCRLFromLdap(crl);
        }
        
        return super.fetch(crl);
    }
    
    public X509CRL fetch(final URI crl) throws Exception {
        if (LdapUtils.isLdapConnectionUrl(crl)) {
            return fetchCRLFromLdap(crl);
        }
        
        return super.fetch(crl);
    }
    
    public X509CRL fetch(final URL crl) throws Exception {
        if (LdapUtils.isLdapConnectionUrl(crl)) {
            return fetchCRLFromLdap(crl);
        }
        
        return super.fetch(crl);
    }
    
    public X509CRL fetch(final String crl) throws Exception {
        if (LdapUtils.isLdapConnectionUrl(crl)) {
            return fetchCRLFromLdap(crl);
        }
        
        return super.fetch(crl);
    }
    
    protected X509CRL fetchCRLFromLdap(final Object r) throws Exception {
        try {
            val ldapURL = r.toString();
            LOGGER.debug("Fetching CRL from ldap [{}]", ldapURL);
            val result = performLdapSearch(ldapURL);
            if (result.isSuccess()) {
                val entry = result.getEntry();
                val attribute = Objects.requireNonNull(entry.getAttribute(this.certificateAttribute), () -> String.format("Certificate attribute %s does not exist or has no value", this.certificateAttribute));
                if (attribute.isBinary()) {
                    LOGGER.debug("Located entry [{}]. Retrieving first attribute [{}]", entry, attribute);
                    return fetchX509CRLFromAttribute(attribute);
                }
                
                LOGGER.warn("Found certificate attribute [{}] but it is not marked as a binary attribute", this.certificateAttribute);
            }
            
            LOGGER.debug("Failed to execute the search [{}]", result);
            throw new CertificateException("Failed to establish a connection ldap and search.");
        }
         catch (final Exception e) {
            LoggingUtils.error(LOGGER, e);
            throw new CertificateException(e.getMessage());
        }
        
    }
    
    protected X509CRL fetchX509CRLFromAttribute(final LdapAttribute attribute) throws Exception {
        val val = attribute.getBinaryValue();
        val decoded64 = EncodingUtils.decodeBase64(val);
        LOGGER.trace("Retrieved CRL from ldap as byte array decoded in base64. Fetching...");
        return super.fetch(new ByteArrayResource(decoded64));
    }
    
    protected SearchResponse performLdapSearch(final String ldapURL) throws LdapException {
        val operation = SearchOperation.copy(this.searchOperation);
        operation.setConnectionFactory(prepareConnectionFactory(ldapURL));
        return operation.execute();
    }
    
    protected ConnectionFactory prepareConnectionFactory(final String ldapURL) {
        val config = ConnectionConfig.copy(this.connectionConfig);
        config.setLdapUrl(ldapURL);
        return new DefaultConnectionFactory(config);
    }
    
}


