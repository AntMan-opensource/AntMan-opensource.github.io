package org.keycloak.userprofile.validator;
import jakarta.ws.rs.core.Response;
import java.util.List;
import org.keycloak.models.KeycloakSession;
import org.keycloak.models.RealmModel;
import org.keycloak.models.UserModel;
import org.keycloak.models.utils.KeycloakModelUtils;
import org.keycloak.services.messages.Messages;
import org.keycloak.services.validation.Validation;
import org.keycloak.userprofile.UserProfileAttributeValidationContext;
import org.keycloak.validate.SimpleValidator;
import org.keycloak.validate.ValidationContext;
import org.keycloak.validate.ValidationError;
import org.keycloak.validate.ValidatorConfig;
public class DuplicateUsernameValidator implements SimpleValidator {
    public static final String ID = "up-duplicate-username";
    public String getId() {
        return ID;
    }
    
    public ValidationContext validate(Object input, String inputHint, ValidationContext context, ValidatorConfig config) {
        @SuppressWarnings("unchecked")
        List<String> values = (List<String>) input;
        if (values.isEmpty()) {
            return context;
        }
        
        String value = values.get(0);
        if (Validation.isBlank(value)){
            return context;
}
        KeycloakSession session = context.getSession();
        UserModel existing = session.users().getUserByUsername(session.getContext().getRealm(), value);
        UserModel user = UserProfileAttributeValidationContext.from(context).getAttributeContext().getUser();
        if (! KeycloakModelUtils.isUsernameCaseSensitive(session.getContext().getRealm())) value = value.toLowerCase();
        if (user != null && !value.equals(user.getFirstAttribute(UserModel.USERNAME)) && (existing != null && !existing.getId().equals(user.getId()))) {
            context.addError(new ValidationError(ID, inputHint, Messages.USERNAME_EXISTS) .setStatusCode(Response.Status.CONFLICT));
        }
        
        return context;
    }
    
}


