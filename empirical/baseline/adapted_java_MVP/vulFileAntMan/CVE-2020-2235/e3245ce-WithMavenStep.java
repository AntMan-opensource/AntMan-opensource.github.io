package org.jenkinsci.plugins.pipeline.maven;
import com.google.common.collect.ImmutableSet;
import hudson.DescriptorExtensionList;
import hudson.EnvVars;
import hudson.Extension;
import hudson.FilePath;
import hudson.Launcher;
import hudson.model.ItemGroup;
import hudson.model.JDK;
import hudson.model.Run;
import hudson.model.TaskListener;
import hudson.tasks.Maven;
import hudson.tasks.Maven.MavenInstallation;
import hudson.util.ListBoxModel;
import jenkins.model.Jenkins;
import jenkins.mvn.GlobalMavenConfig;
import jenkins.mvn.SettingsProvider;
import org.jenkinsci.lib.configprovider.model.Config;
import org.jenkinsci.plugins.configfiles.ConfigFiles;
import org.jenkinsci.plugins.configfiles.maven.GlobalMavenSettingsConfig.GlobalMavenSettingsConfigProvider;
import org.jenkinsci.plugins.configfiles.maven.MavenSettingsConfig.MavenSettingsConfigProvider;
import org.jenkinsci.plugins.workflow.steps.Step;
import org.jenkinsci.plugins.workflow.steps.StepContext;
import org.jenkinsci.plugins.workflow.steps.StepDescriptor;
import org.jenkinsci.plugins.workflow.steps.StepExecution;
import org.kohsuke.accmod.Restricted;
import org.kohsuke.accmod.restrictions.NoExternalUse;
import org.kohsuke.stapler.AncestorInPath;
import org.kohsuke.stapler.DataBoundConstructor;
import org.kohsuke.stapler.DataBoundSetter;
import java.util.ArrayList;
import java.util.List;
import java.util.Set;
public class WithMavenStep extends Step {
    private String tempBinDir = "";
    private String mavenSettingsConfig;
    private String mavenSettingsFilePath = "";
    private String globalMavenSettingsConfig;
    private String globalMavenSettingsFilePath = "";
    private String maven;
    private String mavenOpts = "";
    private String jdk;
    private String mavenLocalRepo = "";
    private List<MavenPublisher> options = new ArrayList<>();
    private MavenPublisherStrategy publisherStrategy = MavenPublisherStrategy.IMPLICIT;
    public WithMavenStep() {
    }
    
    public String getTempBinDir() {
        return tempBinDir;
    }
    
    public void setTempBinDir(String tempBinDir) {
        this.tempBinDir = tempBinDir;
    }
    
    public String getMavenSettingsConfig() {
        return mavenSettingsConfig;
    }
    
    public void setMavenSettingsConfig(String mavenSettingsConfig) {
        this.mavenSettingsConfig = mavenSettingsConfig;
    }
    
    public String getMavenSettingsFilePath() {
        return mavenSettingsFilePath;
    }
    
    public void setMavenSettingsFilePath(String mavenSettingsFilePath) {
        this.mavenSettingsFilePath = mavenSettingsFilePath;
    }
    
    public String getGlobalMavenSettingsConfig() {
        return globalMavenSettingsConfig;
    }
    
    public void setGlobalMavenSettingsConfig(String globalMavenSettingsConfig) {
        this.globalMavenSettingsConfig = globalMavenSettingsConfig;
    }
    
    public String getGlobalMavenSettingsFilePath() {
        return globalMavenSettingsFilePath;
    }
    
    public void setGlobalMavenSettingsFilePath(String globalMavenSettingsFilePath) {
        this.globalMavenSettingsFilePath = globalMavenSettingsFilePath;
    }
    
    public String getMaven() {
        return maven;
    }
    
    public void setMaven(String maven) {
        this.maven = maven;
    }
    
    public String getMavenOpts() {
        return mavenOpts;
    }
    
    public void setMavenOpts(String mavenOpts) {
        this.mavenOpts = mavenOpts;
    }
    
    public String getJdk() {
        return jdk;
    }
    
    public void setJdk(String jdk) {
        this.jdk = jdk;
    }
    
    public String getMavenLocalRepo() {
        return mavenLocalRepo;
    }
    
    public void setMavenLocalRepo(String mavenLocalRepo) {
        this.mavenLocalRepo = mavenLocalRepo;
    }
    
    public MavenPublisherStrategy getPublisherStrategy() {
        return publisherStrategy;
    }
    
    public void setPublisherStrategy(MavenPublisherStrategy publisherStrategy) {
        this.publisherStrategy = publisherStrategy;
    }
    
    public List<MavenPublisher> getOptions() {
        return options;
    }
    
    public WithMavenStep.DescriptorImpl getDescriptor() {
        return (WithMavenStep.DescriptorImpl) super.getDescriptor();
    }
    
    public DescriptorExtensionList<MavenPublisher, MavenPublisher.DescriptorImpl> getOptionsDescriptors() {
        return getDescriptor().getOptionsDescriptors();
    }
    
    public void setOptions(List<MavenPublisher> options) {
        this.options = options;
    }
    
    public StepExecution start(StepContext context) throws Exception {
        return new WithMavenStepExecution2(context, this);
    }
    
    public static class DescriptorImpl extends StepDescriptor {
        public String getFunctionName() {
            return "withMaven";
        }
        
        public String getDisplayName() {
            return "Provide Maven environment";
        }
        
        public boolean takesImplicitBlockArgument() {
            return true;
        }
        
        public Set<Class<?>> getRequiredContext() {
            return ImmutableSet.of(TaskListener.class, FilePath.class, Launcher.class, EnvVars.class, Run.class);
        }
        
        public SettingsProvider getDefaultSettingsProvider() {
            return GlobalMavenConfig.get().getSettingsProvider();
        }
        
        private Maven.DescriptorImpl getMavenDescriptor() {
            return Jenkins.getInstance().getDescriptorByType(Maven.DescriptorImpl.class);
        }
        
        public ListBoxModel doFillMavenItems() {
            ListBoxModel r = new ListBoxModel();
            r.add("--- Use system default Maven ---",null);
            for (MavenInstallation installation : getMavenDescriptor().getInstallations()) {
                r.add(installation.getName());
            }
            
            return r;
        }
        
        private JDK.DescriptorImpl getJDKDescriptor() {
            return Jenkins.getInstance().getDescriptorByType(JDK.DescriptorImpl.class);
        }
        
        public ListBoxModel doFillJdkItems() {
            ListBoxModel r = new ListBoxModel();
            r.add("--- Use system default JDK ---",null);
            for (JDK installation : getJDKDescriptor().getInstallations()) {
                r.add(installation.getName());
            }
            
            return r;
        }
        
        public ListBoxModel doFillMavenSettingsConfigItems(@AncestorInPath ItemGroup context) {
            ListBoxModel r = new ListBoxModel();
            r.add("--- Use system default settings or file path ---",null);
            for (Config config : ConfigFiles.getConfigsInContext(context, MavenSettingsConfigProvider.class)) {
                r.add(config.name, config.id);
            }
            
            return r;
        }
        
        public ListBoxModel doFillGlobalMavenSettingsConfigItems(@AncestorInPath ItemGroup context) {
            ListBoxModel r = new ListBoxModel();
            r.add("--- Use system default settings or file path ---",null);
            for (Config config : ConfigFiles.getConfigsInContext(context, GlobalMavenSettingsConfigProvider.class)) {
                r.add(config.name, config.id);
            }
            
            return r;
        }
        
        public ListBoxModel doFillPublisherStrategyItems(@AncestorInPath ItemGroup context) {
            ListBoxModel r = new ListBoxModel();
            for(MavenPublisherStrategy publisherStrategy: MavenPublisherStrategy.values()) {
                r.add(publisherStrategy.getDescription(), publisherStrategy.name());
            }
            
            return r;
        }
        
        public DescriptorExtensionList<MavenPublisher, MavenPublisher.DescriptorImpl> getOptionsDescriptors() {
            return Jenkins.getInstance().getDescriptorList(MavenPublisher.class);
        }
        
    }
    
}


