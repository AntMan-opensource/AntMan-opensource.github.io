package com.thoughtworks.xstream.core.util;
import java.lang.ref.Reference;
import java.lang.ref.WeakReference;
import java.util.AbstractMap;
import java.util.ArrayList;
import java.util.Collection;
import java.util.HashSet;
import java.util.Iterator;
import java.util.Map;
import java.util.Set;
import java.util.WeakHashMap;
public class WeakCache<K, V> extends AbstractMap<K, V> {
    private final Map<K, Reference<V>> map;
    public WeakCache() {
        this(new WeakHashMap<K, Reference<V>>());
    }
    
    public WeakCache(final Map<K, Reference<V>> map) {
        this.map = map;
    }
    
    public V get(final Object key) {
        final Reference<V> reference = map.get(key);
        return reference != null ? reference.get() : null;
    }
    
    public V put(final K key, final V value) {
        final Reference<V> ref = map.put(key, createReference(value));
        return ref == null ? null : ref.get();
    }
    
    public V remove(final Object key) {
        final Reference<V> ref = map.remove(key);
        return ref == null ? null : ref.get();
    }
    
    protected Reference<V> createReference(final V value) {
        return new WeakReference<>(value);
    }
    
    public boolean containsValue(final Object value) {
        final Boolean result = (Boolean)iterate(new Visitor() {
            public Object visit(final Object element) {
                return element.equals(value) ? Boolean.TRUE : null;
            }
            
        }, Visitor.Type.value);
        return result == Boolean.TRUE;
    }
    
    public int size() {
        if (map.isEmpty()) {
            return 0;
        }
        
        final int i[] = new int[1];
        i[0] = 0;
        iterate(new Visitor() {
            public Object visit(final Object element) { ++i[0];
                return null;
            }
            
        }, Visitor.Type.key);
        return i[0];
    }
    
    public Collection<V> values() {
        final Collection<V> collection = new ArrayList<>();
        if (!map.isEmpty()) {
            iterate(new Visitor() {
                public Object visit(final Object element) {
                    @SuppressWarnings("unchecked")
                    final V value = (V)element;
                    collection.add(value);
                    return null;
                }
                
            }, Visitor.Type.value);
        }
        
        return collection;
    }
    
    public Set<Map.Entry<K, V>> entrySet() {
        final Set<Map.Entry<K, V>> set = new HashSet<>();
        if (!map.isEmpty()) {
            iterate(new Visitor() {
                public Object visit(final Object element) {
                    @SuppressWarnings("unchecked")
                    final Map.Entry<K, Reference<V>> entry = (Map.Entry<K, Reference<V>>)element;
                    set.add(new Map.Entry<K, V>() {
                        public K getKey() {
                            return entry.getKey();
                        }
                        
                        public V getValue() {
                            return entry.getValue().get();
                        }
                        
                        public V setValue(final V value) {
                            final Reference<V> reference = entry.setValue(createReference(value));
                            return reference != null ? reference.get() : null;
                        }
                        
                    }
                    
);
                    return null;
                }
                
            }, Visitor.Type.entry);
        }
        
        return set;
    }
    
    private Object iterate(final Visitor visitor, final Visitor.Type type) {
        Object result = null;
        for (final Iterator<Map.Entry<K, Reference<V>>> iter = map.entrySet().iterator(); result == null && iter.hasNext();) {
            final Map.Entry<K, Reference<V>> entry = iter.next();
            final Reference<V> reference = entry.getValue();
            final V element = reference.get();
            if (element == null) {
                iter.remove();
                continue;
            }
            
            switch (type) {
            case value:
                result = visitor.visit(element);
                break;
            case key:
                result = visitor.visit(entry.getKey());
                break;
            case entry:
                result = visitor.visit(entry);
                break;
            }
            
        }
        
        return result;
    }
    
    private interface Visitor {
        enum Type {key, value, entry};
        Object visit(Object element);
    }
    
    public boolean containsKey(final Object key) {
        return map.containsKey(key);
    }
    
    public void clear() {
        map.clear();
    }
    
    public Set<K> keySet() {
        return map.keySet();
    }
    
    public boolean equals(final Object o) {
        return map.equals(o);
    }
    
    public int hashCode() {
        return map.hashCode();
    }
    
    public String toString() {
        return map.toString();
    }
    
}


