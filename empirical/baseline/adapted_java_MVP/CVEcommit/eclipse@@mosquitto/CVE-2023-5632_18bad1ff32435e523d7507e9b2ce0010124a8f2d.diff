commit 18bad1ff32435e523d7507e9b2ce0010124a8f2d
Author: Przemek Zygmunt <p.zygmunt@acsoftware.pl>
Date:   Wed Jan 27 18:29:50 2021 +0100

    Unconditionally adding an event to the epoll causes 100% CPU usage. This happens when the connection to the server is established and the client has not sent any data yet.
    
    Signed-off-by: Przemek Zygmunt <p.zygmunt@acsoftware.pl>

diff --git a/lib/packet_mosq.c b/lib/packet_mosq.c
index ad2a3aae..84f93cb8 100644
--- a/lib/packet_mosq.c
+++ b/lib/packet_mosq.c
@@ -216,7 +216,9 @@ int packet__write(struct mosquitto *mosq)
 	if(mosq->sock == INVALID_SOCKET) return MOSQ_ERR_NO_CONN;
 
 #ifdef WITH_BROKER
-	mux__add_out(mosq);
+	if (mosq->current_out_packet) {
+	   mux__add_out(mosq);
+	}
 #endif
 
 	pthread_mutex_lock(&mosq->current_out_packet_mutex);
