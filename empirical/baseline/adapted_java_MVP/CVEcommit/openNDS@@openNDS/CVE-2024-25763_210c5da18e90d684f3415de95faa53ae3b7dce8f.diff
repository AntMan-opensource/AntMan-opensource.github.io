commit 210c5da18e90d684f3415de95faa53ae3b7dce8f
Author: Rob White <rob@blue-wave.net>
Date:   Wed Feb 28 08:36:44 2024 +0000

    Fix - use after free - we now delete the client instead of changing state
    Credit @LuMingYinDetect
    
    Signed-off-by: Rob White <rob@blue-wave.net>

diff --git a/src/auth.c b/src/auth.c
index 4c068b3..ef2c06d 100644
--- a/src/auth.c
+++ b/src/auth.c
@@ -216,11 +216,11 @@ static int auth_change_state(t_client *client, const unsigned int new_state, con
 	} else if (state == FW_MARK_AUTHENTICATED) {
 
 		if (new_state == FW_MARK_PREAUTHENTICATED) {
+			// we now delete the client instead of changing state to preauthenticated
 			iptables_fw_deauthenticate(client);
 			binauth_action(client, reason, customdata);
 			client_reset(client);
 			client_list_delete(client);
-			client->fw_connection_state = new_state;
 
 		} else if (new_state == FW_MARK_AUTH_BLOCKED) {
 			client->window_start = now;
