commit 0018b5e4e07a1465287e7dff69b387929f5a75fa
Author: Aurelien David <aurelien.david@telecom-paristech.fr>
Date:   Tue Aug 29 15:32:49 2023 +0200

    fix #2550: delete previously added command_buffers in case of error

diff --git a/src/bifs/memory_decoder.c b/src/bifs/memory_decoder.c
index faf35c16d..eed7e3fd1 100644
--- a/src/bifs/memory_decoder.c
+++ b/src/bifs/memory_decoder.c
@@ -902,6 +902,8 @@ GF_Err BM_ParseCommand(GF_BifsDecoder *codec, GF_BitStream *bs, GF_List *com_lis
 	GF_SceneGraph *cur_graph = codec->current_graph;
 	GF_Proto *cur_proto = codec->pCurrentProto;
 
+	u32 nbBufs = gf_list_count(codec->command_buffers);
+
 	codec->LastError = GF_OK;
 	while (go) {
 		type = gf_bs_read_int(bs, 2);
@@ -926,6 +928,15 @@ GF_Err BM_ParseCommand(GF_BifsDecoder *codec, GF_BitStream *bs, GF_List *com_lis
 		gf_bifs_dec_qp_remove(codec, GF_TRUE);
 	}
 
+	if (e) {
+		while (gf_list_count(codec->command_buffers) > nbBufs) {
+			CommandBufferItem *cbi;
+			cbi = (CommandBufferItem *)gf_list_pop_back(codec->command_buffers);
+			if (cbi->node) gf_node_unregister(cbi->node, NULL);
+			gf_free(cbi);
+		}
+	}
+
 	codec->current_graph = cur_graph;
 	codec->pCurrentProto = cur_proto;
 	return e;
