commit 0f0684d61914f1bf35cf26cc6a7df5920dd68120
Author: Jaylin <jaylin@emqx.io>
Date:   Wed May 17 18:24:53 2023 +0800

    * FIX [nmq_mqtt] pipe reaper needs a bigger lock #1180 of NanoMQ (potential performance degradation)

diff --git a/src/sp/protocol/mqtt/nmq_mqtt.c b/src/sp/protocol/mqtt/nmq_mqtt.c
index 954220f2..95c7cf15 100644
--- a/src/sp/protocol/mqtt/nmq_mqtt.c
+++ b/src/sp/protocol/mqtt/nmq_mqtt.c
@@ -403,8 +403,9 @@ nano_ctx_send(void *arg, nni_aio *aio)
 		return;
 	}
 
-	nni_mtx_unlock(&s->lk);
+	// 2 locks here cause performance degradation
 	nni_mtx_lock(&p->lk);
+	nni_mtx_unlock(&s->lk);
 
 	if (p->pipe->cache) {
 		if (nni_msg_get_type(msg) == CMD_PUBLISH) {
