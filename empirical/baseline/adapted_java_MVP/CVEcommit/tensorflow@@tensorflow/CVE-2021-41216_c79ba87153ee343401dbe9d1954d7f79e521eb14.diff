commit c79ba87153ee343401dbe9d1954d7f79e521eb14
Author: Penporn Koanantakool <penporn@google.com>
Date:   Thu Oct 14 19:39:00 2021 -0700

    Make Transpose's shape inference function validate that negative `perm` values are within the tensor's rank.
    
    PiperOrigin-RevId: 403252853
    Change-Id: Ia6b31b45b237312668bb31c2c3b3c7bbce2d2610

diff --git a/tensorflow/core/ops/array_ops.cc b/tensorflow/core/ops/array_ops.cc
index 64bd4f38478..14c9efae1dd 100644
--- a/tensorflow/core/ops/array_ops.cc
+++ b/tensorflow/core/ops/array_ops.cc
@@ -168,7 +168,7 @@ Status TransposeShapeFn(InferenceContext* c) {
 
     for (int32_t i = 0; i < rank; ++i) {
       int64_t in_idx = data[i];
-      if (in_idx >= rank) {
+      if (in_idx >= rank || in_idx <= -rank) {
         return errors::InvalidArgument("perm dim ", in_idx,
                                        " is out of range of input rank ", rank);
       }
