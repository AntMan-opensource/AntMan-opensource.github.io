commit 6a03106ac1eab39d0303662963589ecb2374c97f
Author: Fei Chen <feichen@meta.com>
Date:   Wed Nov 15 14:43:42 2023 -0800

    initialize all iphdr/icmphdr fields when generating iphdr/icmphdr
    
    Summary: as per title
    
    Reviewed By: avasylev
    
    Differential Revision: D51366550
    
    fbshipit-source-id: 3a5ccf0ba21c2f53c4f336cd6df72c64d62b9cc7

diff --git a/katran/lib/bpf/encap_helpers.h b/katran/lib/bpf/encap_helpers.h
index 16e88a65..f79c4a77 100644
--- a/katran/lib/bpf/encap_helpers.h
+++ b/katran/lib/bpf/encap_helpers.h
@@ -48,6 +48,7 @@ __attribute__((__always_inline__)) static inline void create_v4_hdr(
   iph->tos = DEFAULT_TOS;
 #endif
   iph->tot_len = bpf_htons(pkt_bytes + sizeof(struct iphdr));
+  iph->id = 0;
   iph->daddr = daddr;
   iph->saddr = saddr;
   iph->ttl = DEFAULT_TTL;
diff --git a/katran/lib/bpf/handle_icmp.h b/katran/lib/bpf/handle_icmp.h
index c2ef8071..7fe6dd47 100644
--- a/katran/lib/bpf/handle_icmp.h
+++ b/katran/lib/bpf/handle_icmp.h
@@ -145,6 +145,7 @@ __attribute__((__always_inline__)) static inline int send_icmp4_too_big(
   icmp_hdr->type = ICMP_DEST_UNREACH;
   icmp_hdr->code = ICMP_FRAG_NEEDED;
   icmp_hdr->un.frag.mtu = bpf_htons(MAX_PCKT_SIZE - sizeof(struct ethhdr));
+  icmp_hdr->un.frag.__unused = 0;
   icmp_hdr->checksum = 0;
   ipv4_csum(icmp_hdr, ICMP_TOOBIG_PAYLOAD_SIZE, &csum);
   icmp_hdr->checksum = csum;
@@ -157,6 +158,7 @@ __attribute__((__always_inline__)) static inline int send_icmp4_too_big(
   iph->protocol = IPPROTO_ICMP;
   iph->tos = 0;
   iph->tot_len = bpf_htons(ICMP_TOOBIG_SIZE + headroom - sizeof(struct ethhdr));
+  iph->id = 0;
   iph->check = 0;
   csum = 0;
   ipv4_csum(iph, sizeof(struct iphdr), &csum);
