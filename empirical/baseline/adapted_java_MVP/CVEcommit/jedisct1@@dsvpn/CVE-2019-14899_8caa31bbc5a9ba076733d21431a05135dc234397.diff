commit 8caa31bbc5a9ba076733d21431a05135dc234397
Author: Frank Denis <github@pureftpd.org>
Date:   Fri Dec 6 00:15:34 2019 +0100

    Add iptables rule to protect against CVE-2019-14899

diff --git a/src/os.c b/src/os.c
index ff4a8b6..d8ca536 100644
--- a/src/os.c
+++ b/src/os.c
@@ -487,35 +487,43 @@ Cmds firewall_rules_cmds(int is_server)
               NULL },
                           *unset_cmds[] = {
 #ifndef NO_DEFAULT_ROUTES
-                              "route delete $EXT_IP",         "route delete 0/1",
-                              "route delete 128/1",           "route delete -inet6 0000::/1",
+                              "route delete $EXT_IP",
+                              "route delete 0/1",
+                              "route delete 128/1",
+                              "route delete -inet6 0000::/1",
                               "route delete -inet6 8000::/1",
 #endif
                               NULL
                           };
 #elif defined(__linux__)
         static const char
-            *set_cmds[]   = { "sysctl net.ipv4.tcp_congestion_control=bbr",
-                            "ip link set dev $IF_NAME up",
-                            "ip addr add $LOCAL_TUN_IP peer $REMOTE_TUN_IP dev $IF_NAME",
-                            "ip -6 addr add $LOCAL_TUN_IP6 peer $REMOTE_TUN_IP6/96 dev $IF_NAME",
+            *set_cmds[] =
+                { "sysctl net.ipv4.tcp_congestion_control=bbr",
+                  "ip link set dev $IF_NAME up",
+                  "iptables -t raw -I PREROUTING ! -i $IF_NAME -d $LOCAL_TUN_IP -m addrtype ! "
+                  "--src-type LOCAL -j DROP",
+                  "ip addr add $LOCAL_TUN_IP peer $REMOTE_TUN_IP dev $IF_NAME",
+                  "ip -6 addr add $LOCAL_TUN_IP6 peer $REMOTE_TUN_IP6/96 dev $IF_NAME",
 #ifndef NO_DEFAULT_ROUTES
-                            "ip route add default dev $IF_NAME table 42069",
-                            "ip -6 route add default dev $IF_NAME table 42069",
-                            "ip rule add not fwmark 42069 table 42069",
-                            "ip -6 rule add not fwmark 42069 table 42069",
-                            "ip rule add table main suppress_prefixlength 0",
-                            "ip -6 rule add table main suppress_prefixlength 0",
+                  "ip route add default dev $IF_NAME table 42069",
+                  "ip -6 route add default dev $IF_NAME table 42069",
+                  "ip rule add not fwmark 42069 table 42069",
+                  "ip -6 rule add not fwmark 42069 table 42069",
+                  "ip rule add table main suppress_prefixlength 0",
+                  "ip -6 rule add table main suppress_prefixlength 0",
 #endif
-                            NULL },
+                  NULL },
             *unset_cmds[] = {
 #ifndef NO_DEFAULT_ROUTES
-                              "ip rule delete table 42069",
-                              "ip -6 rule delete table 42069",
-                              "ip rule delete table main suppress_prefixlength 0",
-                              "ip -6 rule delete table main suppress_prefixlength 0",
+                "ip rule delete table 42069",
+                "ip -6 rule delete table 42069",
+                "ip rule delete table main suppress_prefixlength 0",
+                "ip -6 rule delete table main suppress_prefixlength 0",
+                "iptables -t raw -D PREROUTING ! -i $IF_NAME -d $LOCAL_TUN_IP -m addrtype ! "
+                "--src-type LOCAL -j DROP",
 #endif
-                              NULL };
+                NULL
+            };
 #else
         static const char *const *set_cmds = NULL, *const *unset_cmds = NULL;
 #endif
