commit 64278c9127e3333342b56ead99556161f7e86f79
Author: Philip Withnall <pwithnall@endlessos.org>
Date:   Wed Mar 15 16:28:35 2023 +0000

    pk-transaction: Check that Finished signal is emitted at most once
    
    While I havenâ€™t seen it being emitted more than once, the transaction
    code is quite complex, and it would make things more robust to add a
    check to verify this.
    
    Signed-off-by: Philip Withnall <pwithnall@endlessos.org>

diff --git a/src/pk-transaction.c b/src/pk-transaction.c
index 192ef2347..ad53cace1 100644
--- a/src/pk-transaction.c
+++ b/src/pk-transaction.c
@@ -90,6 +90,7 @@ struct PkTransactionPrivate
 	guint			 speed;
 	guint			 download_size_remaining;
 	gboolean		 finished;
+	gboolean		 emitted_finished;
 	gboolean		 allow_cancel;
 	gboolean		 waiting_for_auth;
 	gboolean		 emit_eula_required;
@@ -510,6 +511,9 @@ pk_transaction_finished_emit (PkTransaction *transaction,
 			      PkExitEnum exit_enum,
 			      guint time_ms)
 {
+	g_assert (!transaction->priv->emitted_finished);
+	transaction->priv->emitted_finished = TRUE;
+
 	g_debug ("emitting finished '%s', %i",
 		 pk_exit_enum_to_string (exit_enum),
 		 time_ms);
