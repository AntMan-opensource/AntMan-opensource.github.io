commit 040b0d1327bfb0a8e35c23c2bd612a4a39b721d4
Merge: b1f966aa 8c684293
Author: Peter Doornbosch <peter.doornbosch@luminis.eu>
Date:   Sat Sep 23 16:42:11 2023 +0200

    Merge branch 'discard-keys'

diff --cc src/main/java/net/luminis/quic/QuicConnectionImpl.java
index 286d2ae6,f04d6f14..1a065469
--- a/src/main/java/net/luminis/quic/QuicConnectionImpl.java
+++ b/src/main/java/net/luminis/quic/QuicConnectionImpl.java
@@@ -202,14 -202,14 +203,16 @@@ public abstract class QuicConnectionImp
                      parsedPacket = null;
                  }
  
 -                processPacket(timeReceived, packet);
 -                getSender().packetProcessed(data.hasRemaining());
 +                if (checkDestinationConnectionId(packet)) {
 +                    processPacket(timeReceived, packet);
 +                    getSender().packetProcessed(data.hasRemaining());
 +                }
              }
              catch (DecryptionException | MissingKeysException cannotParse) {
-                 // https://tools.ietf.org/html/draft-ietf-quic-transport-24#section-12.2
-                 // "if decryption fails (...), the receiver (...) MUST attempt to process the remaining packets."
+                 // https://www.rfc-editor.org/rfc/rfc9000.html#name-coalescing-packets
+                 // "For example, if decryption fails (because the keys are not available or for any other reason), the
+                 //  receiver MAY either discard or buffer the packet for later processing and MUST attempt to process the
+                 //  remaining packets."
                  int nrOfPacketBytes = data.position();
                  if (nrOfPacketBytes == 0) {
                      // Nothing could be made out of it, so the whole datagram will be discarded
