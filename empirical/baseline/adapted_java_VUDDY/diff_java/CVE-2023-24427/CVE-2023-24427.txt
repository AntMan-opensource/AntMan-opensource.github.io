commit b73ac285f8cfcc9727f089c6b2c7f13412285e7c
Author: mallowlabs <mallowlabs@gmail.com>
Date:   Sun Dec 25 21:31:32 2022 +0900

    [SECURITY-2982] fix session fixation vulnerability
    
    https://issues.jenkins.io/browse/SECURITY-2982

diff --git a/src/main/java/org/jenkinsci/plugins/BitbucketSecurityRealm.java b/src/main/java/org/jenkinsci/plugins/BitbucketSecurityRealm.java
index d5054dc..bf68a2a 100644
--- a/src/main/java/org/jenkinsci/plugins/BitbucketSecurityRealm.java
+++ b/src/main/java/org/jenkinsci/plugins/BitbucketSecurityRealm.java
@@ -4,6 +4,8 @@ import java.io.IOException;
 import java.util.logging.Level;
 import java.util.logging.Logger;
 
+import javax.servlet.http.HttpSession;
+
 import org.acegisecurity.Authentication;
 import org.acegisecurity.AuthenticationException;
 import org.acegisecurity.AuthenticationManager;
@@ -147,11 +149,20 @@ public class BitbucketSecurityRealm extends SecurityRealm {
             return HttpResponses.redirectToContextRoot();
         }
 
-        if (state == null || !StringUtils.equals(state, (String) request.getSession().getAttribute(STATE_ATTRIBUTE))) {
+        if (state == null || !StringUtils.equals(state, getSessionAttribute(request, STATE_ATTRIBUTE))) {
             LOGGER.log(Level.SEVERE, "doFinishLogin() invalid state parameter");
             return HttpResponses.redirectToContextRoot();
         }
 
+        String referer = getSessionAttribute(request, REFERER_ATTRIBUTE);
+
+        // avoid session fixation vulnerability
+        HttpSession session = request.getSession(false);
+        if (session != null) {
+            session.invalidate();
+        }
+        request.getSession(true);
+
         String rawClientSecret = getSecretClientSecret().getPlainText();
 
         Token accessToken = new BitbucketApiService(clientID, rawClientSecret).getTokenByAuthorizationCode(code, null);
@@ -175,7 +186,6 @@ public class BitbucketSecurityRealm extends SecurityRealm {
         }
 
         // redirect to referer
-        String referer = (String) request.getSession().getAttribute(REFERER_ATTRIBUTE);
         if (referer != null) {
             return HttpResponses.redirectTo(referer);
         } else {
@@ -237,6 +247,14 @@ public class BitbucketSecurityRealm extends SecurityRealm {
         return "securityRealm/commenceLogin";
     }
 
+    private String getSessionAttribute(StaplerRequest request, String attributeName) {
+        HttpSession session = request.getSession(false);
+        if (session == null) {
+            return null;
+        }
+        return (String) session.getAttribute(attributeName);
+    }
+
     public static final class ConverterImpl implements Converter {
 
         public boolean canConvert(Class type) {
