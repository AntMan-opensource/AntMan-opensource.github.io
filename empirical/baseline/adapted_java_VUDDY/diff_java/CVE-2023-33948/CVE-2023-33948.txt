commit bff08fc391cfd61b788b0121b49f598d5eb8173e
Author: Carolina Barbosa <carolina.barbosa@liferay.com>
Date:   Thu Mar 2 15:42:37 2023 -0300

    LPS-175631 Make sure the file entry is associated with a form and restrict the download to users who have permission to view responses in this form

diff --git a/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-field-type/src/main/java/com/liferay/dynamic/data/mapping/form/field/type/internal/document/library/DocumentLibraryDDMFormFieldTemplateContextContributor.java b/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-field-type/src/main/java/com/liferay/dynamic/data/mapping/form/field/type/internal/document/library/DocumentLibraryDDMFormFieldTemplateContextContributor.java
index 2d7eff5468129..604af0d193b7b 100644
--- a/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-field-type/src/main/java/com/liferay/dynamic/data/mapping/form/field/type/internal/document/library/DocumentLibraryDDMFormFieldTemplateContextContributor.java
+++ b/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-field-type/src/main/java/com/liferay/dynamic/data/mapping/form/field/type/internal/document/library/DocumentLibraryDDMFormFieldTemplateContextContributor.java
@@ -141,9 +141,7 @@ public class DocumentLibraryDDMFormFieldTemplateContextContributor
 				return value;
 			}
 		).putAll(
-			_getFileEntryParameters(
-				ddmFormFieldRenderingContext.getHttpServletRequest(),
-				ddmFormFieldRenderingContext.getValue())
+			_getFileEntryParameters(ddmFormField, ddmFormFieldRenderingContext)
 		).putAll(
 			_getUploadParameters(ddmFormField, ddmFormFieldRenderingContext)
 		).build();
@@ -354,7 +352,10 @@ public class DocumentLibraryDDMFormFieldTemplateContextContributor
 	}
 
 	private Map<String, Object> _getFileEntryParameters(
-		HttpServletRequest httpServletRequest, String value) {
+		DDMFormField ddmFormField,
+		DDMFormFieldRenderingContext ddmFormFieldRenderingContext) {
+
+		String value = ddmFormFieldRenderingContext.getValue();
 
 		if (Validator.isNull(value)) {
 			return new HashMap<>();
@@ -379,12 +380,18 @@ public class DocumentLibraryDDMFormFieldTemplateContextContributor
 
 				RequestBackedPortletURLFactory requestBackedPortletURLFactory =
 					RequestBackedPortletURLFactoryUtil.create(
-						httpServletRequest);
+						ddmFormFieldRenderingContext.getHttpServletRequest());
 
 				return ResourceURLBuilder.createResourceURL(
 					(ResourceURL)
 						requestBackedPortletURLFactory.createResourceURL(
 							DDMPortletKeys.DYNAMIC_DATA_MAPPING_FORM)
+				).setParameter(
+					"ddmFormFieldName", ddmFormField.getName()
+				).setParameter(
+					"ddmFormInstanceRecordId",
+					ddmFormFieldRenderingContext.getProperty(
+						"ddmFormInstanceRecordId")
 				).setParameter(
 					"fileEntryId", fileEntry.getFileEntryId()
 				).setResourceID(
diff --git a/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-renderer/src/main/java/com/liferay/dynamic/data/mapping/form/renderer/internal/DDMFormFieldTemplateContextFactory.java b/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-renderer/src/main/java/com/liferay/dynamic/data/mapping/form/renderer/internal/DDMFormFieldTemplateContextFactory.java
index d44dc2866376a..1da166d37c167 100644
--- a/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-renderer/src/main/java/com/liferay/dynamic/data/mapping/form/renderer/internal/DDMFormFieldTemplateContextFactory.java
+++ b/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-renderer/src/main/java/com/liferay/dynamic/data/mapping/form/renderer/internal/DDMFormFieldTemplateContextFactory.java
@@ -148,6 +148,17 @@ public class DDMFormFieldTemplateContextFactory {
 		ddmFormFieldRenderingContext.setProperties(ddmFormFieldTemplateContext);
 		ddmFormFieldRenderingContext.setProperty(
 			"changedProperties", changedProperties);
+
+		Long ddmFormInstanceRecordId = _ddmFormRenderingContext.getProperty(
+			"ddmFormInstanceRecordId");
+
+		if ((ddmFormInstanceRecordId != null) &&
+			(ddmFormInstanceRecordId > 0)) {
+
+			ddmFormFieldRenderingContext.setProperty(
+				"ddmFormInstanceRecordId", ddmFormInstanceRecordId);
+		}
+
 		ddmFormFieldRenderingContext.setProperty(
 			"groupId", _ddmFormRenderingContext.getGroupId());
 		ddmFormFieldRenderingContext.setReturnFullContext(
diff --git a/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-web/src/main/java/com/liferay/dynamic/data/mapping/form/web/internal/display/context/DDMFormViewFormInstanceRecordDisplayContext.java b/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-web/src/main/java/com/liferay/dynamic/data/mapping/form/web/internal/display/context/DDMFormViewFormInstanceRecordDisplayContext.java
index 91688746e2c20..f29f75f2d25b4 100644
--- a/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-web/src/main/java/com/liferay/dynamic/data/mapping/form/web/internal/display/context/DDMFormViewFormInstanceRecordDisplayContext.java
+++ b/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-web/src/main/java/com/liferay/dynamic/data/mapping/form/web/internal/display/context/DDMFormViewFormInstanceRecordDisplayContext.java
@@ -105,7 +105,7 @@ public class DDMFormViewFormInstanceRecordDisplayContext {
 			return _ddmFormRenderer.getDDMFormTemplateContext(
 				latestDDMForm, latestDDMStructureVersion.getDDMFormLayout(),
 				_createDDMFormRenderingContext(
-					latestDDMForm,
+					latestDDMForm, ddmFormInstanceRecord,
 					_getDDMFormValues(
 						renderRequest, latestDDMForm,
 						ddmFormInstanceRecord.getDDMFormValues()),
@@ -123,7 +123,7 @@ public class DDMFormViewFormInstanceRecordDisplayContext {
 
 		DDMFormRenderingContext ddmFormRenderingContext =
 			_createDDMFormRenderingContext(
-				currentDDMForm,
+				currentDDMForm, ddmFormInstanceRecord,
 				_getDDMFormValues(
 					renderRequest, currentDDMForm,
 					ddmFormInstanceRecord.getDDMFormValues()),
@@ -142,11 +142,16 @@ public class DDMFormViewFormInstanceRecordDisplayContext {
 	}
 
 	private DDMFormRenderingContext _createDDMFormRenderingContext(
-		DDMForm ddmForm, DDMFormValues ddmFormValues, boolean readOnly) {
+		DDMForm ddmForm, DDMFormInstanceRecord ddmFormInstanceRecord,
+		DDMFormValues ddmFormValues, boolean readOnly) {
 
 		DDMFormRenderingContext ddmFormRenderingContext =
 			new DDMFormRenderingContext();
 
+		ddmFormRenderingContext.addProperty(
+			"ddmFormInstanceRecordId",
+			ddmFormInstanceRecord.getFormInstanceRecordId());
+
 		String redirectURL = ParamUtil.getString(
 			_ddmFormAdminRequestHelper.getRequest(), "redirect");
 
diff --git a/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-web/src/main/java/com/liferay/dynamic/data/mapping/form/web/internal/portlet/action/DownloadFileEntryMVCResourceCommand.java b/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-web/src/main/java/com/liferay/dynamic/data/mapping/form/web/internal/portlet/action/DownloadFileEntryMVCResourceCommand.java
index eeadfe8bc55d8..c54c1f9e07905 100644
--- a/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-web/src/main/java/com/liferay/dynamic/data/mapping/form/web/internal/portlet/action/DownloadFileEntryMVCResourceCommand.java
+++ b/modules/apps/dynamic-data-mapping/dynamic-data-mapping-form-web/src/main/java/com/liferay/dynamic/data/mapping/form/web/internal/portlet/action/DownloadFileEntryMVCResourceCommand.java
@@ -16,12 +16,25 @@ package com.liferay.dynamic.data.mapping.form.web.internal.portlet.action;
 
 import com.liferay.document.library.kernel.service.DLAppLocalService;
 import com.liferay.dynamic.data.mapping.constants.DDMPortletKeys;
+import com.liferay.dynamic.data.mapping.model.DDMFormInstanceRecord;
+import com.liferay.dynamic.data.mapping.model.Value;
+import com.liferay.dynamic.data.mapping.service.DDMFormInstanceRecordService;
+import com.liferay.dynamic.data.mapping.storage.DDMFormFieldValue;
+import com.liferay.dynamic.data.mapping.storage.DDMFormValues;
+import com.liferay.portal.kernel.json.JSONFactory;
+import com.liferay.portal.kernel.json.JSONObject;
 import com.liferay.portal.kernel.portlet.PortletResponseUtil;
 import com.liferay.portal.kernel.portlet.bridges.mvc.BaseMVCResourceCommand;
 import com.liferay.portal.kernel.portlet.bridges.mvc.MVCResourceCommand;
 import com.liferay.portal.kernel.repository.model.FileEntry;
+import com.liferay.portal.kernel.theme.ThemeDisplay;
 import com.liferay.portal.kernel.util.MimeTypesUtil;
 import com.liferay.portal.kernel.util.ParamUtil;
+import com.liferay.portal.kernel.util.WebKeys;
+
+import java.util.List;
+import java.util.Map;
+import java.util.Objects;
 
 import javax.portlet.ResourceRequest;
 import javax.portlet.ResourceResponse;
@@ -47,8 +60,48 @@ public class DownloadFileEntryMVCResourceCommand
 			ResourceRequest resourceRequest, ResourceResponse resourceResponse)
 		throws Exception {
 
-		FileEntry fileEntry = _dlAppLocalService.getFileEntry(
-			ParamUtil.getLong(resourceRequest, "fileEntryId"));
+		long fileEntryId = 0;
+
+		DDMFormInstanceRecord ddmFormInstanceRecord =
+			_ddmFormInstanceRecordService.getFormInstanceRecord(
+				ParamUtil.getLong(resourceRequest, "ddmFormInstanceRecordId"));
+
+		DDMFormValues ddmFormValues = ddmFormInstanceRecord.getDDMFormValues();
+
+		Map<String, List<DDMFormFieldValue>> ddmFormFieldValuesMap =
+			ddmFormValues.getDDMFormFieldValuesMap(true);
+
+		ThemeDisplay themeDisplay = (ThemeDisplay)resourceRequest.getAttribute(
+			WebKeys.THEME_DISPLAY);
+
+		for (DDMFormFieldValue ddmFormFieldValue :
+				ddmFormFieldValuesMap.get(
+					ParamUtil.getString(resourceRequest, "ddmFormFieldName"))) {
+
+			Value value = ddmFormFieldValue.getValue();
+
+			if (value == null) {
+				continue;
+			}
+
+			JSONObject valueJSONObject = _jsonFactory.createJSONObject(
+				value.getString(themeDisplay.getLocale()));
+
+			if (valueJSONObject.isNull("fileEntryId")) {
+				continue;
+			}
+
+			if (Objects.equals(
+					valueJSONObject.getLong("fileEntryId"),
+					ParamUtil.getLong(resourceRequest, "fileEntryId"))) {
+
+				fileEntryId = valueJSONObject.getLong("fileEntryId");
+
+				break;
+			}
+		}
+
+		FileEntry fileEntry = _dlAppLocalService.getFileEntry(fileEntryId);
 
 		PortletResponseUtil.sendFile(
 			resourceRequest, resourceResponse, fileEntry.getFileName(),
@@ -56,7 +109,13 @@ public class DownloadFileEntryMVCResourceCommand
 			MimeTypesUtil.getContentType(fileEntry.getFileName()));
 	}
 
+	@Reference
+	private DDMFormInstanceRecordService _ddmFormInstanceRecordService;
+
 	@Reference
 	private DLAppLocalService _dlAppLocalService;
 
+	@Reference
+	private JSONFactory _jsonFactory;
+
 }
\ No newline at end of file
