commit 5648a0c27c2c2667c98419254557a14bac2b1f3f
Author: Achim Kraus <achim.kraus@cloudcoap.net>
Date:   Fri Sep 16 09:06:33 2022 +0200

    Run all pending job on removing connections.
    
    Prevent gaps in pendingOutboundMessagesCountdown.
    
    Signed-off-by: Achim Kraus <achim.kraus@cloudcoap.net>

diff --git a/scandium-core/src/main/java/org/eclipse/californium/scandium/DTLSConnector.java b/scandium-core/src/main/java/org/eclipse/californium/scandium/DTLSConnector.java
index d5d4b8b86..1cb67d3f2 100644
--- a/scandium-core/src/main/java/org/eclipse/californium/scandium/DTLSConnector.java
+++ b/scandium-core/src/main/java/org/eclipse/californium/scandium/DTLSConnector.java
@@ -1035,7 +1035,7 @@ public class DTLSConnector implements Connector, RecordLayer {
 		for (Runnable job : pending) {
 			try {
 				job.run();
-			} catch (Exception e) {
+			} catch (Throwable e) {
 				LOGGER.warn("Shutdown DTLS connector:", e);
 			}
 		}
@@ -1401,7 +1401,7 @@ public class DTLSConnector implements Connector, RecordLayer {
 
 					@Override
 					public void run() {
-						if (running.get()) {
+						if (running.get() && connection.isExecuting()) {
 							processRecord(record, connection);
 						}
 					}
@@ -1971,7 +1971,7 @@ public class DTLSConnector implements Connector, RecordLayer {
 						connection.getExecutor().execute(new Runnable() {
 							@Override
 							public void run() {
-								if (running.get()) {
+								if (running.get() && connections.getConnectionByAddress().isExecuting()) {
 									processClientHello(clientHello, record, connections);
 								}
 							}
@@ -2399,7 +2399,7 @@ public class DTLSConnector implements Connector, RecordLayer {
 					@Override
 					public void run() {
 						try {
-							if (running.get()) {
+							if (running.get() && connection.isExecuting()) {
 								sendMessage(now, message, connection);
 							} else {
 								DROP_LOGGER.trace("DTLSConnector drops {} outgoing bytes to {}:{}, connector not running!", message.getSize(), message.getAddress(), message.getPort());
@@ -2816,7 +2816,7 @@ public class DTLSConnector implements Connector, RecordLayer {
 
 					@Override
 					public void run() {
-						if (running.get()) {
+						if (running.get() && connection.isExecuting()) {
 							Handshaker handshaker = connection.getOngoingHandshake();
 							if (handshaker != null) {
 								try {
diff --git a/scandium-core/src/main/java/org/eclipse/californium/scandium/dtls/InMemoryConnectionStore.java b/scandium-core/src/main/java/org/eclipse/californium/scandium/dtls/InMemoryConnectionStore.java
index 3882be82e..5f3d0c95e 100644
--- a/scandium-core/src/main/java/org/eclipse/californium/scandium/dtls/InMemoryConnectionStore.java
+++ b/scandium-core/src/main/java/org/eclipse/californium/scandium/dtls/InMemoryConnectionStore.java
@@ -534,15 +534,27 @@ public class InMemoryConnectionStore implements ResumptionSupportingConnectionSt
 	public synchronized boolean remove(final Connection connection, final boolean removeFromSessionCache) {
 		boolean removed = connections.remove(connection.getConnectionId(), connection) == connection;
 		if (removed) {
-			List<Runnable> pendings = connection.getExecutor().shutdownNow();
+			int pending = 0;
+			SerialExecutor executor = connection.getExecutor();
+			if (executor != null) {
+				List<Runnable> pendings = connection.getExecutor().shutdownNow();
+				for (Runnable job : pendings) {
+					try {
+						job.run();
+					} catch (Throwable e) {
+						LOG.warn("Removing connection:", e);
+					}
+				}
+				pending = pendings.size();
+			}
 			if (LOG.isTraceEnabled()) {
 				LOG.trace("{}connection: remove {} (size {}, left jobs: {})", tag, connection, connections.size(),
-						pendings.size(), new Throwable("connection removed!"));
-			} else if (pendings.isEmpty()) {
+						pending, new Throwable("connection removed!"));
+			} else if (pending == 0) {
 				LOG.debug("{}connection: remove {} (size {})", tag, connection, connections.size());
 			} else {
 				LOG.debug("{}connection: remove {} (size {}, left jobs: {})", tag, connection, connections.size(),
-						pendings.size());
+						pending);
 			}
 			removeFromEstablishedSessions(connection);
 			removeFromAddressConnections(connection);
