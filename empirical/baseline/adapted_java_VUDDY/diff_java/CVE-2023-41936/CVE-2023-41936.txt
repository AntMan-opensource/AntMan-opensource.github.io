commit 2273af025ad06ee13ab73a5a070b10689c2db61e
Author: Vincent Latombe <vincent@latombe.net>
Date:   Mon Aug 28 10:31:28 2023 +0200

    [SECURITY-3228]

diff --git a/src/main/java/org/jenkinsci/plugins/googlelogin/OAuthSession.java b/src/main/java/org/jenkinsci/plugins/googlelogin/OAuthSession.java
index 74ab3d8..d009d3a 100644
--- a/src/main/java/org/jenkinsci/plugins/googlelogin/OAuthSession.java
+++ b/src/main/java/org/jenkinsci/plugins/googlelogin/OAuthSession.java
@@ -30,6 +30,7 @@ import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
 import hudson.model.Failure;
 import hudson.remoting.Base64;
 import hudson.util.HttpResponses;
+import java.security.MessageDigest;
 import org.kohsuke.stapler.HttpRedirect;
 import org.kohsuke.stapler.HttpResponse;
 import org.kohsuke.stapler.Stapler;
@@ -98,7 +99,8 @@ public abstract class OAuthSession implements Serializable {
         }
         try {
             AuthorizationCodeResponseUrl responseUrl = new AuthorizationCodeResponseUrl(buf.toString());
-            if (! uuid.equals(responseUrl.getState())) {
+            String state = responseUrl.getState();
+            if (state == null || !MessageDigest.isEqual(uuid.getBytes(StandardCharsets.UTF_8), state.getBytes(StandardCharsets.UTF_8))) {
                 return HttpResponses.error(401, "State is invalid");
             }
             String code = responseUrl.getCode();
