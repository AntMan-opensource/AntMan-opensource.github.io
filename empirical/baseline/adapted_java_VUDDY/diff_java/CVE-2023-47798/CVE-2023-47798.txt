commit 838d38d4496dcda5679f6df2ebe46ca4f3f58cf1
Author: Norbert Kocsis <norbert.kocsis@liferay.com>
Date:   Thu Jan 16 17:17:24 2020 +0100

    LPS-106589 Log out users if they get locked out

diff --git a/modules/apps/users-admin/users-admin-web/src/main/java/com/liferay/users/admin/web/internal/portlet/action/UpdatePasswordMyAccountMVCActionCommand.java b/modules/apps/users-admin/users-admin-web/src/main/java/com/liferay/users/admin/web/internal/portlet/action/UpdatePasswordMyAccountMVCActionCommand.java
index beaae385cab88..48a7ab5169535 100644
--- a/modules/apps/users-admin/users-admin-web/src/main/java/com/liferay/users/admin/web/internal/portlet/action/UpdatePasswordMyAccountMVCActionCommand.java
+++ b/modules/apps/users-admin/users-admin-web/src/main/java/com/liferay/users/admin/web/internal/portlet/action/UpdatePasswordMyAccountMVCActionCommand.java
@@ -15,6 +15,7 @@
 package com.liferay.users.admin.web.internal.portlet.action;
 
 import com.liferay.portal.kernel.exception.NoSuchUserException;
+import com.liferay.portal.kernel.exception.UserLockoutException;
 import com.liferay.portal.kernel.exception.UserPasswordException;
 import com.liferay.portal.kernel.model.Company;
 import com.liferay.portal.kernel.model.CompanyConstants;
@@ -24,10 +25,14 @@ import com.liferay.portal.kernel.portlet.bridges.mvc.MVCActionCommand;
 import com.liferay.portal.kernel.security.auth.Authenticator;
 import com.liferay.portal.kernel.security.auth.PasswordModificationThreadLocal;
 import com.liferay.portal.kernel.security.auth.PrincipalException;
+import com.liferay.portal.kernel.security.auth.session.AuthenticatedSessionManagerUtil;
 import com.liferay.portal.kernel.service.UserLocalService;
+import com.liferay.portal.kernel.servlet.HttpMethods;
 import com.liferay.portal.kernel.servlet.SessionErrors;
 import com.liferay.portal.kernel.util.ParamUtil;
 import com.liferay.portal.kernel.util.Portal;
+import com.liferay.portal.kernel.util.PortalUtil;
+import com.liferay.portal.kernel.util.StringUtil;
 import com.liferay.portal.kernel.util.Validator;
 import com.liferay.users.admin.constants.UsersAdminPortletKeys;
 
@@ -37,6 +42,9 @@ import java.util.Map;
 import javax.portlet.ActionRequest;
 import javax.portlet.ActionResponse;
 
+import javax.servlet.http.HttpServletRequest;
+import javax.servlet.http.HttpServletResponse;
+
 import org.osgi.service.component.annotations.Component;
 import org.osgi.service.component.annotations.Reference;
 
@@ -95,6 +103,35 @@ public class UpdatePasswordMyAccountMVCActionCommand
 			}
 
 			if (authResult == Authenticator.FAILURE) {
+				user = _portal.getSelectedUser(actionRequest);
+
+				if (user.isLockout()) {
+					HttpServletRequest originalHttpServletRequest =
+						_portal.getOriginalServletRequest(
+							_portal.getHttpServletRequest(actionRequest));
+					HttpServletResponse httpServletResponse =
+						PortalUtil.getHttpServletResponse(actionResponse);
+
+					AuthenticatedSessionManagerUtil.logout(
+						originalHttpServletRequest, httpServletResponse);
+
+					String redirect = PortalUtil.getCurrentCompleteURL(
+						originalHttpServletRequest);
+
+					if (!StringUtil.equals(
+							originalHttpServletRequest.getMethod(),
+							HttpMethods.GET)) {
+
+						redirect = _portal.getPortalURL(
+							originalHttpServletRequest);
+					}
+
+					httpServletResponse.sendRedirect(redirect);
+
+					throw new UserLockoutException.PasswordPolicyLockout(
+						user, user.getPasswordPolicy());
+				}
+
 				throw new UserPasswordException.MustMatchCurrentPassword(
 					user.getUserId());
 			}
