commit e30ea70b7206ec7b1ef052ab5b904ec5344b1d4c
Author: yaqian.zhang <598593183@qq.com>
Date:   Mon Jul 19 19:48:36 2021 +0800

    fix

diff --git a/server-base/src/main/java/org/apache/kylin/rest/service/QueryService.java b/server-base/src/main/java/org/apache/kylin/rest/service/QueryService.java
index 98edb14226..91e30c9ded 100644
--- a/server-base/src/main/java/org/apache/kylin/rest/service/QueryService.java
+++ b/server-base/src/main/java/org/apache/kylin/rest/service/QueryService.java
@@ -1214,12 +1214,7 @@ public class QueryService extends BasicService {
             throws SQLException {
         boolean isNull = (null == param.getValue());
 
-        Class<?> clazz;
-        try {
-            clazz = Class.forName(param.getClassName());
-        } catch (ClassNotFoundException e) {
-            throw new InternalErrorException(e);
-        }
+        Class<?> clazz = getValidClass(param.getClassName());
 
         Rep rep = Rep.of(clazz);
 
@@ -1288,6 +1283,25 @@ public class QueryService extends BasicService {
         }
     }
 
+    public Class<?> getValidClass(String className) {
+        Class<?> clazz;
+        try {
+            List<String> classList = new ArrayList<>();
+            Rep.VALUE_MAP.keySet().forEach(key -> {
+                classList.add(key.getName());
+            });
+            if (classList.contains(className)) {
+                clazz = Class.forName(className);
+            } else {
+                clazz = Class.forName("java.lang.Object");
+            }
+            logger.debug("Class parameter for sql is: " + clazz.getName());
+        } catch (ClassNotFoundException e) {
+            throw new InternalErrorException(e);
+        }
+        return clazz;
+    }
+
     public void setCacheManager(CacheManager cacheManager) {
         this.cacheManager = cacheManager;
     }
diff --git a/server/src/test/java/org/apache/kylin/rest/service/QueryServiceTest.java b/server/src/test/java/org/apache/kylin/rest/service/QueryServiceTest.java
index acf9e1935f..e1b646c7db 100644
--- a/server/src/test/java/org/apache/kylin/rest/service/QueryServiceTest.java
+++ b/server/src/test/java/org/apache/kylin/rest/service/QueryServiceTest.java
@@ -120,4 +120,10 @@ public class QueryServiceTest extends ServiceTestBase {
             Assert.assertTrue(wrapper == null || wrapper.get() == null);
         }
     }
+
+    @Test
+    public void testClassName() throws ClassNotFoundException {
+        Assert.assertEquals(Class.forName("java.lang.Object"), queryService.getValidClass("java.io.DataInputStream"));
+        Assert.assertEquals(Class.forName("java.lang.String"), queryService.getValidClass("java.lang.String"));
+    }
 }
