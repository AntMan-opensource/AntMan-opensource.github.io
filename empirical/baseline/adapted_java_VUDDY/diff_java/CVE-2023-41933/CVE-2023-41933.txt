commit 3039470161ada86f4091c75fc779ebfdb69f3210
Author: Andrea Chiera <andrea.chiera@hotmail.com>
Date:   Thu Aug 24 12:49:41 2023 +0200

    [SECURITY-3235]

diff --git a/src/main/java/hudson/plugins/jobConfigHistory/FileHistoryDao.java b/src/main/java/hudson/plugins/jobConfigHistory/FileHistoryDao.java
index 8206544..00109eb 100644
--- a/src/main/java/hudson/plugins/jobConfigHistory/FileHistoryDao.java
+++ b/src/main/java/hudson/plugins/jobConfigHistory/FileHistoryDao.java
@@ -618,7 +618,13 @@ public class FileHistoryDao extends JobConfigHistoryStrategy
     public XmlFile getOldRevision(final AbstractItem item,
                                   final String identifier) {
         final File configFile = item.getConfigFile().getFile();
-        final File historyDir = new File(getHistoryDir(configFile), identifier);
+        final File historyDirFromConfigFile = getHistoryDir(configFile);
+        final File historyDir = new File(historyDirFromConfigFile, identifier);
+
+        if(!fileIsContainedInDirectory(historyDir, historyDirFromConfigFile)) {
+            return new XmlFile(null);
+        }
+
         if (PluginUtils.isMavenPluginAvailable()
                 && item instanceof MavenModule) {
             final String path = historyDir
@@ -1338,8 +1344,14 @@ public class FileHistoryDao extends JobConfigHistoryStrategy
 
     @Override
     public XmlFile getOldRevision(final Node node, final String identifier) {
-        final File historyDir = new File(getHistoryDirForNode(node),
+        final File historyDirForNode = getHistoryDirForNode(node);
+        final File historyDir = new File(historyDirForNode,
                 identifier);
+
+        if(!fileIsContainedInDirectory(historyDir, historyDirForNode)) {
+            return new XmlFile(null);
+        }
+
         return new XmlFile(getConfigFile(historyDir));
     }
 
diff --git a/src/main/java/hudson/plugins/jobConfigHistory/JobConfigHistoryBaseAction.java b/src/main/java/hudson/plugins/jobConfigHistory/JobConfigHistoryBaseAction.java
index dc3a67b..752beeb 100644
--- a/src/main/java/hudson/plugins/jobConfigHistory/JobConfigHistoryBaseAction.java
+++ b/src/main/java/hudson/plugins/jobConfigHistory/JobConfigHistoryBaseAction.java
@@ -51,6 +51,7 @@ import org.xmlunit.diff.DifferenceEvaluator;
 import org.xmlunit.diff.ElementSelectors;
 
 import javax.servlet.ServletException;
+import javax.xml.XMLConstants;
 import javax.xml.transform.Transformer;
 import javax.xml.transform.TransformerException;
 import javax.xml.transform.TransformerFactory;
@@ -89,7 +90,13 @@ import static java.util.logging.Level.WARNING;
 public abstract class JobConfigHistoryBaseAction implements Action {
 
     private static final Logger LOG = Logger.getLogger(JobConfigHistoryBaseAction.class.getName());
-    private final TransformerFactory transformerFactory = TransformerFactory.newInstance();
+    private final TransformerFactory transformerFactory;
+
+    public JobConfigHistoryBaseAction() {
+        transformerFactory = TransformerFactory.newInstance();
+        transformerFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, "");
+        transformerFactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, "");
+    }
 
     @Override
     public String getDisplayName() {
