commit f04771906e836f558212e9de73b06bb488bf912c
Author: Luis Ortiz <luis.ortiz@liferay.com>
Date:   Wed Mar 23 18:08:43 2022 +0100

    LPS-149571 Use prepared statements to avoid 2nd order SQL injection in removePrimaryKey

diff --git a/modules/dxp/apps/portal/portal-dao-db/src/main/java/com/liferay/portal/dao/db/SQLServerDB.java b/modules/dxp/apps/portal/portal-dao-db/src/main/java/com/liferay/portal/dao/db/SQLServerDB.java
index d409b87171fea..3f14a6006fbc2 100644
--- a/modules/dxp/apps/portal/portal-dao-db/src/main/java/com/liferay/portal/dao/db/SQLServerDB.java
+++ b/modules/dxp/apps/portal/portal-dao-db/src/main/java/com/liferay/portal/dao/db/SQLServerDB.java
@@ -158,7 +158,7 @@ public class SQLServerDB extends BaseDB {
 
 	@Override
 	public void removePrimaryKey(Connection connection, String tableName)
-		throws IOException, SQLException {
+		throws SQLException {
 
 		DatabaseMetaData databaseMetaData = connection.getMetaData();
 
@@ -170,14 +170,15 @@ public class SQLServerDB extends BaseDB {
 		String primaryKeyConstraintName = null;
 
 		try (PreparedStatement preparedStatement = connection.prepareStatement(
-				StringBundler.concat(
-					"select name from sys.key_constraints where type = 'PK' ",
-					"and OBJECT_NAME(parent_object_id) = '",
-					normalizedTableName, "'"));
-			ResultSet resultSet = preparedStatement.executeQuery()) {
+				"select name from sys.key_constraints where type = 'PK' and " +
+					"OBJECT_NAME(parent_object_id) = '?'")) {
 
-			if (resultSet.next()) {
-				primaryKeyConstraintName = resultSet.getString("name");
+			preparedStatement.setString(1, normalizedTableName);
+
+			try (ResultSet resultSet = preparedStatement.executeQuery()) {
+				if (resultSet.next()) {
+					primaryKeyConstraintName = resultSet.getString("name");
+				}
 			}
 		}
 
@@ -186,10 +187,14 @@ public class SQLServerDB extends BaseDB {
 				"No primary key constraint found for " + normalizedTableName);
 		}
 
-		runSQL(
-			StringBundler.concat(
-				"alter table ", normalizedTableName, " drop constraint ",
-				primaryKeyConstraintName));
+		try (PreparedStatement preparedStatement = connection.prepareStatement(
+				"alter table ? drop constraint ?")) {
+
+			preparedStatement.setString(1, normalizedTableName);
+			preparedStatement.setString(2, primaryKeyConstraintName);
+
+			preparedStatement.executeUpdate();
+		}
 	}
 
 	@Override
diff --git a/modules/dxp/apps/portal/portal-dao-db/src/main/java/com/liferay/portal/dao/db/SybaseDB.java b/modules/dxp/apps/portal/portal-dao-db/src/main/java/com/liferay/portal/dao/db/SybaseDB.java
index 4c55868b35de1..8517fcd76acf7 100644
--- a/modules/dxp/apps/portal/portal-dao-db/src/main/java/com/liferay/portal/dao/db/SybaseDB.java
+++ b/modules/dxp/apps/portal/portal-dao-db/src/main/java/com/liferay/portal/dao/db/SybaseDB.java
@@ -97,7 +97,7 @@ public class SybaseDB extends BaseDB {
 
 	@Override
 	public void removePrimaryKey(Connection connection, String tableName)
-		throws IOException, SQLException {
+		throws SQLException {
 
 		DatabaseMetaData databaseMetaData = connection.getMetaData();
 
@@ -109,16 +109,19 @@ public class SybaseDB extends BaseDB {
 		String primaryKeyConstraintName = null;
 
 		try (PreparedStatement preparedStatement = connection.prepareStatement(
-				"sp_helpconstraint " + normalizedTableName);
-			ResultSet resultSet = preparedStatement.executeQuery()) {
+				"sp_helpconstraint ?")) {
 
-			while (resultSet.next()) {
-				String definition = resultSet.getString("definition");
+			preparedStatement.setString(1, normalizedTableName);
 
-				if (definition.startsWith("PRIMARY KEY INDEX")) {
-					primaryKeyConstraintName = resultSet.getString("name");
+			try (ResultSet resultSet = preparedStatement.executeQuery()) {
+				while (resultSet.next()) {
+					String definition = resultSet.getString("definition");
 
-					break;
+					if (definition.startsWith("PRIMARY KEY INDEX")) {
+						primaryKeyConstraintName = resultSet.getString("name");
+
+						break;
+					}
 				}
 			}
 		}
@@ -128,10 +131,14 @@ public class SybaseDB extends BaseDB {
 				"No primary key constraint found for " + normalizedTableName);
 		}
 
-		runSQL(
-			StringBundler.concat(
-				"alter table ", normalizedTableName, " drop constraint ",
-				primaryKeyConstraintName));
+		try (PreparedStatement preparedStatement = connection.prepareStatement(
+				"alter table ? drop constraint ?")) {
+
+			preparedStatement.setString(1, normalizedTableName);
+			preparedStatement.setString(2, primaryKeyConstraintName);
+
+			preparedStatement.executeUpdate();
+		}
 	}
 
 	@Override
