commit 1a46d6d842877ba2b824d5c269845827e2e0ccac
Author: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>
Date:   Fri Sep 23 03:48:36 2022 +0000

    vuln-fix: Zip Slip Vulnerability
    
    This fixes a Zip-Slip vulnerability.
    
    This change does one of two things. This change either
    
    1. Inserts a guard to protect against Zip Slip.
    OR
    2. Replaces `dir.getCanonicalPath().startsWith(parent.getCanonicalPath())`, which is vulnerable to partial path traversal attacks, with the more secure `dir.getCanonicalFile().toPath().startsWith(parent.getCanonicalFile().toPath())`.
    
    For number 2, consider `"/usr/outnot".startsWith("/usr/out")`.
    The check is bypassed although `/outnot` is not under the `/out` directory.
    It's important to understand that the terminating slash may be removed when using various `String` representations of the `File` object.
    For example, on Linux, `println(new File("/var"))` will print `/var`, but `println(new File("/var", "/")` will print `/var/`;
    however, `println(new File("/var", "/").getCanonicalPath())` will print `/var`.
    
    Weakness: CWE-22: Improper Limitation of a Pathname to a Restricted Directory ('Path Traversal')
    Severity: High
    CVSSS: 7.4
    Detection: CodeQL (https://codeql.github.com/codeql-query-help/java/java-zipslip/) & OpenRewrite (https://public.moderne.io/recipes/org.openrewrite.java.security.ZipSlip)
    
    Reported-by: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>
    Signed-off-by: Jonathan Leitschuh <Jonathan.Leitschuh@gmail.com>
    
    Bug-tracker: https://github.com/JLLeitschuh/security-research/issues/16
    
    Co-authored-by: Moderne <team@moderne.io>

diff --git a/qtiworks-engine/src/main/java/uk/ac/ed/ph/qtiworks/services/AssessmentPackageFileImporter.java b/qtiworks-engine/src/main/java/uk/ac/ed/ph/qtiworks/services/AssessmentPackageFileImporter.java
index 09cf3e24..8bc2da7c 100644
--- a/qtiworks-engine/src/main/java/uk/ac/ed/ph/qtiworks/services/AssessmentPackageFileImporter.java
+++ b/qtiworks-engine/src/main/java/uk/ac/ed/ph/qtiworks/services/AssessmentPackageFileImporter.java
@@ -160,6 +160,9 @@ public class AssessmentPackageFileImporter {
             while ((zipEntry = zipInputStream.getNextEntry()) != null) {
                 foundEntry = true;
                 final File destFile = new File(importSandboxDirectory, zipEntry.getName());
+                if (!destFile.toPath().normalize().startsWith(importSandboxDirectory.toPath().normalize())) {
+                    throw new RuntimeException("Bad zip entry");
+                }
                 if (!zipEntry.isDirectory()) {
                     ServiceUtilities.ensureFileCreated(destFile);
                     final FileOutputStream destOutputStream = new FileOutputStream(destFile);
