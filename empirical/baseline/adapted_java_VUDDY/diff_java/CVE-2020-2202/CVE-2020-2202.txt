commit 28932f7c5ff18f87d4b3a480225fb0827591776b
Author: Timothy Sotack <tim.sotack@hp.com>
Date:   Tue Jun 30 05:17:08 2020 -0400

    SECURITY-1690 and SECURITY-1691 fixes

diff --git a/src/main/java/org/jenkinsci/plugins/fodupload/FodGlobalDescriptor.java b/src/main/java/org/jenkinsci/plugins/fodupload/FodGlobalDescriptor.java
index 392da08..b8af5c0 100644
--- a/src/main/java/org/jenkinsci/plugins/fodupload/FodGlobalDescriptor.java
+++ b/src/main/java/org/jenkinsci/plugins/fodupload/FodGlobalDescriptor.java
@@ -1,6 +1,11 @@
 package org.jenkinsci.plugins.fodupload;
 
+import com.cloudbees.plugins.credentials.CredentialsProvider;
 import hudson.Extension;
+import hudson.model.Item;
+import hudson.model.Job;
+import hudson.security.ACL;
+import hudson.security.Permission;
 import hudson.util.FormValidation;
 import hudson.util.ListBoxModel;
 import hudson.util.Secret;
@@ -13,6 +18,7 @@ import java.io.IOException;
 
 import jenkins.model.Jenkins;
 import org.jenkinsci.plugins.fodupload.models.FodEnums.GrantType;
+import org.jenkinsci.plugins.plaincredentials.StringCredentials;
 import org.kohsuke.stapler.verb.POST;
 
 @Extension
@@ -189,27 +195,32 @@ public class FodGlobalDescriptor extends GlobalConfiguration {
 
     @SuppressWarnings("unused")
     public ListBoxModel doFillClientIdItems() {
-        return SharedUploadBuildStep.doFillStringCredentialsItems();
+        Jenkins.get().checkPermission(Jenkins.ADMINISTER);
+        return doFillStringCredentialsItems();
     }
 
     @SuppressWarnings("unused")
     public ListBoxModel doFillClientSecretItems() {
-        return SharedUploadBuildStep.doFillStringCredentialsItems();
+        Jenkins.get().checkPermission(Jenkins.ADMINISTER);
+        return doFillStringCredentialsItems();
     }
 
     @SuppressWarnings("unused")
     public ListBoxModel doFillUsernameItems() {
-        return SharedUploadBuildStep.doFillStringCredentialsItems();
+        Jenkins.get().checkPermission(Jenkins.ADMINISTER);
+        return doFillStringCredentialsItems();
     }
 
     @SuppressWarnings("unused")
     public ListBoxModel doFillPersonalAccessTokenItems() {
-        return SharedUploadBuildStep.doFillStringCredentialsItems();
+        Jenkins.get().checkPermission(Jenkins.ADMINISTER);
+        return doFillStringCredentialsItems();
     }
 
     @SuppressWarnings("unused")
     public ListBoxModel doFillTenantIdItems() {
-        return SharedUploadBuildStep.doFillStringCredentialsItems();
+        Jenkins.get().checkPermission(Jenkins.ADMINISTER);
+        return doFillStringCredentialsItems();
     }
 
     FodApiConnection createFodApiConnection() {
@@ -262,6 +273,17 @@ public class FodGlobalDescriptor extends GlobalConfiguration {
                 FormValidation.ok("Successfully authenticated to Fortify on Demand.") :
                 FormValidation.error("Invalid connection information. Please check your credentials and try again.");
     }
+
+    private ListBoxModel doFillStringCredentialsItems(){
+        ListBoxModel items = CredentialsProvider.listCredentials(
+                StringCredentials.class,
+                Jenkins.get(),
+                ACL.SYSTEM,
+                null,
+                null
+                );
+        return items;
+    }
     
     
 }
diff --git a/src/main/java/org/jenkinsci/plugins/fodupload/PollingBuildStep.java b/src/main/java/org/jenkinsci/plugins/fodupload/PollingBuildStep.java
index 76212e8..06f0725 100644
--- a/src/main/java/org/jenkinsci/plugins/fodupload/PollingBuildStep.java
+++ b/src/main/java/org/jenkinsci/plugins/fodupload/PollingBuildStep.java
@@ -7,6 +7,8 @@ import hudson.Extension;
 import hudson.FilePath;
 import hudson.Launcher;
 import hudson.model.AbstractProject;
+import hudson.model.Item;
+import hudson.model.Job;
 import hudson.model.Result;
 import hudson.model.Run;
 import hudson.model.TaskListener;
@@ -35,6 +37,7 @@ import org.kohsuke.stapler.QueryParameter;
 import org.kohsuke.stapler.verb.POST;
 
 import static org.jenkinsci.plugins.fodupload.SharedPollingBuildStep.*;
+import org.kohsuke.stapler.AncestorInPath;
 
 @SuppressWarnings("unused")
 public class PollingBuildStep extends Recorder implements SimpleBuildStep {
@@ -160,9 +163,10 @@ public class PollingBuildStep extends Recorder implements SimpleBuildStep {
         @POST
         public FormValidation doTestPersonalAccessTokenConnection(@QueryParameter(USERNAME) final String username,
                                                                   @QueryParameter(PERSONAL_ACCESS_TOKEN) final String personalAccessToken,
-                                                                  @QueryParameter(TENANT_ID) final String tenantId) {
-            Jenkins.get().checkPermission(Jenkins.ADMINISTER);
-            return SharedPollingBuildStep.doTestPersonalAccessTokenConnection(username, personalAccessToken, tenantId);
+                                                                  @QueryParameter(TENANT_ID) final String tenantId,
+                                                                  @AncestorInPath Job job) {
+            job.checkPermission(Item.CONFIGURE);
+            return SharedPollingBuildStep.doTestPersonalAccessTokenConnection(username, personalAccessToken, tenantId, job);
         }
 
         @SuppressWarnings("unused")
@@ -171,18 +175,18 @@ public class PollingBuildStep extends Recorder implements SimpleBuildStep {
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillUsernameItems() {
-            return SharedPollingBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillUsernameItems(@AncestorInPath Job job) {
+            return SharedPollingBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillPersonalAccessTokenItems() {
-            return SharedPollingBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillPersonalAccessTokenItems(@AncestorInPath Job job) {
+            return SharedPollingBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillTenantIdItems() {
-            return SharedPollingBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillTenantIdItems(@AncestorInPath Job job) {
+            return SharedPollingBuildStep.doFillStringCredentialsItems(job);
         }
     }
 }
diff --git a/src/main/java/org/jenkinsci/plugins/fodupload/SharedPollingBuildStep.java b/src/main/java/org/jenkinsci/plugins/fodupload/SharedPollingBuildStep.java
index 792c282..a7d55f7 100644
--- a/src/main/java/org/jenkinsci/plugins/fodupload/SharedPollingBuildStep.java
+++ b/src/main/java/org/jenkinsci/plugins/fodupload/SharedPollingBuildStep.java
@@ -17,6 +17,8 @@ import org.jenkinsci.plugins.plaincredentials.StringCredentials;
 import edu.umd.cs.findbugs.annotations.SuppressFBWarnings;
 import hudson.FilePath;
 import hudson.Launcher;
+import hudson.model.Item;
+import hudson.model.Job;
 import hudson.model.Result;
 import hudson.model.Run;
 import hudson.model.TaskListener;
@@ -25,6 +27,8 @@ import hudson.util.FormValidation;
 import hudson.util.ListBoxModel;
 import jenkins.model.GlobalConfiguration;
 import jenkins.model.Jenkins;
+import org.kohsuke.stapler.AncestorInPath;
+
 import org.kohsuke.stapler.verb.POST;
 
 public class SharedPollingBuildStep {
@@ -123,8 +127,10 @@ public class SharedPollingBuildStep {
     @POST
     public static FormValidation doTestPersonalAccessTokenConnection(final String username,
                                                                      final String personalAccessToken,
-                                                                     final String tenantId) {
-        Jenkins.get().checkPermission(Jenkins.ADMINISTER);
+                                                                     final String tenantId,
+                                                                     @AncestorInPath Job job) {
+        job.checkPermission(Item.CONFIGURE);
+
         FodApiConnection testApi;
         String baseUrl = GlobalConfiguration.all().get(FodGlobalDescriptor.class).getBaseUrl();
         String apiUrl = GlobalConfiguration.all().get(FodGlobalDescriptor.class).getApiUrl();
@@ -154,7 +160,8 @@ public class SharedPollingBuildStep {
     }
 
     @SuppressWarnings("unused")
-    public static ListBoxModel doFillStringCredentialsItems() {
+    public static ListBoxModel doFillStringCredentialsItems(@AncestorInPath Job job) {
+        job.checkPermission(Item.CONFIGURE);
         ListBoxModel items = CredentialsProvider.listCredentials(
                 StringCredentials.class,
                 Jenkins.get(),
diff --git a/src/main/java/org/jenkinsci/plugins/fodupload/SharedUploadBuildStep.java b/src/main/java/org/jenkinsci/plugins/fodupload/SharedUploadBuildStep.java
index 16a1ce6..4b72df6 100644
--- a/src/main/java/org/jenkinsci/plugins/fodupload/SharedUploadBuildStep.java
+++ b/src/main/java/org/jenkinsci/plugins/fodupload/SharedUploadBuildStep.java
@@ -21,6 +21,8 @@ import hudson.FilePath;
 import hudson.Launcher;
 import hudson.model.AbstractBuild;
 import hudson.model.BuildListener;
+import hudson.model.Item;
+import hudson.model.Job;
 import hudson.model.Result;
 import hudson.model.Run;
 import hudson.model.TaskListener;
@@ -29,6 +31,7 @@ import hudson.util.FormValidation;
 import hudson.util.ListBoxModel;
 import jenkins.model.GlobalConfiguration;
 import jenkins.model.Jenkins;
+import org.kohsuke.stapler.AncestorInPath;
 import org.kohsuke.stapler.verb.POST;
 
 public class SharedUploadBuildStep {
@@ -113,8 +116,9 @@ public class SharedUploadBuildStep {
     @POST
     public static FormValidation doTestPersonalAccessTokenConnection(final String username,
                                                                      final String personalAccessToken,
-                                                                     final String tenantId) {
-        Jenkins.get().checkPermission(Jenkins.ADMINISTER);
+                                                                     final String tenantId,
+                                                                     @AncestorInPath Job job) {
+        job.checkPermission(Item.CONFIGURE);
         FodApiConnection testApi;
         String baseUrl = GlobalConfiguration.all().get(FodGlobalDescriptor.class).getBaseUrl();
         String apiUrl = GlobalConfiguration.all().get(FodGlobalDescriptor.class).getApiUrl();
@@ -154,7 +158,8 @@ public class SharedUploadBuildStep {
     }
 
     @SuppressWarnings("unused")
-    public static ListBoxModel doFillStringCredentialsItems() {
+    public static ListBoxModel doFillStringCredentialsItems(@AncestorInPath Job job) {
+        job.checkPermission(Item.CONFIGURE);
         ListBoxModel items = CredentialsProvider.listCredentials(
                 StringCredentials.class,
                 Jenkins.get(),
diff --git a/src/main/java/org/jenkinsci/plugins/fodupload/StaticAssessmentBuildStep.java b/src/main/java/org/jenkinsci/plugins/fodupload/StaticAssessmentBuildStep.java
index d5e66e7..afe42ef 100644
--- a/src/main/java/org/jenkinsci/plugins/fodupload/StaticAssessmentBuildStep.java
+++ b/src/main/java/org/jenkinsci/plugins/fodupload/StaticAssessmentBuildStep.java
@@ -7,6 +7,8 @@ import hudson.Launcher;
 import hudson.model.AbstractBuild;
 import hudson.model.AbstractProject;
 import hudson.model.BuildListener;
+import hudson.model.Item;
+import hudson.model.Job;
 import hudson.model.Run;
 import hudson.model.TaskListener;
 import hudson.security.Permission;
@@ -31,6 +33,7 @@ import java.net.URISyntaxException;
 
 import jenkins.model.Jenkins;
 import org.jenkinsci.plugins.fodupload.models.AuthenticationModel;
+import org.kohsuke.stapler.AncestorInPath;
 import org.kohsuke.stapler.QueryParameter;
 import org.kohsuke.stapler.verb.POST;
 
@@ -196,9 +199,10 @@ public class StaticAssessmentBuildStep extends Recorder implements SimpleBuildSt
         @POST
         public FormValidation doTestPersonalAccessTokenConnection(@QueryParameter(SharedUploadBuildStep.USERNAME) final String username,
                                                                   @QueryParameter(SharedUploadBuildStep.PERSONAL_ACCESS_TOKEN) final String personalAccessToken,
-                                                                  @QueryParameter(SharedUploadBuildStep.TENANT_ID) final String tenantId) {
-            Jenkins.get().checkPermission(Jenkins.ADMINISTER);
-            return SharedUploadBuildStep.doTestPersonalAccessTokenConnection(username, personalAccessToken, tenantId);
+                                                                  @QueryParameter(SharedUploadBuildStep.TENANT_ID) final String tenantId,
+                                                                  @AncestorInPath Job job) {
+            job.checkPermission(Item.CONFIGURE);
+            return SharedUploadBuildStep.doTestPersonalAccessTokenConnection(username, personalAccessToken, tenantId,job);
         }
 
         @SuppressWarnings("unused")
@@ -213,18 +217,18 @@ public class StaticAssessmentBuildStep extends Recorder implements SimpleBuildSt
 
         @SuppressWarnings("unused")
 
-        public ListBoxModel doFillUsernameItems() {
-            return SharedUploadBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillUsernameItems(@AncestorInPath Job job) {
+            return SharedUploadBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillPersonalAccessTokenItems() {
-            return SharedUploadBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillPersonalAccessTokenItems(@AncestorInPath Job job) {
+            return SharedUploadBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillTenantIdItems() {
-            return SharedUploadBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillTenantIdItems(@AncestorInPath Job job) {
+            return SharedUploadBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
diff --git a/src/main/java/org/jenkinsci/plugins/fodupload/steps/FortifyPollResults.java b/src/main/java/org/jenkinsci/plugins/fodupload/steps/FortifyPollResults.java
index 41c8a20..ab2876d 100644
--- a/src/main/java/org/jenkinsci/plugins/fodupload/steps/FortifyPollResults.java
+++ b/src/main/java/org/jenkinsci/plugins/fodupload/steps/FortifyPollResults.java
@@ -22,11 +22,15 @@ import hudson.FilePath;
 import hudson.Launcher;
 import hudson.model.AbstractBuild;
 import hudson.model.BuildListener;
+import hudson.model.Item;
+import hudson.model.Job;
 import hudson.model.Run;
 import hudson.model.TaskListener;
 import hudson.util.FormValidation;
 import hudson.util.ListBoxModel;
 import hudson.util.Secret;
+import org.kohsuke.stapler.AncestorInPath;
+
 import org.kohsuke.stapler.verb.POST;
 
 @SuppressFBWarnings("unused")
@@ -193,9 +197,11 @@ public class FortifyPollResults extends FortifyStep {
         @POST
         public FormValidation doTestPersonalAccessTokenConnection(@QueryParameter(SharedPollingBuildStep.USERNAME) final String username,
                                                                   @QueryParameter(SharedPollingBuildStep.PERSONAL_ACCESS_TOKEN) final String personalAccessToken,
-                                                                  @QueryParameter(SharedPollingBuildStep.TENANT_ID) final String tenantId) {
-            Jenkins.get().checkPermission(Jenkins.ADMINISTER);
-            return SharedPollingBuildStep.doTestPersonalAccessTokenConnection(username, personalAccessToken, tenantId);
+                                                                  @QueryParameter(SharedPollingBuildStep.TENANT_ID) final String tenantId,
+                                                                  @AncestorInPath Job job) {
+            job.checkPermission(Item.CONFIGURE);
+            return SharedPollingBuildStep.doTestPersonalAccessTokenConnection(username, personalAccessToken, tenantId, job);
+
 
         }
 
@@ -205,18 +211,18 @@ public class FortifyPollResults extends FortifyStep {
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillUsernameItems() {
-            return SharedPollingBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillUsernameItems(@AncestorInPath Job job) {
+            return SharedPollingBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillPersonalAccessTokenItems() {
-            return SharedPollingBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillPersonalAccessTokenItems(@AncestorInPath Job job) {
+            return SharedPollingBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillTenantIdItems() {
-            return SharedPollingBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillTenantIdItems(@AncestorInPath Job job) {
+            return SharedPollingBuildStep.doFillStringCredentialsItems(job);
         }
 
     }
diff --git a/src/main/java/org/jenkinsci/plugins/fodupload/steps/FortifyStaticAssessment.java b/src/main/java/org/jenkinsci/plugins/fodupload/steps/FortifyStaticAssessment.java
index cdce791..b1b18c7 100644
--- a/src/main/java/org/jenkinsci/plugins/fodupload/steps/FortifyStaticAssessment.java
+++ b/src/main/java/org/jenkinsci/plugins/fodupload/steps/FortifyStaticAssessment.java
@@ -21,11 +21,14 @@ import hudson.FilePath;
 import hudson.Launcher;
 import hudson.model.AbstractBuild;
 import hudson.model.BuildListener;
+import hudson.model.Item;
+import hudson.model.Job;
 import hudson.model.Run;
 import hudson.model.TaskListener;
 import hudson.util.FormValidation;
 import hudson.util.ListBoxModel;
 import hudson.util.Secret;
+import org.kohsuke.stapler.AncestorInPath;
 import org.kohsuke.stapler.verb.POST;
 
 
@@ -211,9 +214,11 @@ public class FortifyStaticAssessment extends FortifyStep {
         @POST
         public FormValidation doTestPersonalAccessTokenConnection(@QueryParameter(SharedUploadBuildStep.USERNAME) final String username,
                                                                   @QueryParameter(SharedUploadBuildStep.PERSONAL_ACCESS_TOKEN) final String personalAccessToken,
-                                                                  @QueryParameter(SharedUploadBuildStep.TENANT_ID) final String tenantId) {
-            Jenkins.get().checkPermission(Jenkins.ADMINISTER);
-            return SharedUploadBuildStep.doTestPersonalAccessTokenConnection(username, personalAccessToken, tenantId);
+                                                                  @QueryParameter(SharedUploadBuildStep.TENANT_ID) final String tenantId,
+                                                                  @AncestorInPath Job job) {
+            job.checkPermission(Item.CONFIGURE);
+            return SharedUploadBuildStep.doTestPersonalAccessTokenConnection(username, personalAccessToken, tenantId, job);
+
 
         }
 
@@ -228,18 +233,18 @@ public class FortifyStaticAssessment extends FortifyStep {
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillUsernameItems() {
-            return SharedUploadBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillUsernameItems(@AncestorInPath Job job) {
+            return SharedUploadBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillPersonalAccessTokenItems() {
-            return SharedUploadBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillPersonalAccessTokenItems(@AncestorInPath Job job) {
+            return SharedUploadBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
-        public ListBoxModel doFillTenantIdItems() {
-            return SharedUploadBuildStep.doFillStringCredentialsItems();
+        public ListBoxModel doFillTenantIdItems(@AncestorInPath Job job) {
+            return SharedUploadBuildStep.doFillStringCredentialsItems(job);
         }
 
         @SuppressWarnings("unused")
