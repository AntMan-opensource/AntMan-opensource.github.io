commit 30cf3972b48c0549e60f84aeb9e3ef94fa3cee74
Author: Peter Smythe <peter@afrigis.co.za>
Date:   Mon May 6 16:19:38 2024 +0200

    [GEOS-11385] Demo Requests functionality does not honour ENV variable PROXY_BASE_URL

diff --git a/src/wfs/src/main/java/org/vfny/geoserver/wfs/servlets/TestWfsPost.java b/src/wfs/src/main/java/org/vfny/geoserver/wfs/servlets/TestWfsPost.java
index 1b03566633..9cd4536987 100644
--- a/src/wfs/src/main/java/org/vfny/geoserver/wfs/servlets/TestWfsPost.java
+++ b/src/wfs/src/main/java/org/vfny/geoserver/wfs/servlets/TestWfsPost.java
@@ -283,6 +283,9 @@ public String errorResponse(Exception e) {
     }
 
     String getProxyBaseURL() {
+    	if (GeoServerExtensions.getProperty("PROXY_BASE_URL") != null) {
+    		return GeoServerExtensions.getProperty("PROXY_BASE_URL");
+    	}
         GeoServer geoServer = getGeoServer();
         if (geoServer != null) {
             return geoServer.getGlobal().getSettings().getProxyBaseUrl();
diff --git a/src/wfs/src/test/java/org/geoserver/wfs/v1_1/GetCapabilitiesTest.java b/src/wfs/src/test/java/org/geoserver/wfs/v1_1/GetCapabilitiesTest.java
index 93980d6fcf..c0184c7bdd 100644
--- a/src/wfs/src/test/java/org/geoserver/wfs/v1_1/GetCapabilitiesTest.java
+++ b/src/wfs/src/test/java/org/geoserver/wfs/v1_1/GetCapabilitiesTest.java
@@ -339,7 +339,7 @@ public void testMetadataLinks() throws Exception {
     }
 
     @Test
-    public void testMetadataLinksTransormToProxyBaseURL() throws Exception {
+    public void testMetadataLinksTransformToProxyBaseURL() throws Exception {
         FeatureTypeInfo mpolys =
                 getCatalog().getFeatureTypeByName(getLayerId(MockTestData.MPOLYGONS));
         // a valid link whose metadata type needs tweaking
diff --git a/src/wfs/src/test/java/org/vfny/geoserver/wfs/servlets/TestWfsPostTest.java b/src/wfs/src/test/java/org/vfny/geoserver/wfs/servlets/TestWfsPostTest.java
index 817f7b0927..a090df1c84 100644
--- a/src/wfs/src/test/java/org/vfny/geoserver/wfs/servlets/TestWfsPostTest.java
+++ b/src/wfs/src/test/java/org/vfny/geoserver/wfs/servlets/TestWfsPostTest.java
@@ -256,6 +256,31 @@ protected GeoServer getGeoServer() {
         assertEquals("https://foo.com/geoserver", servlet.getProxyBaseURL());
     }
 
+    @Test
+    // https://osgeo-org.atlassian.net/browse/GEOS-11385
+    public void testGetProxyBaseURLfromEnv() {
+        SettingsInfo settings = new SettingsInfoImpl();
+        settings.setProxyBaseUrl("https://foo.com/geoserver1");
+        // Override the Proxy Base Url with the Environment variable
+        System.setProperty("PROXY_BASE_URL", "https://foo.com/geoserver2");
+
+        GeoServerInfo info = new GeoServerInfoImpl();
+        info.setSettings(settings);
+
+        GeoServer gs = new GeoServerImpl();
+        gs.setGlobal(info);
+
+        TestWfsPost servlet =
+                new TestWfsPost() {
+                    @Override
+                    protected GeoServer getGeoServer() {
+                        return gs;
+                    }
+                };
+        assertEquals("https://foo.com/geoserver2", servlet.getProxyBaseURL());
+        System.clearProperty("PROXY_BASE_URL");
+    }
+
     @SuppressWarnings("PMD.AvoidUsingHardCodedIP")
     protected static MockHttpServletRequest buildMockRequest() {
         MockHttpServletRequest request = new MockHttpServletRequest();
