commit b0732610112cb2066b5e43a47a11008edfacee02
Author: Flavia Rainone <frainone@redhat.com>
Date:   Thu Jun 8 01:22:47 2023 -0300

    [UNDERTOW-2280] CVE-2023-5379 At AjpReadListener, do not close the connection if read is larger than maxRequestSize
    
    Signed-off-by: Flavia Rainone <frainone@redhat.com>

diff --git a/core/src/main/java/io/undertow/server/protocol/ajp/AjpReadListener.java b/core/src/main/java/io/undertow/server/protocol/ajp/AjpReadListener.java
index 8f9c94abb..a9631b371 100644
--- a/core/src/main/java/io/undertow/server/protocol/ajp/AjpReadListener.java
+++ b/core/src/main/java/io/undertow/server/protocol/ajp/AjpReadListener.java
@@ -19,6 +19,7 @@
 package io.undertow.server.protocol.ajp;
 
 import io.undertow.UndertowLogger;
+import io.undertow.UndertowMessages;
 import io.undertow.UndertowOptions;
 import io.undertow.conduits.ConduitListener;
 import io.undertow.conduits.EmptyStreamSourceConduit;
@@ -165,8 +166,7 @@ final class AjpReadListener implements ChannelListener<StreamSourceChannel> {
                 }
                 if (read > maxRequestSize) {
                     UndertowLogger.REQUEST_LOGGER.requestHeaderWasTooLarge(connection.getPeerAddress(), maxRequestSize);
-                    safeClose(connection);
-                    return;
+                    throw UndertowMessages.MESSAGES.badRequest();
                 }
             } while (!state.isComplete());
 
