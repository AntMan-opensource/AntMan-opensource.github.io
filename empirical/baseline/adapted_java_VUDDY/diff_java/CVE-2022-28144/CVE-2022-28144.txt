commit 21fa38386dc3a9de5963509ac4fda3d2aa6e2e42
Author: Maxhy <maxime@chamley.org>
Date:   Fri Mar 25 09:44:04 2022 +0100

    Add permission check on VirtualMachineSlave callbacks and enforce POST request on test actions

diff --git a/src/main/java/org/jenkinsci/plugins/proxmox/Datacenter.java b/src/main/java/org/jenkinsci/plugins/proxmox/Datacenter.java
index 3ef6a30..93e6ec1 100644
--- a/src/main/java/org/jenkinsci/plugins/proxmox/Datacenter.java
+++ b/src/main/java/org/jenkinsci/plugins/proxmox/Datacenter.java
@@ -25,6 +25,7 @@ import hudson.slaves.NodeProvisioner;
 import hudson.util.FormValidation;
 import net.sf.json.JSONObject;
 import jenkins.model.Jenkins;
+import org.kohsuke.stapler.verb.POST;
 
 /**
  * Represents a Proxmox datacenter.
@@ -167,6 +168,7 @@ public class Datacenter extends Cloud {
             return emptyStringValidation("Password", value.getPlainText());
         }
         
+		@POST
         public FormValidation doTestConnection (
                 @QueryParameter String hostname, @QueryParameter String username, @QueryParameter String realm,
                 @QueryParameter Secret password, @QueryParameter Boolean ignoreSSL) {
diff --git a/src/main/java/org/jenkinsci/plugins/proxmox/VirtualMachineSlave.java b/src/main/java/org/jenkinsci/plugins/proxmox/VirtualMachineSlave.java
index 6e469aa..540ef8e 100644
--- a/src/main/java/org/jenkinsci/plugins/proxmox/VirtualMachineSlave.java
+++ b/src/main/java/org/jenkinsci/plugins/proxmox/VirtualMachineSlave.java
@@ -28,6 +28,7 @@ import hudson.slaves.RetentionStrategy;
 import hudson.util.FormValidation;
 import hudson.util.ListBoxModel;
 import jenkins.model.Jenkins;
+import org.kohsuke.stapler.verb.POST;
 
 public class VirtualMachineSlave extends Slave {
 
@@ -139,7 +140,8 @@ public class VirtualMachineSlave extends Slave {
         }
 
         public ListBoxModel doFillDatacenterNodeItems(@QueryParameter("datacenterDescription") String datacenterDescription) {
-            ListBoxModel items = new ListBoxModel();
+            Jenkins.get().checkPermission(Jenkins.ADMINISTER);
+			ListBoxModel items = new ListBoxModel();
             items.add("[Select]", "");
             Datacenter datacenter = getDatacenterByDescription(datacenterDescription);
             if (datacenter != null) {
@@ -151,7 +153,8 @@ public class VirtualMachineSlave extends Slave {
         }
 
         public ListBoxModel doFillVirtualMachineIdItems(@QueryParameter("datacenterDescription") String datacenterDescription, @QueryParameter("datacenterNode") String datacenterNode) {
-            ListBoxModel items = new ListBoxModel();
+            Jenkins.get().checkPermission(Jenkins.ADMINISTER);
+			ListBoxModel items = new ListBoxModel();
             items.add("[Select]", "");
             Datacenter datacenter = getDatacenterByDescription(datacenterDescription);
             if (datacenter != null) {
@@ -165,6 +168,7 @@ public class VirtualMachineSlave extends Slave {
 
         public ListBoxModel doFillSnapshotNameItems(@QueryParameter("datacenterDescription") String datacenterDescription, @QueryParameter("datacenterNode") String datacenterNode,
                                                  @QueryParameter("virtualMachineId") String virtualMachineId) {
+			Jenkins.get().checkPermission(Jenkins.ADMINISTER);
             ListBoxModel items = new ListBoxModel();
             items.add("[Select]", "");
             Datacenter datacenter = getDatacenterByDescription(datacenterDescription);
@@ -200,9 +204,11 @@ public class VirtualMachineSlave extends Slave {
             return revertPolicy;
         }
         
+		@POST
         public FormValidation doTestRollback (
                 @QueryParameter String datacenterDescription, @QueryParameter String datacenterNode,
                 @QueryParameter Integer virtualMachineId, @QueryParameter String snapshotName) {
+			Jenkins.get().checkPermission(Jenkins.ADMINISTER);
             Datacenter datacenter = getDatacenterByDescription(datacenterDescription);
             if (datacenter == null)
                 return FormValidation.error("Datacenter not found!");
