commit f46b7fa846a1564119fa51f5797dc4a81d876088
Author: Tim Jacomb <timjacomb1@gmail.com>
Date:   Mon Feb 27 16:29:16 2023 +0000

    SECURITY-3051

diff --git a/src/main/java/org/jenkinsci/plugins/azurekeyvaultplugin/AzureKeyVaultStep.java b/src/main/java/org/jenkinsci/plugins/azurekeyvaultplugin/AzureKeyVaultStep.java
index 395c846..69a00d2 100644
--- a/src/main/java/org/jenkinsci/plugins/azurekeyvaultplugin/AzureKeyVaultStep.java
+++ b/src/main/java/org/jenkinsci/plugins/azurekeyvaultplugin/AzureKeyVaultStep.java
@@ -15,7 +15,6 @@ import hudson.model.Run;
 import hudson.util.ListBoxModel;
 import io.jenkins.plugins.azuresdk.HttpClientRetriever;
 import java.nio.charset.StandardCharsets;
-import java.util.ArrayList;
 import java.util.Collections;
 import java.util.HashMap;
 import java.util.List;
@@ -25,6 +24,7 @@ import javax.annotation.Nonnull;
 import javax.security.auth.login.CredentialNotFoundException;
 import jenkins.YesNoMaybe;
 import org.apache.commons.lang3.StringUtils;
+import org.jenkinsci.plugins.credentialsbinding.masking.SecretPatterns;
 import org.jenkinsci.plugins.workflow.steps.AbstractStepExecutionImpl;
 import org.jenkinsci.plugins.workflow.steps.BodyExecutionCallback;
 import org.jenkinsci.plugins.workflow.steps.BodyInvoker;
@@ -174,7 +174,7 @@ public class AzureKeyVaultStep extends Step {
                     EnvironmentExpander.merge(context.get(EnvironmentExpander.class), new AzureKeyVaultEnvironmentExpander(secrets)),
                     BodyInvoker.mergeConsoleLogFilters(
                             context.get(ConsoleLogFilter.class),
-                            new MaskingConsoleLogFilter(StandardCharsets.UTF_8.name(), new ArrayList<>(secrets.values()))
+                            new MaskingConsoleLogFilter(StandardCharsets.UTF_8.name(), SecretPatterns.getAggregateSecretPattern(secrets.values()))
                     )
             );
             invoker.start();
diff --git a/src/main/java/org/jenkinsci/plugins/azurekeyvaultplugin/MaskingConsoleLogFilter.java b/src/main/java/org/jenkinsci/plugins/azurekeyvaultplugin/MaskingConsoleLogFilter.java
index c0e21d4..4b31dcc 100644
--- a/src/main/java/org/jenkinsci/plugins/azurekeyvaultplugin/MaskingConsoleLogFilter.java
+++ b/src/main/java/org/jenkinsci/plugins/azurekeyvaultplugin/MaskingConsoleLogFilter.java
@@ -4,7 +4,7 @@ import hudson.console.ConsoleLogFilter;
 import hudson.model.Run;
 import java.io.OutputStream;
 import java.io.Serializable;
-import java.util.List;
+import java.util.regex.Pattern;
 import org.jenkinsci.plugins.credentialsbinding.masking.SecretPatterns;
 
 public class MaskingConsoleLogFilter extends ConsoleLogFilter
@@ -12,11 +12,11 @@ public class MaskingConsoleLogFilter extends ConsoleLogFilter
     private static final long serialVersionUID = 1L;
 
     private final String charsetName;
-    private final List<String> valuesToMask;
+    private final Pattern valuesToMask;
 
 
     public MaskingConsoleLogFilter(final String charsetName,
-                                   final List<String> valuesToMask
+                                   final Pattern valuesToMask
     ) {
         this.charsetName = charsetName;
         this.valuesToMask = valuesToMask;
@@ -27,7 +27,7 @@ public class MaskingConsoleLogFilter extends ConsoleLogFilter
             Run run,
             final OutputStream logger
     ) {
-        return new SecretPatterns.MaskingOutputStream(logger, () -> SecretPatterns.getAggregateSecretPattern(valuesToMask), charsetName);
+        return new SecretPatterns.MaskingOutputStream(logger, () -> valuesToMask, charsetName);
     }
 
 }
