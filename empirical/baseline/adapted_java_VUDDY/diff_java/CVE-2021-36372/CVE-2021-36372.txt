commit 6e6aefe278073b6eac887f31cf0147bc457ba37c
Author: Ritesh H Shukla <kerneltime@gmail.com>
Date:   Thu Jun 10 21:15:22 2021 -0700

    HDDS-5315 Skip storing unwanted block tokens on OM DB (#2311)

diff --git a/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfo.java b/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfo.java
index d1a721a476..7764ffbecf 100644
--- a/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfo.java
+++ b/hadoop-ozone/common/src/main/java/org/apache/hadoop/ozone/om/helpers/OmKeyLocationInfo.java
@@ -182,11 +182,11 @@ public KeyLocation getProtobuf(boolean ignorePipeline, int clientVersion) {
         .setLength(length)
         .setOffset(offset)
         .setCreateVersion(createVersion).setPartNumber(partNumber);
-    if (this.token != null) {
-      builder.setToken(OzonePBHelper.protoFromToken(token));
-    }
     if (!ignorePipeline) {
       try {
+        if (this.token != null) {
+          builder.setToken(OzonePBHelper.protoFromToken(token));
+        }
         builder.setPipeline(pipeline.getProtobufMessage(clientVersion));
       } catch (UnknownPipelineStateException e) {
         //TODO: fix me: we should not return KeyLocation without pipeline.
