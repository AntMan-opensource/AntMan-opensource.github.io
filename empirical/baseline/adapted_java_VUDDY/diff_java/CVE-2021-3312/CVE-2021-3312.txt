commit 92e035423aa6967822d343e54392d4291648c0ee
Author: gWestenberger <g.westenberger@alkacon.com>
Date:   Wed Jan 27 10:56:26 2021 +0100

    Fixed XXE issue in SVG processing (github issue #725).

diff --git a/src/org/opencms/file/types/CmsResourceTypeImage.java b/src/org/opencms/file/types/CmsResourceTypeImage.java
index b6f92e05fa..9e34b31f54 100644
--- a/src/org/opencms/file/types/CmsResourceTypeImage.java
+++ b/src/org/opencms/file/types/CmsResourceTypeImage.java
@@ -45,6 +45,7 @@ import org.opencms.main.OpenCms;
 import org.opencms.security.CmsPermissionSet;
 import org.opencms.security.CmsSecurityException;
 import org.opencms.util.CmsStringUtil;
+import org.opencms.xml.CmsXmlEntityResolver;
 
 import java.io.ByteArrayInputStream;
 import java.util.ArrayList;
@@ -608,6 +609,7 @@ public class CmsResourceTypeImage extends A_CmsResourceType {
         try {
             double w = -1, h = -1;
             SAXReader reader = new SAXReader();
+            reader.setEntityResolver(new CmsXmlEntityResolver(null));
             Document doc = reader.read(new ByteArrayInputStream(content));
             Element node = (Element)(doc.selectSingleNode("/svg"));
             if (node != null) {
diff --git a/src/org/opencms/xml/CmsXmlEntityResolver.java b/src/org/opencms/xml/CmsXmlEntityResolver.java
index dee3380086..f1d5e0f5cf 100644
--- a/src/org/opencms/xml/CmsXmlEntityResolver.java
+++ b/src/org/opencms/xml/CmsXmlEntityResolver.java
@@ -432,7 +432,8 @@ public class CmsXmlEntityResolver implements EntityResolver, I_CmsEventListener
             }
 
         } else if (systemId.substring(0, systemId.lastIndexOf("/") + 1).equalsIgnoreCase(
-            CmsConfigurationManager.DEFAULT_DTD_PREFIX)) {
+            CmsConfigurationManager.DEFAULT_DTD_PREFIX)//
+        ) {
             // default DTD location in the org.opencms.configuration package
             String location = null;
             try {
@@ -447,8 +448,8 @@ public class CmsXmlEntityResolver implements EntityResolver, I_CmsEventListener
                 LOG.error(Messages.get().getBundle().key(Messages.LOG_DTD_NOT_FOUND_1, location), t);
             }
         }
-        // use the default behaviour (i.e. resolve through external URL)
-        return null;
+        LOG.error("Entity reference not allowed: " + systemId, new IOException());
+        throw new IOException("Entity reference not allowed (see log for details)");
     }
 
     /**
