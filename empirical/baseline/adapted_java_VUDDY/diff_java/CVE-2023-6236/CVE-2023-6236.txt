commit 6e94ec3476a279c0a130186209c50a2991ba4c84
Author: Farah Juma <fjuma@redhat.com>
Date:   Mon Nov 20 16:16:33 2023 -0500

    [JBEAP-26097] CVE-2023-6236: Compare the provider-url for a cached account against the provider-url required for a request to determine if a cached token can be used

diff --git a/http/oidc/src/main/java/org/wildfly/security/http/oidc/Oidc.java b/http/oidc/src/main/java/org/wildfly/security/http/oidc/Oidc.java
index 496749c97a..319d91920a 100644
--- a/http/oidc/src/main/java/org/wildfly/security/http/oidc/Oidc.java
+++ b/http/oidc/src/main/java/org/wildfly/security/http/oidc/Oidc.java
@@ -333,4 +333,18 @@ public class Oidc {
         }
     }
 
+    protected static boolean checkCachedAccountMatchesRequest(OidcAccount account, OidcClientConfiguration deployment) {
+        if (deployment.getRealm() != null
+                && ! deployment.getRealm().equals(account.getOidcSecurityContext().getRealm())) {
+            log.debug("Account in session belongs to a different realm than for this request.");
+            return false;
+        }
+        if (deployment.getProviderUrl() != null
+                && ! deployment.getProviderUrl().equals(account.getOidcSecurityContext().getOidcClientConfiguration().getProviderUrl())) {
+            log.debug("Account in session belongs to a different provider than for this request.");
+            return false;
+        }
+        return true;
+    }
+
 }
diff --git a/http/oidc/src/main/java/org/wildfly/security/http/oidc/OidcCookieTokenStore.java b/http/oidc/src/main/java/org/wildfly/security/http/oidc/OidcCookieTokenStore.java
index 3039192f0a..f24fe9008f 100644
--- a/http/oidc/src/main/java/org/wildfly/security/http/oidc/OidcCookieTokenStore.java
+++ b/http/oidc/src/main/java/org/wildfly/security/http/oidc/OidcCookieTokenStore.java
@@ -20,6 +20,7 @@ package org.wildfly.security.http.oidc;
 
 import static org.wildfly.security.http.oidc.ElytronMessages.log;
 import static org.wildfly.security.http.oidc.Oidc.OIDC_STATE_COOKIE;
+import static org.wildfly.security.http.oidc.Oidc.checkCachedAccountMatchesRequest;
 
 import java.net.URISyntaxException;
 import java.util.List;
@@ -72,8 +73,7 @@ public class OidcCookieTokenStore implements OidcTokenStore {
             return false;
         }
         OidcAccount account = new OidcAccount(principal);
-        if (deployment.getRealm() != null && ! deployment.getRealm().equals(account.getOidcSecurityContext().getRealm())) {
-            log.debug("Account in session belongs to a different realm than for this request.");
+        if (! checkCachedAccountMatchesRequest(account, deployment)) {
             return false;
         }
 
diff --git a/http/oidc/src/main/java/org/wildfly/security/http/oidc/OidcSessionTokenStore.java b/http/oidc/src/main/java/org/wildfly/security/http/oidc/OidcSessionTokenStore.java
index c2e6838f7a..cb6206177c 100644
--- a/http/oidc/src/main/java/org/wildfly/security/http/oidc/OidcSessionTokenStore.java
+++ b/http/oidc/src/main/java/org/wildfly/security/http/oidc/OidcSessionTokenStore.java
@@ -19,6 +19,7 @@
 package org.wildfly.security.http.oidc;
 
 import static org.wildfly.security.http.oidc.ElytronMessages.log;
+import static org.wildfly.security.http.oidc.Oidc.checkCachedAccountMatchesRequest;
 
 import java.util.ArrayList;
 import java.util.Collection;
@@ -88,9 +89,7 @@ public class OidcSessionTokenStore implements OidcTokenStore {
         }
 
         OidcClientConfiguration deployment = httpFacade.getOidcClientConfiguration();
-
-        if (deployment.getRealm() != null && ! deployment.getRealm().equals(account.getOidcSecurityContext().getRealm())) {
-            log.debug("Account in session belongs to a different realm than for this request.");
+        if (! checkCachedAccountMatchesRequest(account, deployment)) {
             return false;
         }
 
