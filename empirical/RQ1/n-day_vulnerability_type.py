import json

import pandas as pd


def analysis_same_repo():
    df = pd.read_excel("../dataset/groundtruth.xlsx")
    csv_data = df.to_dict(orient="records")
    transfer = set()
    origin_repo = set()
    for data in csv_data:
        if "TP" not in data["TP/FP"]:
            continue
        if str(data["detect_loc"]) == "nan":
            continue
        repo_o = (
            data["source_commit"]
            .split("/commit/")[0]
            .replace("https://github.com/", "")
            .replace("/", "@@")
        )
        repo_t = data["target_repo"]

        detect_loc = data["detect_loc"].split("\n")
        flag = False
        locs = set()
        for loc in detect_loc:
            if loc == "all":
                flag = True
                continue
            if "http" not in loc:
                continue
            origin = loc.split("#####")[-1]
            target = loc.split("#####")[-2]
            if origin == "VARIABLE" or origin == "MACRO":
                flag = True
                continue
            if target == "VARIABLE" or target == "MACRO":
                flag = True
                continue
            if origin.lower() in target.lower():
                flag = True
            else:
                if repo_o == repo_t:
                    locs.add((origin, target))
        if not flag:
            if repo_o == repo_t:
                origin_repo.add(
                    f"{data['CVE']}##{data['target_repo']}##{data['target_tag']}"
                )
            else:
                transfer.add(
                    f"{data['CVE']}##{data['target_repo']}##{data['target_tag']}"
                )
    print(len(transfer), len(origin_repo))
    fp = open("transfer_sharing_logic_generality.json", "w")
    json.dump(list(transfer), fp, indent=4)
    fp.close()

    fp = open("origin_sharing_logic_generality.json", "w")
    json.dump(list(origin_repo), fp, indent=4)
    fp.close()


if __name__ == "__main__":
    analysis_same_repo()
